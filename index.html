<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2iQ Lead Generation Intelligence System</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Premium color palette - avoiding generic gradients */
            --navy-deep: #0a1628;
            --navy-rich: #152238;
            --navy-light: #1e3a5f;
            --gold-accent: #d4a574;
            --gold-bright: #f0c674;
            --silver: #c5d1e0;
            --white: #ffffff;
            --red-flag: #e63946;
            --yellow-flag: #f4a261;
            --green-flag: #06d6a0;
            --blue-info: #457b9d;
            
            /* Typography */
            --font-display: 'Crimson Pro', serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--navy-deep) 0%, var(--navy-rich) 100%);
            color: var(--silver);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ============================================ */
        /* LOGIN SCREEN STYLES */
        /* ============================================ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--navy-deep) 0%, var(--navy-rich) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 165, 116, 0.3);
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .login-logo {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold-accent);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--silver);
            font-size: 0.95rem;
            margin-bottom: 2rem;
            opacity: 0.8;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 165, 116, 0.2);
            border-radius: 8px;
            color: var(--white);
            font-size: 1rem;
            font-family: var(--font-body);
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--gold-accent);
            background: rgba(255, 255, 255, 0.08);
        }

        .login-input::placeholder {
            color: var(--silver);
            opacity: 0.5;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--gold-accent), #c49660);
            border: none;
            border-radius: 8px;
            color: var(--navy-deep);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 165, 116, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            color: var(--red-flag);
            font-size: 0.9rem;
            margin-top: 1rem;
            display: none;
        }

        .login-error.visible {
            display: block;
        }

        .app-container {
            display: none;
        }

        .app-container.visible {
            display: block;
        }

        /* Header with distinctive style */
        .header {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(212, 165, 116, 0.2);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold-accent);
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .username-display {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--gold-bright);
            padding: 0.5rem 1rem;
            background: rgba(212, 165, 116, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(212, 165, 116, 0.3);
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid rgba(230, 57, 70, 0.5);
            color: var(--red-flag);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(230, 57, 70, 0.1);
            border-color: var(--red-flag);
        }

        .notification-badge {
            position: relative;
            cursor: pointer;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-badge:hover {
            background: rgba(212, 165, 116, 0.2);
            transform: translateY(-2px);
        }

        .notification-badge.has-alerts::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: var(--red-flag);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        /* Budget Tracker */
        .budget-tracker {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(197, 209, 224, 0.2);
        }

        .budget-bar {
            width: 120px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green-flag), var(--gold-accent));
            transition: width 0.5s ease, background 0.3s ease;
            border-radius: 3px;
        }

        .budget-fill.warning {
            background: linear-gradient(90deg, var(--yellow-flag), var(--red-flag));
        }

        .budget-text {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--gold-bright);
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 165, 116, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--gold-accent);
        }

        .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--silver);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold-accent);
            line-height: 1;
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--green-flag);
        }

        /* Controls Section */
        .controls {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 165, 116, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(197, 209, 224, 0.2);
            border-radius: 8px;
            color: var(--white);
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--gold-accent);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-icon {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--silver);
            opacity: 0.5;
        }

        select {
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(197, 209, 224, 0.2);
            border-radius: 8px;
            color: var(--white);
            font-family: var(--font-body);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--gold-accent);
        }

        select option {
            background: var(--navy-rich);
            color: var(--white);
        }

        .btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--gold-accent), var(--gold-bright));
            color: var(--navy-deep);
            border: none;
            border-radius: 8px;
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 165, 116, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .load-more-container {
            margin-top: 1rem;
            text-align: center;
        }
        
        .load-more-select {
            padding: 0.5rem 1rem;
            background: var(--navy-light);
            border: 1px solid rgba(212, 165, 116, 0.3);
            color: var(--silver);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            width: 100%;
        }
        
        .load-more-select:hover {
            border-color: var(--gold-accent);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e63946, #d62828);
            color: var(--white);
        }

        /* Kanban Board - 6 columns in a row */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        @media (max-width: 1600px) {
            .kanban-board {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1000px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .kanban-column {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(212, 165, 116, 0.15);
            border-radius: 12px;
            padding: 1rem;
            min-height: 350px;
            min-width: 200px;
        }

        .column-header {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--gold-accent);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-count {
            font-size: 1rem;
            color: var(--silver);
            background: rgba(255, 255, 255, 0.1);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-family: var(--font-mono);
        }

        /* Firm Cards */
        .firm-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(197, 209, 224, 0.2);
            border-radius: 10px;
            padding: 0.9rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .firm-card:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--gold-accent);
        }

        .firm-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .firm-card.locked::after {
            content: 'ðŸ”’';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.2rem;
        }

        .firm-name {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            color: var(--white);
            margin-bottom: 0.5rem;
            padding-right: 3.5rem; /* Space for fit score */
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
        }

        .firm-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .meta-item {
            font-size: 0.75rem;
            color: var(--silver);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .priority-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-high {
            background: rgba(6, 214, 160, 0.2);
            color: var(--green-flag);
            border: 1px solid var(--green-flag);
        }

        .priority-medium {
            background: rgba(244, 162, 97, 0.2);
            color: var(--yellow-flag);
            border: 1px solid var(--yellow-flag);
        }

        .priority-low {
            background: rgba(230, 57, 70, 0.2);
            color: var(--red-flag);
            border: 1px solid var(--red-flag);
        }

        .fit-score {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gold-bright);
            position: absolute;
            top: 0.6rem;
            right: 0.6rem;
            background: rgba(212, 165, 116, 0.2);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            white-space: nowrap;
        }

        .research-status {
            font-size: 0.75rem;
            color: var(--blue-info);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .firm-strategy {
            font-size: 0.75rem;
            color: var(--silver);
            margin-top: 0.3rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Filter count badges */
        select option {
            background: var(--navy-rich);
            color: var(--white);
            padding: 0.5rem;
        }

        .filter-active {
            border-color: var(--gold-accent) !important;
            background: rgba(212, 165, 116, 0.1) !important;
        }

        /* Stats card clickable improvement */
        .stat-card {
            cursor: pointer;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gold-accent);
            transition: width 0.3s ease;
        }

        .stat-card:hover::before {
            width: 100%;
        }

        /* Improved firm card layout */
        .firm-card {
            position: relative;
            overflow: hidden;
        }

        .firm-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--silver);
            opacity: 0.3;
            transition: background 0.3s ease, opacity 0.3s ease;
        }

        .firm-card:hover::before {
            background: var(--gold-accent);
            opacity: 1;
        }

        .firm-card.priority-high-card::before {
            background: var(--green-flag);
        }

        .firm-card.priority-medium-card::before {
            background: var(--yellow-flag);
        }

        .firm-card.priority-low-card::before {
            background: var(--red-flag);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        /* LLM Selection Grid */
        .llm-selection-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .llm-checkbox {
            display: block;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(197, 209, 224, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .llm-checkbox:hover:not(.disabled) {
            border-color: var(--llm-color, var(--gold-accent));
            background: rgba(255, 255, 255, 0.06);
        }

        .llm-checkbox.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .llm-checkbox input {
            display: none;
        }

        .llm-checkbox input:checked + .llm-checkbox-content {
            background: rgba(var(--llm-color), 0.1);
        }

        .llm-checkbox input:checked + .llm-checkbox-content::before {
            content: 'âœ“';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: var(--llm-color, var(--gold-accent));
            font-weight: bold;
        }

        .llm-checkbox-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            position: relative;
        }

        .llm-icon {
            font-size: 1.5rem;
        }

        .llm-name {
            font-weight: 600;
            color: var(--white);
        }

        .llm-status {
            font-size: 0.7rem;
            color: var(--silver);
            opacity: 0.7;
        }

        .llm-status.ready {
            color: var(--green-flag);
        }

        /* Research Mode Selection */
        .research-mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 0.75rem;
        }

        .mode-radio {
            display: block;
            cursor: pointer;
        }

        .mode-radio input {
            display: none;
        }

        .mode-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(197, 209, 224, 0.2);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .mode-radio input:checked + .mode-content {
            border-color: var(--gold-accent);
            background: rgba(212, 165, 116, 0.1);
        }

        .mode-icon {
            font-size: 1.5rem;
        }

        .mode-label {
            font-weight: 600;
            color: var(--white);
        }

        .mode-desc {
            font-size: 0.75rem;
            color: var(--silver);
            text-align: center;
        }

        /* Comparison Grid */
        .comparison-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .comparison-header h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--gold-accent);
            margin-bottom: 0.5rem;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .comparison-column {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(197, 209, 224, 0.15);
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-column-header {
            background: rgba(var(--llm-color), 0.1);
            border-bottom: 1px solid rgba(var(--llm-color), 0.3);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .llm-icon-large {
            font-size: 1.8rem;
        }

        .llm-name-large {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--white);
            flex: 1;
        }

        .comparison-status {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
        }

        .comparison-status.loading {
            background: rgba(69, 123, 157, 0.2);
            color: var(--blue-info);
        }

        .comparison-status.complete {
            background: rgba(6, 214, 160, 0.2);
            color: var(--green-flag);
        }

        .comparison-status.error {
            background: rgba(230, 57, 70, 0.2);
            color: var(--red-flag);
        }

        .comparison-content {
            padding: 1rem;
            min-height: 300px;
        }

        .comparison-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--silver);
        }

        .loading-pulse {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gold-accent);
            animation: pulse 1.5s infinite;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .comparison-fit-score {
            text-align: center;
            padding: 1rem;
            background: rgba(212, 165, 116, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .fit-label {
            display: block;
            font-size: 0.75rem;
            color: var(--silver);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .fit-value {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold-accent);
        }

        .comparison-section {
            margin-bottom: 1rem;
        }

        .comparison-section h4 {
            font-size: 0.8rem;
            color: var(--silver);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(197, 209, 224, 0.1);
        }

        .mini-contact {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.3rem;
            font-size: 0.8rem;
        }

        .mini-contact strong {
            display: block;
            color: var(--white);
        }

        .mini-contact span {
            color: var(--silver);
            font-size: 0.75rem;
        }

        .mini-contact .confidence {
            float: right;
            color: var(--gold-accent);
        }

        .mini-flags {
            display: flex;
            gap: 0.5rem;
        }

        .mini-flags .flag {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .mini-flags .flag.green { background: rgba(6, 214, 160, 0.2); color: var(--green-flag); }
        .mini-flags .flag.yellow { background: rgba(244, 162, 97, 0.2); color: var(--yellow-flag); }
        .mini-flags .flag.red { background: rgba(230, 57, 70, 0.2); color: var(--red-flag); }

        .mini-reasoning {
            font-size: 0.8rem;
            color: var(--silver);
            line-height: 1.4;
        }

        .comparison-cost {
            text-align: right;
            font-size: 0.75rem;
            color: var(--silver);
            font-family: var(--font-mono);
            padding-top: 0.5rem;
            border-top: 1px solid rgba(197, 209, 224, 0.1);
        }

        .comparison-error {
            text-align: center;
            padding: 2rem;
            color: var(--red-flag);
        }

        .comparison-actions {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(212, 165, 116, 0.2);
            text-align: center;
        }

        .comparison-actions h4 {
            color: var(--silver);
            margin-bottom: 1rem;
        }

        .winner-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }

        .btn-winner {
            background: rgba(var(--llm-color), 0.2);
            border: 2px solid var(--llm-color, var(--gold-accent));
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-winner:hover {
            background: rgba(var(--llm-color), 0.4);
            transform: translateY(-2px);
        }

        .no-data {
            color: var(--silver);
            font-style: italic;
            font-size: 0.85rem;
        }

        .winner-badge {
            background: linear-gradient(135deg, var(--gold-accent), var(--gold-bright));
            color: var(--navy-deep);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .comparison-column.winner {
            border-color: var(--gold-accent);
            box-shadow: 0 0 20px rgba(212, 165, 116, 0.2);
        }

        /* Detailed Comparison Styles */
        .comparison-flags-detailed {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .flag-box-mini {
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid;
        }

        .flag-box-mini.green {
            background: rgba(6, 214, 160, 0.1);
            border-color: var(--green-flag);
        }

        .flag-box-mini.yellow {
            background: rgba(244, 162, 97, 0.1);
            border-color: var(--yellow-flag);
        }

        .flag-box-mini.red {
            background: rgba(230, 57, 70, 0.1);
            border-color: var(--red-flag);
        }

        .flag-title-mini {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .flag-list-mini {
            margin: 0;
            padding-left: 1.2rem;
            font-size: 0.75rem;
            color: var(--silver);
        }

        .flag-list-mini li {
            margin-bottom: 0.2rem;
            line-height: 1.4;
        }

        .full-reasoning {
            font-size: 0.85rem;
            color: var(--silver);
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.03);
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--gold-accent);
        }

        .contact-card-mini {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(197, 209, 224, 0.1);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .contact-header-mini {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .contact-info-mini strong {
            display: block;
            color: var(--white);
            font-size: 0.9rem;
        }

        .contact-title-mini {
            font-size: 0.75rem;
            color: var(--gold-accent);
        }

        .confidence-mini {
            background: linear-gradient(135deg, var(--gold-accent), var(--gold-bright));
            color: var(--navy-deep);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .contact-details-mini {
            font-size: 0.75rem;
            color: var(--silver);
            margin-bottom: 0.5rem;
        }

        .contact-details-mini div {
            margin-bottom: 0.2rem;
        }

        .email-conf {
            opacity: 0.7;
            font-size: 0.7rem;
        }

        .contact-reasoning-mini {
            background: rgba(212, 165, 116, 0.1);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .contact-reasoning-mini strong {
            color: var(--gold-accent);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .contact-reasoning-mini p {
            margin: 0.3rem 0 0 0;
            color: var(--silver);
            line-height: 1.4;
        }

        .comparison-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--silver);
            font-family: var(--font-mono);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            border-top: 1px solid rgba(197, 209, 224, 0.1);
        }

        .comparison-content {
            padding: 1rem;
            max-height: 600px;
            overflow-y: auto;
        }

        /* Client Card Styling */
        .client-card {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.15), rgba(240, 198, 116, 0.05)) !important;
            border: 1px solid rgba(212, 165, 116, 0.4) !important;
        }

        .client-column {
            border: 2px solid rgba(212, 165, 116, 0.3);
        }

        .subscription-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .subscription-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            background: rgba(212, 165, 116, 0.2);
            border: 1px solid rgba(212, 165, 116, 0.4);
            border-radius: 4px;
            color: var(--gold-bright);
        }

        .upsell-indicator {
            font-size: 0.7rem;
            color: var(--green-flag);
            margin-top: 0.3rem;
        }

        /* Discover Leads Modal */
        .discover-sources {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .source-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .source-icon {
            font-size: 1.2rem;
        }

        .discovered-lead {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid rgba(6, 214, 160, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .discovered-lead.already-exists {
            background: rgba(6, 214, 160, 0.1);
            border-color: rgba(6, 214, 160, 0.4);
            animation: addedPulse 0.5s ease;
        }
        
        @keyframes addedPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(6, 214, 160, 0.4); }
            50% { transform: scale(1.01); box-shadow: 0 0 20px 5px rgba(6, 214, 160, 0.3); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(6, 214, 160, 0); }
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .lead-name {
            font-weight: 600;
            color: var(--white);
            font-size: 1rem;
        }

        .lead-meta {
            font-size: 0.8rem;
            color: var(--silver);
        }

        .lead-signals {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin: 0.5rem 0;
        }

        .signal-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: rgba(69, 123, 157, 0.2);
            border-radius: 4px;
            color: var(--blue-info);
        }

        .signal-tag.positive {
            background: rgba(6, 214, 160, 0.2);
            color: var(--green-flag);
        }

        .lead-reasoning {
            font-size: 0.8rem;
            color: var(--silver);
            line-height: 1.5;
            margin-top: 0.5rem;
        }

        .already-in-list {
            display: inline-block;
            background: var(--green-flag);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            animation: badgeFadeIn 0.3s ease;
        }
        
        @keyframes badgeFadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--navy-rich), var(--navy-deep));
            border: 1px solid rgba(212, 165, 116, 0.3);
            border-radius: 16px;
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(212, 165, 116, 0.2);
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold-accent);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--silver);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: var(--gold-accent);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gold-bright);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(197, 209, 224, 0.2);
            border-radius: 8px;
            color: var(--white);
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold-accent);
            background: rgba(255, 255, 255, 0.08);
        }

        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }

        /* Research Approval UI */
        .research-preview {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 165, 116, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .preview-section {
            margin-bottom: 1.5rem;
        }

        .preview-section:last-child {
            margin-bottom: 0;
        }

        .preview-heading {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gold-accent);
            margin-bottom: 0.8rem;
        }

        .preview-list {
            list-style: none;
            padding-left: 0;
        }

        .preview-list li {
            padding: 0.5rem 0;
            color: var(--silver);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-list li::before {
            content: 'â†’';
            color: var(--gold-accent);
            font-weight: bold;
        }

        .cost-estimate {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid var(--green-flag);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cost-label {
            font-size: 0.9rem;
            color: var(--silver);
        }

        .cost-amount {
            font-family: var(--font-mono);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--green-flag);
        }

        /* Research Results */
        .research-results {
            margin-top: 1.5rem;
        }

        .contact-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(197, 209, 224, 0.2);
            border-radius: 10px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .contact-card:hover {
            border-color: var(--gold-accent);
            background: rgba(255, 255, 255, 0.08);
        }

        .contact-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .contact-name {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--white);
        }

        .contact-title {
            font-size: 0.9rem;
            color: var(--gold-bright);
            margin-top: 0.2rem;
        }

        .confidence-score {
            text-align: right;
            position: relative;
            cursor: help;
        }

        .confidence-score:hover .confidence-tooltip {
            display: block;
        }

        .confidence-tooltip {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 320px;
            background: var(--navy-deep);
            border: 1px solid rgba(212, 165, 116, 0.3);
            border-radius: 8px;
            padding: 1rem;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 0.5rem;
        }

        .confidence-tooltip h4 {
            color: var(--gold-accent);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .confidence-tooltip table {
            width: 100%;
            font-size: 0.75rem;
        }

        .confidence-tooltip td {
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(197, 209, 224, 0.1);
        }

        .confidence-tooltip td:first-child {
            color: var(--gold-bright);
            font-family: var(--font-mono);
            width: 60px;
        }

        .confidence-tooltip td:last-child {
            color: var(--silver);
        }

        .confidence-label {
            font-size: 0.7rem;
            color: var(--silver);
            text-transform: uppercase;
        }

        .confidence-value {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--green-flag);
        }

        .contact-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--silver);
        }

        .reasoning-box {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid var(--gold-accent);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .reasoning-heading {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gold-bright);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .reasoning-text {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--silver);
        }

        /* Flags */
        .flags-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .flag-box {
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid;
        }

        .flag-box.green {
            background: rgba(6, 214, 160, 0.1);
            border-color: var(--green-flag);
        }

        .flag-box.yellow {
            background: rgba(244, 162, 97, 0.1);
            border-color: var(--yellow-flag);
        }

        .flag-box.red {
            background: rgba(230, 57, 70, 0.1);
            border-color: var(--red-flag);
        }

        .flag-title {
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .flag-box.green .flag-title {
            color: var(--green-flag);
        }

        .flag-box.yellow .flag-title {
            color: var(--yellow-flag);
        }

        .flag-box.red .flag-title {
            color: var(--red-flag);
        }

        .flag-list {
            list-style: none;
            padding: 0;
        }

        .flag-list li {
            font-size: 0.8rem;
            padding: 0.3rem 0;
            color: var(--silver);
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: linear-gradient(135deg, var(--navy-rich), var(--navy-deep));
            border-left: 1px solid rgba(212, 165, 116, 0.3);
            padding: 2rem;
            overflow-y: auto;
            transition: right 0.4s ease;
            z-index: 999;
        }

        .notifications-panel.open {
            right: 0;
        }

        .notification-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(197, 209, 224, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .notification-item.priority {
            border-color: var(--gold-accent);
            background: rgba(212, 165, 116, 0.1);
        }

        .notification-title {
            font-weight: 600;
            color: var(--gold-bright);
            margin-bottom: 0.5rem;
        }

        .notification-text {
            font-size: 0.85rem;
            color: var(--silver);
            line-height: 1.5;
        }

        .notification-time {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--silver);
            opacity: 0.6;
            margin-top: 0.5rem;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 165, 116, 0.3);
            border-top-color: var(--gold-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, var(--navy-deep), var(--navy-rich));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 165, 116, 0.3);
            border-radius: 16px;
            padding: 3rem;
            max-width: 450px;
            width: 100%;
            text-align: center;
        }

        .login-logo {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold-accent);
            margin-bottom: 1rem;
        }

        .login-subtitle {
            font-size: 1rem;
            color: var(--silver);
            margin-bottom: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .kanban-board {
                grid-template-columns: 1fr;
            }

            .notifications-panel {
                width: 100%;
                right: -100%;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">2iQ Intelligence</div>
            <div class="login-subtitle">Lead Generation System</div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="login-input" placeholder="Username" required autocomplete="username" />
                <input type="password" id="loginPassword" class="login-input" placeholder="Password" required autocomplete="current-password" />
                <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
            </form>
            <div id="loginError" class="login-error"></div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">2iQ Lead Intelligence <span id="versionBadge" style="font-size: 0.6rem; background: rgba(212,165,116,0.2); padding: 0.2rem 0.4rem; border-radius: 4px; margin-left: 0.5rem; color: var(--gold-accent);">v6.6</span></div>
            <div class="header-actions">
                <div class="budget-tracker">
                    <div class="budget-bar">
                        <div class="budget-fill" id="budgetFill" style="width: 0%"></div>
                    </div>
                    <div class="budget-text" id="budgetText">$0 / $200</div>
                </div>
                <div class="notification-badge" onclick="openCalendarView()" style="cursor: pointer;" title="Follow-up Calendar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="notification-badge" id="notificationBadge" onclick="toggleNotifications()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                </div>
                <div class="notification-badge" onclick="openSettings()" style="cursor: pointer;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6"></path>
                        <path d="M21 12h-6m-6 0H3"></path>
                        <path d="M18.36 5.64l-4.24 4.24m0 0L9.88 5.64M14.12 14.12l4.24 4.24m-8.48 0l4.24-4.24"></path>
                    </svg>
                </div>
                <div class="username-display" id="usernameDisplay"></div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- Container -->
        <div class="container">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card" onclick="filterByStatus('all')">
                    <div class="stat-label">Total Firms</div>
                    <div class="stat-value" id="statTotal">0</div>
                </div>
                <div class="stat-card client-card" onclick="filterByStatus('Client')">
                    <div class="stat-label">ðŸ† Clients</div>
                    <div class="stat-value" id="statClients">0</div>
                    <div class="stat-change">Upsell Opportunities</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('Not Contacted')">
                    <div class="stat-label">Not Contacted</div>
                    <div class="stat-value" id="statNotContacted">0</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('Trial Ongoing')" style="border-color: rgba(69, 123, 157, 0.5);">
                    <div class="stat-label">â³ Trial Ongoing</div>
                    <div class="stat-value" id="statTrialOngoing">0</div>
                    <div class="stat-change">Active Trials</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">High Priority</div>
                    <div class="stat-value" id="statHighPriority">0</div>
                    <div class="stat-change">ðŸŸ¢ Ready to Contact</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="search-box">
                    <span class="search-icon">ðŸ”</span>
                    <input type="text" id="searchInput" placeholder="Search firms, locations, contacts..." oninput="filterFirms()" />
                </div>
                <select id="filterLocation" onchange="filterFirms()">
                    <option value="">All Locations</option>
                </select>
                <select id="filterStrategy" onchange="filterFirms()">
                    <option value="">All Strategies</option>
                </select>
                <select id="filterPriority" onchange="filterFirms()">
                    <option value="">All Priorities</option>
                    <option value="high">ðŸŸ¢ High Priority</option>
                    <option value="medium">ðŸŸ¡ Medium Priority</option>
                    <option value="low">âšª Low Priority</option>
                </select>
                <select id="filterAssignedTo" onchange="filterFirms()" style="border-color: rgba(126, 87, 194, 0.5);">
                    <option value="">ðŸ‘¥ All Users</option>
                    <option value="mine">â­ My Firms Only</option>
                    <option value="unassigned">â“ Unassigned</option>
                    <option value="zabih">ðŸŸ¢ Zabih</option>
                    <option value="noor">ðŸ”µ Noor</option>
                    <option value="huzaifa">ðŸŸ  Huzaifa</option>
                </select>
                <button class="btn btn-secondary" onclick="resetFilters()" title="Reset all filters and collapse columns">ðŸ”„ Reset</button>
                <button class="btn btn-secondary" onclick="recalculatePriorities()" title="Recalculate priorities based on data">ðŸ·ï¸ Fix Priorities</button>
                <select id="filterDateAdded" onchange="filterFirms()">
                    <option value="">All Time</option>
                    <option value="today">ðŸ“… Added Today</option>
                    <option value="yesterday">ðŸ“… Yesterday</option>
                    <option value="week">ðŸ“… This Week</option>
                    <option value="month">ðŸ“… This Month</option>
                    <option value="custom">ðŸ“… Custom Date...</option>
                </select>
                <button class="btn" onclick="openAddFirmModal()">+ Add Firm</button>
                <button class="btn btn-ai" onclick="importAll167Firms()">ðŸ“Š Import Firms</button>
                <button class="btn btn-secondary" onclick="discoverLeads()">ðŸ” Discover Leads</button>
                <button class="btn btn-secondary" onclick="manualSyncToSheets()" title="Push all local changes to Google Sheets">â˜ï¸ Push to Sheets</button>
                <button class="btn btn-secondary" onclick="refreshFromSheets()" title="Pull latest data from Google Sheets (overwrites local changes)">ðŸ”„ Refresh</button>
                <button class="btn btn-secondary" onclick="fullSyncWithDeletion()" title="Admin: Full sync that removes deleted items from Google Sheets" style="background: rgba(230,57,70,0.2); border-color: var(--red-flag);">ðŸ—‘ï¸ Full Sync</button>
            </div>
            
            <!-- Custom Date Range Picker (hidden by default) -->
            <div id="customDatePicker" style="display: none; padding: 0.75rem; background: var(--navy-card); border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <label style="color: var(--silver); font-size: 0.85rem;">
                        From: <input type="date" id="dateFrom" onchange="applyCustomDateFilter()" style="margin-left: 0.5rem; padding: 0.4rem; border-radius: 4px; border: 1px solid var(--gold-accent); background: var(--navy-deep); color: var(--white);">
                    </label>
                    <label style="color: var(--silver); font-size: 0.85rem;">
                        To: <input type="date" id="dateTo" onchange="applyCustomDateFilter()" style="margin-left: 0.5rem; padding: 0.4rem; border-radius: 4px; border: 1px solid var(--gold-accent); background: var(--navy-deep); color: var(--white);">
                    </label>
                    <button class="btn btn-secondary" onclick="clearDateFilter()" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">Clear</button>
                </div>
            </div>

            <!-- Kanban Board -->
            <div class="kanban-board" id="kanbanBoard">
                <div class="kanban-column">
                    <div class="column-header">
                        <span>Not Contacted</span>
                        <span class="column-count" id="countNotContacted">0</span>
                    </div>
                    <div id="columnNotContacted"></div>
                    <div class="load-more-container" id="loadMoreNotContacted" style="display: none;"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        <span>Contacted</span>
                        <span class="column-count" id="countContacted">0</span>
                    </div>
                    <div id="columnContacted"></div>
                    <div class="load-more-container" id="loadMoreContacted" style="display: none;"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header" style="background: linear-gradient(135deg, rgba(69, 123, 157, 0.2), rgba(69, 123, 157, 0.1));">
                        <span>â³ Trial Ongoing</span>
                        <span class="column-count" id="countTrialOngoing">0</span>
                    </div>
                    <div id="columnTrialOngoing"></div>
                    <div class="load-more-container" id="loadMoreTrialOngoing" style="display: none;"></div>
                </div>
                <div class="kanban-column client-column">
                    <div class="column-header" style="background: linear-gradient(135deg, rgba(212, 165, 116, 0.2), rgba(240, 198, 116, 0.1));">
                        <span>ðŸ† Client</span>
                        <span class="column-count" id="countClient">0</span>
                    </div>
                    <div id="columnClient"></div>
                    <div class="load-more-container" id="loadMoreClient" style="display: none;"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header">
                        <span>Closed</span>
                        <span class="column-count" id="countClosed">0</span>
                    </div>
                    <div id="columnClosed"></div>
                    <div class="load-more-container" id="loadMoreClosed" style="display: none;"></div>
                </div>
                <div class="kanban-column">
                    <div class="column-header" style="background: linear-gradient(135deg, rgba(230, 57, 70, 0.2), rgba(230, 57, 70, 0.1));">
                        <span>âŒ Not a Good Fit</span>
                        <span class="column-count" id="countNotGoodFit">0</span>
                    </div>
                    <div id="columnNotGoodFit"></div>
                    <div class="load-more-container" id="loadMoreNotGoodFit" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="notifications-panel" id="notificationsPanel">
            <div class="modal-header">
                <div class="modal-title">Notifications</div>
                <button class="close-btn" onclick="toggleNotifications()">Ã—</button>
            </div>
            <div id="notificationsList"></div>
        </div>

        <!-- Modals -->
        <div id="addFirmModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Add New Firm</div>
                    <button class="close-btn" onclick="closeModal('addFirmModal')">Ã—</button>
                </div>
                <form onsubmit="addFirm(event)">
                    <div class="form-group">
                        <label class="form-label">Firm Name *</label>
                        <input type="text" id="firmName" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location *</label>
                        <input type="text" id="firmLocation" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">AUM (Billion USD)</label>
                        <input type="number" step="0.1" id="firmAUM" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" id="firmWebsite" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">LinkedIn</label>
                        <input type="url" id="firmLinkedIn" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Investment Strategy</label>
                        <select id="firmStrategy" class="form-input">
                            <option value="">Select strategy</option>
                            <option value="Quant">Quantitative</option>
                            <option value="Fundamental">Fundamental</option>
                            <option value="Event-Driven">Event-Driven</option>
                            <option value="Multi-Strategy">Multi-Strategy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="firmNotes" class="form-input"></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn" style="flex: 1;">Add Firm</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addFirmModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Research Approval Modal -->
        <div id="researchModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Research Approval</div>
                    <button class="close-btn" onclick="closeModal('researchModal')">Ã—</button>
                </div>
                <div id="researchPreview"></div>
            </div>
        </div>

        <!-- Firm Details Modal -->
        <div id="firmDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="firmDetailsTitle"></div>
                    <button class="close-btn" onclick="closeModal('firmDetailsModal')">Ã—</button>
                </div>
                <div id="firmDetailsContent"></div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">âš™ï¸ API Configuration</div>
                    <button class="close-btn" onclick="closeModal('settingsModal')">Ã—</button>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--silver); font-size: 0.9rem; line-height: 1.6;">
                        Configure your AI API keys for multi-LLM research. You can use multiple models and compare results side-by-side.
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">ðŸŸ£ Claude API Key</label>
                        <input type="password" id="claudeApiKey" class="form-input" placeholder="sk-ant-api03-..." />
                        <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                            <a href="https://console.anthropic.com/" target="_blank" style="color: var(--gold-accent);">console.anthropic.com</a>
                            <br><span style="color: var(--yellow-flag);">âš ï¸ Requires proxy server on port 8001</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ðŸŸ¢ OpenAI GPT Key</label>
                        <input type="password" id="openaiApiKey" class="form-input" placeholder="sk-..." />
                        <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                            <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--gold-accent);">platform.openai.com</a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ðŸ”µ DeepSeek API Key</label>
                        <input type="password" id="deepseekApiKey" class="form-input" placeholder="sk-..." />
                        <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                            <a href="https://platform.deepseek.com/" target="_blank" style="color: var(--gold-accent);">platform.deepseek.com</a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ðŸŸ¡ Google Gemini Key</label>
                        <input type="password" id="geminiApiKey" class="form-input" placeholder="AIza..." />
                        <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                            <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--gold-accent);">aistudio.google.com</a>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">ðŸ’µ Monthly Budget Limit (USD)</label>
                    <input type="number" id="budgetLimit" class="form-input" value="200" min="10" step="10" />
                </div>
                
                <!-- Search API Section -->
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(212, 165, 116, 0.2);">
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--gold-accent); font-size: 0.95rem; margin-bottom: 0.5rem;">ðŸ” Search API (for Lead Discovery)</h4>
                        <p style="color: var(--silver); font-size: 0.8rem; line-height: 1.5;">
                            Add a search API to enable web searching for <strong>ALL</strong> LLM models. Without this, only Claude has web search.
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">ðŸ”Ž Tavily API Key <span style="color: var(--green-flag);">(Recommended)</span></label>
                            <input type="password" id="tavilyApiKey" class="form-input" placeholder="tvly-..." />
                            <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                                <a href="https://tavily.com/" target="_blank" style="color: var(--gold-accent);">tavily.com</a> - Free tier: 1000 searches/month
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ðŸ”Ž Serper API Key <span style="color: var(--silver);">(Alternative)</span></label>
                            <input type="password" id="serperApiKey" class="form-input" placeholder="..." />
                            <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                                <a href="https://serper.dev/" target="_blank" style="color: var(--gold-accent);">serper.dev</a> - Free: 2500 searches
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contact Enrichment Section -->
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(212, 165, 116, 0.2);">
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--gold-accent); font-size: 0.95rem; margin-bottom: 0.5rem;">ðŸ‘¤ Contact Enrichment (Optional)</h4>
                        <p style="color: var(--silver); font-size: 0.8rem;">
                            Add to find verified email addresses for discovered leads.
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">ðŸ“§ Hunter.io API Key</label>
                            <input type="password" id="hunterApiKey" class="form-input" placeholder="..." />
                            <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                                <a href="https://hunter.io/" target="_blank" style="color: var(--gold-accent);">hunter.io</a> - Free: 25 searches/month
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ðŸš€ Apollo.io API Key</label>
                            <input type="password" id="apolloApiKey" class="form-input" placeholder="..." />
                            <div style="font-size: 0.7rem; color: var(--silver); margin-top: 0.3rem;">
                                <a href="https://www.apollo.io/" target="_blank" style="color: var(--gold-accent);">apollo.io</a> - Free tier available
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="saveApiConfig()" style="flex: 1;">ðŸ’¾ Save Configuration</button>
                    <button class="btn btn-secondary" onclick="testAllConnections()">ðŸ”Œ Test All</button>
                </div>
                <div id="apiTestResult" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                
                <!-- Admin Utilities Section -->
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(212, 165, 116, 0.2);">
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--gold-accent); font-size: 0.95rem; margin-bottom: 0.5rem;">ðŸ”§ Admin Utilities</h4>
                        <p style="color: var(--silver); font-size: 0.8rem; line-height: 1.5;">
                            Maintenance tools for managing firm data.
                        </p>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="backfillFirmDates()" title="Add dates to firms that don't have addedDate set">
                            ðŸ“… Backfill Missing Dates
                        </button>
                        <button class="btn btn-secondary" onclick="normalizeFirmData()" title="Fix priority casing, locations, etc.">
                            ðŸ”„ Normalize Data
                        </button>
                        <button class="btn btn-secondary" onclick="exportFirmsToJson()" title="Download all firm data as JSON">
                            ðŸ“¥ Export JSON
                        </button>
                    </div>
                    <div id="adminUtilityResult" style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--silver);"></div>
                </div>
            </div>
        </div>
        
        <!-- LLM Comparison Modal -->
        <div id="llmComparisonModal" class="modal">
            <div class="modal-content" style="max-width: 95vw; width: 1400px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <div class="modal-title">ðŸ¤– AI Research Comparison</div>
                    <button class="close-btn" onclick="closeModal('llmComparisonModal')">Ã—</button>
                </div>
                <div id="llmComparisonContent"></div>
            </div>
        </div>
        
        <!-- Discover Leads Modal -->
        <div id="discoverLeadsModal" class="modal">
            <div class="modal-content" style="max-width: 950px;">
                <div class="modal-header">
                    <div class="modal-title">ðŸŽ¯ AI Lead Discovery</div>
                    <button class="close-btn" onclick="closeModal('discoverLeadsModal')">Ã—</button>
                </div>
                <div id="discoverLeadsContent">
                    <p style="color: var(--silver); margin-bottom: 1rem;">
                        AI-powered search for firms with <strong style="color: var(--gold-accent);">active buying signals</strong> for alternative data products.
                    </p>
                    
                    <!-- Search API Status Banner -->
                    <div id="searchApiStatus" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 6px;"></div>
                    
                    <!-- Search Configuration -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">ðŸŒ Target Region</label>
                            <select id="discoveryRegion" class="form-input" style="padding: 0.6rem;">
                                <option value="global">ðŸŒ Global (All Regions)</option>
                                <option value="americas">ðŸ‡ºðŸ‡¸ Americas (US, Canada, LatAm)</option>
                                <option value="europe">ðŸ‡ªðŸ‡º Europe (UK, EU, Switzerland)</option>
                                <option value="asia">ðŸŒ Asia Pacific (SG, HK, Japan, AU)</option>
                                <option value="emerging">ðŸŒ Emerging (Middle East, Africa)</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">ðŸŽ¯ Strategy Focus</label>
                            <select id="discoveryStrategy" class="form-input" style="padding: 0.6rem;">
                                <option value="all">ðŸ“Š All Strategies</option>
                                <option value="quant">ðŸ¤– Quantitative / Systematic</option>
                                <option value="event">âš¡ Event-Driven / Special Sits</option>
                                <option value="macro">ðŸŒ Global Macro</option>
                                <option value="multi">ðŸ¢ Multi-Strategy</option>
                                <option value="family">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Offices</option>
                                <option value="equity">ðŸ“ˆ Long/Short Equity</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">ðŸ“Š Max Results</label>
                            <select id="discoveryMaxResults" class="form-input" style="padding: 0.6rem;" onchange="updateDiscoveryCostEstimate()">
                                <option value="25">25 results (5Ã—5)</option>
                                <option value="50">50 results (5Ã—10)</option>
                                <option value="80" selected>80 results (8Ã—10)</option>
                                <option value="100">100 results (10Ã—10)</option>
                                <option value="150">150 results (10Ã—15)</option>
                                <option value="200">200 results (10Ã—20)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="preview-section" style="margin: 0;">
                            <div class="preview-heading">ðŸ”¥ Buying Signals We Search</div>
                            <ul class="preview-list" style="font-size: 0.85rem;">
                                <li>ðŸ’¼ Hiring "Alternative Data Analyst"</li>
                                <li>ðŸ¢ Using competitor data vendors</li>
                                <li>ðŸŽ¤ Speaking at quant conferences</li>
                                <li>ðŸ“° "Launches quantitative strategy"</li>
                                <li>ðŸ‘¤ New Chief Data Officer hires</li>
                                <li>ðŸ’° Recent funding / AUM growth</li>
                                <li>ðŸš€ New fund launches</li>
                                <li>ðŸ”„ Strategy expansion news</li>
                            </ul>
                        </div>
                        
                        <div class="preview-section" style="margin: 0;">
                            <div class="preview-heading">ðŸŽ¯ Firm Types We Target</div>
                            <ul class="preview-list" style="font-size: 0.85rem;">
                                <li>ðŸ“Š Quantitative Hedge Funds</li>
                                <li>âš¡ Event-Driven Funds</li>
                                <li>ðŸ¢ Multi-Strategy Platforms</li>
                                <li>ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Offices ($1B+)</li>
                                <li>ðŸ¦ Asset Managers with Quant Teams</li>
                                <li>ðŸ“ˆ Systematic Trading Firms</li>
                                <li>ðŸŒ Global Macro Funds</li>
                                <li>ðŸ’¼ Sovereign Wealth Funds</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <div class="preview-heading">Select AI Model</div>
                        <div id="discoverLLMSelect" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;"></div>
                        <div id="llmRecommendation" style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(69, 123, 157, 0.15); border-radius: 6px; border-left: 3px solid var(--blue-info);"></div>
                    </div>
                    
                    <div class="cost-estimate">
                        <div class="cost-label">Estimated Cost</div>
                        <div id="discoveryCostEstimate" class="cost-amount">~$0.05-0.10</div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn" onclick="executeDiscoverLeads()" style="flex: 1;">
                            ðŸš€ Start Discovery
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('discoverLeadsModal')">
                            Cancel
                        </button>
                    </div>
                </div>
                <div id="discoverLeadsResults" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Client Subscriptions Modal -->
        <div id="clientSubscriptionsModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">ðŸ† Client Subscriptions</div>
                    <button class="close-btn" onclick="closeModal('clientSubscriptionsModal')">Ã—</button>
                </div>
                <div id="clientSubscriptionsContent"></div>
            </div>
        </div>
        
        <!-- Email Generation Modal -->
        <div id="emailGenerationModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <div class="modal-title">âœ‰ï¸ Outreach Email</div>
                    <button class="close-btn" onclick="closeModal('emailGenerationModal')">Ã—</button>
                </div>
                <div id="emailGenerationContent">
                    <div class="loading"></div>
                    <p style="color: var(--silver); text-align: center;">Generating personalized email...</p>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Contact History Modal -->
        <div id="contactHistoryModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title" id="contactHistoryModalTitle">ðŸ“ž Add Contact</div>
                    <button class="close-btn" onclick="closeModal('contactHistoryModal')">Ã—</button>
                </div>
                <div id="contactHistoryModalContent" style="padding: 1.5rem;">
                    <form id="contactHistoryForm" onsubmit="saveContactHistoryEntry(event)">
                        <input type="hidden" id="contactHistoryFirmId">
                        <input type="hidden" id="contactHistoryEditIndex" value="-1">
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Contact Method *</label>
                            <select id="contactHistoryMethod" required style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                                <option value="Email">ðŸ“§ Email</option>
                                <option value="Phone">ðŸ“ž Phone</option>
                                <option value="LinkedIn">ðŸ’¼ LinkedIn</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Contact Person (optional)</label>
                            <input type="text" id="contactHistoryPerson" placeholder="e.g., John Smith" 
                                style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Date *</label>
                                <input type="date" id="contactHistoryDate" required 
                                    style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Time</label>
                                <input type="time" id="contactHistoryTime" 
                                    style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Notes (optional)</label>
                            <textarea id="contactHistoryNotes" rows="3" placeholder="What was discussed? Any follow-up actions?"
                                style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn" style="flex: 1;">ðŸ’¾ Save</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('contactHistoryModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Add New Contact Modal (with Apollo Research) -->
        <div id="addContactModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">âž• Add Contact</div>
                    <button class="close-btn" onclick="closeModal('addContactModal')">Ã—</button>
                </div>
                <div id="addContactModalContent" style="padding: 1.5rem;">
                    <!-- Content populated by openAddContactModal() -->
                </div>
            </div>
        </div>
        
        <!-- Edit Contact Modal -->
        <div id="editContactModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">âœï¸ Edit Contact</div>
                    <button class="close-btn" onclick="closeModal('editContactModal')">Ã—</button>
                </div>
                <div id="editContactModalContent" style="padding: 1.5rem;">
                    <!-- Content populated by openEditContactModal() -->
                </div>
            </div>
        </div>
        
        <!-- Calendar/Schedule Modal -->
        <div id="calendarModal" class="modal">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                <div class="modal-header">
                    <div class="modal-title">ðŸ“… Follow-up Calendar & Schedule</div>
                    <button class="close-btn" onclick="closeModal('calendarModal')">Ã—</button>
                </div>
                <div id="calendarModalContent" style="padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 100px);">
                    <!-- Content populated by openCalendarView() -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GOOGLE SHEETS API CONFIGURATION
        // ============================================
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytKxFbLy8fpB7eTjWVg0GWS2bYOElZuLlfRp7nHkWDNMcO2sqUqsIExn3MAAEHntcT/exec';
        
        // Session management
        let currentSession = {
            user: null,
            token: null,
            expiry: null
        };
        
        // App version - update this when deploying new code
        const APP_VERSION = '6.6';
        console.log(`ðŸš€ 2iQ Lead Intelligence v${APP_VERSION} loaded`);
        
        // Global state
        let currentUser = '';
        let firms = [];
        let notifications = [];
        let budgetUsed = 0;
        let BUDGET_LIMIT = 200;
        let lockedRecords = {};

        // API Configuration
        let API_KEYS = {
            claude: '',
            openai: '',
            deepseek: '',
            gemini: ''
        };
        
        // LLM Configuration
        const LLM_CONFIG = {
            claude: {
                name: 'Claude',
                icon: 'ðŸŸ£',
                model: 'claude-sonnet-4-20250514',
                color: '#9b59b6',
                costPer1kInput: 0.003,
                costPer1kOutput: 0.015
            },
            openai: {
                name: 'GPT-4o',
                icon: 'ðŸŸ¢',
                model: 'gpt-4o',
                color: '#10a37f',
                costPer1kInput: 0.005,
                costPer1kOutput: 0.015
            },
            deepseek: {
                name: 'DeepSeek',
                icon: 'ðŸ”µ',
                model: 'deepseek-chat',
                color: '#4a90d9',
                costPer1kInput: 0.00014,
                costPer1kOutput: 0.00028
            },
            gemini: {
                name: 'Gemini',
                icon: 'ðŸŸ¡',
                model: 'gemini-2.0-flash-exp',
                color: '#fbbc04',
                costPer1kInput: 0.0,
                costPer1kOutput: 0.0
            }
        };
        
        // 2iQ Data Products Configuration
        const IQ_PRODUCTS = {
            insider_feed: { name: 'Insider Data Feed', price: 80000, icon: 'ðŸ“Š' },
            insider_model: { name: 'Insider Model', price: 15000, icon: 'ðŸ§®' },
            short_interest: { name: 'Short Interest Data Feed And Model', price: 12000, icon: 'ðŸ“‰' },
            eu_short: { name: 'European Short Interest Feed', price: 10000, icon: 'ðŸ‡ªðŸ‡º' },
            sec_144: { name: 'SEC Form 144 Filings', price: 8000, icon: 'ðŸ“‹' },
            sec_10b5: { name: 'SEC Rule 10b5-1 Plans', price: 8000, icon: 'ðŸ“‘' },
            buyback: { name: 'Global Share Buyback Data Feed', price: 12000, icon: 'ðŸ”„' },
            capitol: { name: 'Capitol Trades (U.S. Politicians\' Disclosures)', price: 10000, icon: 'ðŸ›ï¸' }
        };
        
        // Search API Configuration (for web search capability)
        let SEARCH_API = {
            provider: 'tavily', // 'tavily' or 'serper' or 'none'
            tavilyKey: '',
            serperKey: ''
        };
        
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.add('visible');
                return;
            }
            
            // Disable button during login
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.classList.remove('visible');
            
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store session
                    currentSession = {
                        user: result.user,
                        token: result.sessionToken,
                        expiry: result.expiry
                    };
                    
                    // Store in localStorage for persistence
                    localStorage.setItem('2iq_session', JSON.stringify(currentSession));
                    
                    currentUser = result.user.name;
                    document.getElementById('usernameDisplay').textContent = `ðŸ‘¤ ${result.user.name}`;
                    
                    // Hide login, show app
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.add('visible');
                    
                    // Load data from Google Sheets
                    await loadFromGoogleSheets();
                    
                    renderDashboard();
                    updateStats();
                    populateFilters();
                } else {
                    errorDiv.textContent = result.error || 'Login failed';
                    errorDiv.classList.add('visible');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.classList.add('visible');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }
        
        function handleLogout() {
            // Stop auto-sync polling
            stopAutoSync();
            
            // Clear session
            currentSession = { user: null, token: null, expiry: null };
            localStorage.removeItem('2iq_session');
            
            // Clear in-memory data
            firms = [];
            notifications = [];
            budgetUsed = 0;
            lockedRecords = {};
            lastKnownDataHash = null;
            
            // Show login, hide app
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('visible');
            
            // Clear form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.remove('visible');
        }
        
        async function checkExistingSession() {
            const savedSession = localStorage.getItem('2iq_session');
            if (!savedSession) return false;
            
            try {
                currentSession = JSON.parse(savedSession);
                
                // Check if session is expired
                if (new Date(currentSession.expiry) < new Date()) {
                    handleLogout();
                    return false;
                }
                
                // Validate session with server
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=validateSession`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        username: currentSession.user.username,
                        sessionToken: currentSession.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.valid) {
                    currentUser = currentSession.user.name;
                    document.getElementById('usernameDisplay').textContent = `ðŸ‘¤ ${currentSession.user.name}`;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.add('visible');
                    return true;
                } else {
                    handleLogout();
                    return false;
                }
            } catch (error) {
                console.error('Session validation error:', error);
                return false;
            }
        }
        
        // ============================================
        // GOOGLE SHEETS DATA FUNCTIONS
        // ============================================
        
        async function loadFromGoogleSheets() {
            try {
                console.log('ðŸ“¡ Loading firms from Google Sheets...');
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getFirms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    firms = result.firms || [];
                    console.log(`ðŸ“Š Loaded ${firms.length} firms from Google Sheets`);
                    
                    // Debug: Log some sample data
                    if (firms.length > 0) {
                        console.log('ðŸ“‹ Sample firm:', firms[0].name, '| Location:', firms[0].location, '| Priority:', firms[0].priority, '| AddedDate:', firms[0].addedDate);
                    }
                    
                    // Backfill missing addedDate for old firms
                    let backfilledCount = 0;
                    firms.forEach(firm => {
                        if (!firm.addedDate && !firm.dateAdded) {
                            // Set a default date for old firms (e.g., Jan 1, 2025)
                            firm.addedDate = '2025-01-01T00:00:00.000Z';
                            firm.source = firm.source || 'Legacy Import';
                            backfilledCount++;
                        }
                        // Normalize priority to lowercase
                        if (firm.priority) {
                            firm.priority = firm.priority.toLowerCase();
                        }
                    });
                    
                    if (backfilledCount > 0) {
                        console.log(`ðŸ“… Backfilled addedDate for ${backfilledCount} old firms`);
                    }
                } else {
                    console.error('Failed to load firms:', result.error);
                }
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
            }
        }
        
        async function saveToGoogleSheets() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=saveFirms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        firms: firms,
                        username: currentSession.user?.username || 'unknown'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`ðŸ’¾ Saved ${result.count} firms to Google Sheets`);
                } else {
                    console.error('Failed to save firms:', result.error);
                }
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
            }
        }
        
        // Manual sync button - push all local data to Google Sheets
        async function manualSyncToSheets() {
            const syncBtn = event.target;
            const originalText = syncBtn.innerHTML;
            
            if (!confirm(`âš ï¸ Push to Sheets\n\nThis will upload your ${firms.length} firms to Google Sheets.\n\nIf another team member has made changes that you don't have locally, those changes may be affected.\n\nContinue?`)) {
                return;
            }
            
            try {
                syncBtn.innerHTML = 'â³ Pushing...';
                syncBtn.disabled = true;
                
                console.log('ðŸ”„ Manual push started - ' + firms.length + ' firms');
                
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=saveFirms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        firms: firms,
                        username: currentSession.user?.username || 'unknown'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const msg = result.message || `Synced ${result.total || firms.length} firms`;
                    addNotification(
                        'â˜ï¸ Push Complete',
                        msg,
                        'success'
                    );
                    console.log('âœ… Push successful:', result);
                    localStorage.setItem('lastSyncTime', new Date().toISOString());
                } else {
                    addNotification(
                        'âŒ Push Failed',
                        result.error || 'Unknown error',
                        'error'
                    );
                    console.error('âŒ Push failed:', result.error);
                }
            } catch (error) {
                addNotification(
                    'âŒ Push Error',
                    error.message,
                    'error'
                );
                console.error('âŒ Push error:', error);
            } finally {
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        }
        
        // Refresh from Google Sheets - pull latest data
        async function refreshFromSheets() {
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;
            
            try {
                refreshBtn.innerHTML = 'â³ Loading...';
                refreshBtn.disabled = true;
                
                console.log('ðŸ”„ Manual refresh from Google Sheets...');
                
                await loadFromGoogleSheets();
                
                // Update hash for auto-sync
                lastKnownDataHash = generateDataHash(firms);
                localStorage.setItem('lastSyncTimestamp', new Date().toISOString());
                
                // Refresh the UI
                renderDashboard();
                populateFilters();
                
                addNotification(
                    'ðŸ”„ Refresh Complete',
                    `Loaded ${firms.length} firms from Google Sheets`,
                    'success'
                );
                console.log('âœ… Refresh complete:', firms.length, 'firms');
                
            } catch (error) {
                addNotification(
                    'âŒ Refresh Failed',
                    error.message,
                    'error'
                );
                console.error('âŒ Refresh error:', error);
            } finally {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }
        
        async function logAction(action, details, firmId = '') {
            try {
                await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=addLog`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        username: currentSession.user?.username || 'unknown',
                        action: action,
                        details: details,
                        firmId: firmId
                    })
                });
            } catch (error) {
                console.error('Error logging action:', error);
            }
        }
        
        // ============================================
        // FULL SYNC WITH DELETION (Admin Only)
        // This will delete firms from Google Sheets that aren't in your local data
        // ============================================
        async function fullSyncWithDeletion() {
            const currentCount = firms.length;
            
            // Double confirmation for this destructive action
            const firstConfirm = confirm(
                `âš ï¸ FULL SYNC WITH DELETION\n\n` +
                `This is an ADMIN operation that will:\n` +
                `âœ… Add new firms to Google Sheets\n` +
                `âœ… Update existing firms\n` +
                `ðŸ—‘ï¸ DELETE firms from Google Sheets that aren't in your current view (${currentCount} firms)\n\n` +
                `Use this ONLY if:\n` +
                `â€¢ You've just refreshed from Google Sheets\n` +
                `â€¢ You want to remove duplicates/deleted items\n` +
                `â€¢ You're sure no other team member is actively making changes\n\n` +
                `Continue?`
            );
            
            if (!firstConfirm) return;
            
            const secondConfirm = confirm(
                `ðŸ›‘ FINAL CONFIRMATION\n\n` +
                `You are about to PERMANENTLY DELETE firms from Google Sheets.\n\n` +
                `Current local firms: ${currentCount}\n\n` +
                `Any firms in Google Sheets that are NOT in your local list will be DELETED.\n\n` +
                `Type YES in the next prompt to confirm.`
            );
            
            if (!secondConfirm) return;
            
            const finalConfirm = prompt('Type "YES" to confirm full sync with deletion:');
            if (finalConfirm !== 'YES') {
                addNotification('âŒ Cancelled', 'Full sync cancelled - you must type YES exactly', 'warning');
                return;
            }
            
            try {
                addNotification('ðŸ”„ Full Sync', 'Starting full sync with deletion...', 'info');
                
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=fullSync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        firms: firms,
                        username: currentSession.user?.username || 'unknown',
                        confirmDelete: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addNotification(
                        'âœ… Full Sync Complete',
                        `Added: ${result.added}, Updated: ${result.updated}, Deleted: ${result.deleted}`,
                        result.deleted > 0 ? 'warning' : 'success'
                    );
                    console.log('âœ… Full sync result:', result);
                    
                    // Refresh to confirm
                    await loadFromGoogleSheets();
                    renderDashboard();
                    populateFilters();
                } else {
                    addNotification('âŒ Full Sync Failed', result.error || 'Unknown error', 'error');
                    console.error('âŒ Full sync failed:', result.error);
                }
            } catch (error) {
                addNotification('âŒ Full Sync Error', error.message, 'error');
                console.error('âŒ Full sync error:', error);
            }
        }
        
        // Data sources for hedge fund discovery
        const DISCOVERY_DATA_SOURCES = [
            {
                name: 'HedgeWeek',
                url: 'https://www.hedgeweek.com/',
                type: 'news',
                description: 'Industry news, fund launches, hiring'
            },
            {
                name: 'Hedge Fund Journal',
                url: 'https://thehedgefundjournal.com/',
                type: 'news',
                description: 'Fund profiles and performance'
            },
            {
                name: 'Holdings Channel',
                url: 'https://www.holdingschannel.com/all/',
                type: 'database',
                description: '13F filers and holdings data'
            },
            {
                name: 'Private Fund Data',
                url: 'https://privatefunddata.com/',
                type: 'database',
                description: 'Fund AUM and contacts'
            }
        ];
        
        // Lead Discovery Sources
        const DISCOVERY_SOURCES = [
            { name: 'SEC 13F Filings', icon: 'ðŸ“‹', description: 'New institutional investors filing 13F' },
            { name: 'Financial Times', icon: 'ðŸ“°', description: 'Fund launches, expansions, hiring news' },
            { name: 'Bloomberg', icon: 'ðŸ“ˆ', description: 'Fund performance and strategy changes' },
            { name: 'LinkedIn Jobs', icon: 'ðŸ’¼', description: 'Funds hiring data/quant roles' },
            { name: 'Reddit (r/quant, r/algotrading)', icon: 'ðŸ’¬', description: 'Discussion of emerging funds' },
            { name: 'HedgeWeek', icon: 'ðŸ“Š', description: 'Industry news and fund launches' },
            { name: 'Preqin', icon: 'ðŸ”', description: 'New fund registrations' },
            { name: 'eVestment', icon: 'ðŸ“‰', description: 'Fund performance signals' }
        ];
        
        // Tavily Search API (free tier available)
        async function tavilySearch(query, maxResults = 5) {
            if (!SEARCH_API.tavilyKey) {
                throw new Error('Tavily API key not configured');
            }
            
            const response = await fetch('https://api.tavily.com/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_key: SEARCH_API.tavilyKey,
                    query: query,
                    search_depth: 'advanced',
                    include_answer: true,
                    include_raw_content: false,
                    max_results: maxResults
                })
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || 'Tavily search failed');
            }
            
            return await response.json();
        }
        
        // Serper Google Search API (alternative)
        async function serperSearch(query, maxResults = 5) {
            if (!SEARCH_API.serperKey) {
                throw new Error('Serper API key not configured');
            }
            
            const response = await fetch('https://google.serper.dev/search', {
                method: 'POST',
                headers: {
                    'X-API-KEY': SEARCH_API.serperKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    q: query,
                    num: maxResults
                })
            });
            
            if (!response.ok) {
                throw new Error('Serper search failed');
            }
            
            const data = await response.json();
            return {
                results: (data.organic || []).map(r => ({
                    title: r.title,
                    url: r.link,
                    content: r.snippet
                }))
            };
        }
        
        // Universal search function
        async function webSearch(query, maxResults = 5) {
            if (SEARCH_API.tavilyKey) {
                return await tavilySearch(query, maxResults);
            } else if (SEARCH_API.serperKey) {
                return await serperSearch(query, maxResults);
            }
            return null;
        }

        // Load initial data from Excel - will be populated from localStorage or window.storage

        // Login
        // Initialize app after successful login
        async function initializeApp() {
            await loadApiKeys();
            
            // Start auto-sync for real-time collaboration
            startAutoSync();
            lastKnownDataHash = generateDataHash(firms);
            
            // Prompt to set up API keys if not configured
            if (!API_KEYS.claude) {
                setTimeout(() => {
                    if (confirm('âš™ï¸ Claude API key not configured.\n\nWould you like to set it up now for AI-powered research?\n\n(Click Settings âš™ï¸ icon anytime to configure)')) {
                        openSettings();
                    }
                }, 1000);
            } else {
                // Show welcome with API status
                addNotification(
                    'System Ready',
                    `Welcome ${currentUser}! Auto-sync enabled (30s) | Claude API: âœ“`,
                    'success'
                );
            }
            
            // If no firms exist, show import option
            if (firms.length === 0) {
                setTimeout(() => {
                    const shouldImport = confirm('No firms found. Would you like to add sample firms now?\n\n(You can import your Excel data later)');
                    if (shouldImport) {
                        importExcelDataFromFile();
                    }
                }, API_KEYS.claude ? 500 : 2000);
            }
            
            renderDashboard();
            updateBudgetDisplay();
            checkForAlerts();
            populateFilters();
        }
        
        // Check for existing session on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const hasSession = await checkExistingSession();
            if (hasSession) {
                await loadFromGoogleSheets();
                await loadApiKeys();
                
                // Initialize hash for auto-sync
                lastKnownDataHash = generateDataHash(firms);
                
                renderDashboard();
                updateStats();
                populateFilters();
                initializeApp();
            }
        });
        
        // Recalculate priorities based on data usage and AUM
        async function recalculatePriorities() {
            if (!confirm('This will recalculate priorities for firms based on:\n\nâ€¢ Fit Score from research (8+ = High, 6-7 = Medium)\nâ€¢ Data Usage (VERY HIGH/HIGH)\nâ€¢ AUM (>$20B = High, >$5B = Medium)\n\nFirms without data will keep their current priority.\n\nContinue?')) {
                return;
            }
            
            let updated = 0;
            let skipped = 0;
            
            firms.forEach(firm => {
                let newPriority = null;
                
                // If firm has been researched, use fitScore
                if (firm.fitScore && firm.fitScore > 0) {
                    if (firm.fitScore >= 8) newPriority = 'high';
                    else if (firm.fitScore >= 6) newPriority = 'medium';
                    else newPriority = 'low';
                } else {
                    // Check if we have data to calculate from
                    const dataUsage = (firm.dataUsage || '').toUpperCase();
                    const aum = parseFloat(firm.aum) || 0;
                    const hasDataUsage = dataUsage.includes('HIGH') || dataUsage.includes('VERY HIGH');
                    const hasAum = aum > 0;
                    
                    // Only calculate if we have some data
                    if (hasDataUsage || hasAum) {
                        if (dataUsage.includes('VERY HIGH') || aum > 20) {
                            newPriority = 'high';
                        } else if (dataUsage.includes('HIGH') || aum > 5) {
                            newPriority = 'medium';
                        } else {
                            newPriority = 'low';
                        }
                    }
                    // If no data available, keep existing priority (newPriority stays null)
                }
                
                // Only update if we calculated a new priority
                if (newPriority && firm.priority !== newPriority) {
                    firm.priority = newPriority;
                    updated++;
                } else if (!newPriority) {
                    skipped++;
                }
            });
            
            await saveToStorage();
            renderDashboard();
            
            addNotification('ðŸ·ï¸ Priorities Updated', `Updated ${updated} firms, kept ${skipped} unchanged (no data)`, 'success');
        }
        
        // Reset all filters and collapse columns
        function resetFilters() {
            // Reset filter dropdowns
            document.getElementById('searchInput').value = '';
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterStrategy').value = '';
            document.getElementById('filterPriority').value = '';
            const dateFilter = document.getElementById('filterDateAdded');
            if (dateFilter) dateFilter.value = '';
            const assignedFilter = document.getElementById('filterAssignedTo');
            if (assignedFilter) assignedFilter.value = '';
            
            // Reset pagination to show 5 per column
            Object.keys(columnDisplayCount).forEach(key => {
                columnDisplayCount[key] = 5;
            });
            
            // Re-render
            renderDashboard();
            populateFilters();
            
            addNotification('ðŸ”„ Filters Reset', 'All filters cleared and columns collapsed', 'info');
        }

        // Import Excel data from uploaded file
        async function importExcelDataFromFile() {
            try {
                // In a real implementation, this would read from /mnt/user-data/uploads
                // For now, we'll pre-populate with sample data based on the structure
                await importSampleData();
            } catch (e) {
                console.error('Import error:', e);
                addNotification('Import Error', 'Could not import Excel data. Starting with empty database.', 'warning');
            }
        }
        
        // Import sample data (represents the Excel structure)
        async function importSampleData() {
            const sampleFirms = [
                {
                    name: 'Balyasny Asset Management',
                    location: 'NEW YORK',
                    aum: 31.0,
                    focus: 'Multi-strategy RV, arbitrage, macro',
                    dataUsage: 'VERY HIGH - Quantamental, Chief Data Officer',
                    notes: 'Chicago-based. Up 15.3% YTD 2025. Data-driven approach.',
                    website: 'https://www.bamfunds.com',
                    linkedIn: 'linkedin.com/company/balyasny',
                    contactName: 'Carson Boneck',
                    contactPosition: 'Chief Data Officer',
                    status: 'Not Contacted',
                    priority: 'high'
                },
                {
                    name: 'Balyasny (London)',
                    location: 'LONDON',
                    aum: 31.0,
                    focus: 'Multi-strategy',
                    dataUsage: 'HIGH - Uses alternative data',
                    notes: 'London office of Balyasny. Focus on European markets.',
                    website: 'https://www.bamfunds.com',
                    linkedIn: 'linkedin.com/company/balyasny',
                    status: 'Not Contacted',
                    priority: 'high'
                },
                {
                    name: 'Avenue Capital',
                    location: 'NEW YORK',
                    aum: 11.0,
                    focus: 'Event-driven credit, distressed debt',
                    dataUsage: 'VERY HIGH - Insider data, 10-K/10-Q, restructuring',
                    notes: 'Marc Lasry founded. Perfect fit for insider/event data.',
                    website: 'https://www.avenuecapital.com',
                    linkedIn: 'linkedin.com/company/avenue-capital',
                    contactName: 'Marc Lasry',
                    contactPosition: 'Founder',
                    status: 'Not Contacted',
                    priority: 'high'
                },
                {
                    name: 'Citadel',
                    location: 'CHICAGO',
                    aum: 62.0,
                    focus: 'Multi-strategy',
                    dataUsage: 'VERY HIGH - Technology-driven',
                    notes: 'One of largest hedge funds. Heavy data usage.',
                    website: 'https://www.citadel.com',
                    linkedIn: 'linkedin.com/company/citadel',
                    status: 'Not Contacted',
                    priority: 'high'
                },
                {
                    name: 'Renaissance Technologies',
                    location: 'NEW YORK',
                    aum: 130.0,
                    focus: 'Quantitative',
                    dataUsage: 'VERY HIGH - Pure quant',
                    notes: 'Legendary quant fund. Data-intensive.',
                    website: 'https://www.rentec.com',
                    linkedIn: 'linkedin.com/company/renaissance-technologies',
                    status: 'Not Contacted',
                    priority: 'high'
                }
            ];
            
            sampleFirms.forEach(firmData => {
                const firm = {
                    id: generateId(),
                    name: firmData.name,
                    location: firmData.location,
                    aum: firmData.aum,
                    focus: firmData.focus,
                    dataUsage: firmData.dataUsage,
                    notes: firmData.notes,
                    website: firmData.website,
                    linkedIn: firmData.linkedIn,
                    contactName: firmData.contactName || '',
                    contactPosition: firmData.contactPosition || '',
                    contactEmail: '',
                    contactPhone: '',
                    status: firmData.status || 'Not Contacted',
                    priority: firmData.priority || 'medium',
                    fitScore: null,
                    researchDate: null,
                    researchData: null,
                    source: 'Excel Import',
                    addedBy: 'System',
                    addedDate: new Date().toISOString(),
                    lockedBy: null
                };
                firms.push(firm);
            });
            
            await saveToStorage();
            addNotification('Import Complete', `Imported ${sampleFirms.length} sample firms. You can add more firms using the "+ Add Firm" button.`, 'success');
        }

        // Generate unique ID
        function generateId() {
            return 'firm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Storage functions
        async function saveToStorage() {
            try {
                // ============================================
                // UNIFIED SYNC: Google Sheets is the ONLY source of truth
                // NO localStorage for business data to prevent cache issues
                // ============================================
                
                // Save directly to Google Sheets (single source of truth)
                await saveToGoogleSheets();
                
                // Update last sync timestamp (this IS safe to cache)
                localStorage.setItem('lastSyncTimestamp', new Date().toISOString());
                
                console.log('âœ… Data saved to Google Sheets (unified sync)');
            } catch (err) {
                console.error('âŒ Google Sheets sync failed:', err);
                addNotification('âš ï¸ Sync Error', 'Changes may not be saved. Please refresh and try again.', 'error');
                throw err; // Propagate error so caller knows save failed
            }
        }
        
        // ============================================
        // AUTO-SYNC: Poll for changes every 30 seconds
        // ============================================
        let autoSyncInterval = null;
        let lastKnownDataHash = null;
        
        function startAutoSync() {
            if (autoSyncInterval) clearInterval(autoSyncInterval);
            
            autoSyncInterval = setInterval(async () => {
                if (!currentSession.user) return;
                
                try {
                    // Get current hash from Google Sheets
                    const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getDataHash`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({})
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.hash !== lastKnownDataHash) {
                        console.log('ðŸ”„ Auto-sync: New data detected, refreshing...');
                        
                        // Data changed, reload
                        await loadFromGoogleSheets();
                        lastKnownDataHash = result.hash;
                        
                        // Refresh UI
                        renderDashboard();
                        populateFilters();
                        
                        addNotification('ðŸ”„ Data Synced', 'Latest changes from team loaded', 'info');
                    }
                } catch (e) {
                    console.warn('Auto-sync check failed (will retry):', e.message);
                }
            }, 30000); // Every 30 seconds
            
            console.log('ðŸ”„ Auto-sync started (30s interval)');
        }
        
        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
                console.log('ðŸ”„ Auto-sync stopped');
            }
        }

        async function loadStoredData() {
            try {
                // ============================================
                // UNIFIED SYNC: Always load from Google Sheets
                // NO localStorage fallback for business data
                // ============================================
                
                if (!currentSession.user) {
                    console.warn('âš ï¸ Cannot load data: not logged in');
                    return;
                }
                
                // Show loading indicator
                addNotification('ðŸ”„ Loading data...', 'Fetching latest from Google Sheets', 'info');
                
                // SINGLE SOURCE OF TRUTH: Google Sheets
                await loadFromGoogleSheets();
                
                // Calculate and store hash for auto-sync comparison
                lastKnownDataHash = generateDataHash(firms);
                
                console.log('âœ… Loaded fresh data from Google Sheets');
                
                // Start auto-sync polling
                startAutoSync();
                
            } catch (e) {
                console.error('Error loading data from Google Sheets:', e);
                addNotification('âŒ Load Error', 'Could not load data. Please refresh the page.', 'error');
            }
        }
        
        // Generate simple hash for change detection
        function generateDataHash(data) {
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // Pagination state - track how many items to show per column
        // Pagination state - show 5 items by default
        const columnDisplayCount = {
            'Not Contacted': 5,
            'Contacted': 5,
            'Trial Ongoing': 5,
            'Client': 5,
            'Closed': 5,
            'Not a Good Fit': 5
        };

        // Render dashboard
        function renderDashboard() {
            // IMPORTANT: Filter out soft-deleted firms from display
            const activeFirms = firms.filter(f => !f.isDeleted);
            
            const notContacted = activeFirms.filter(f => f.status === 'Not Contacted');
            const contacted = activeFirms.filter(f => f.status === 'Contacted');
            const trialOngoing = activeFirms.filter(f => f.status === 'Trial Ongoing');
            const clients = activeFirms.filter(f => f.status === 'Client');
            const closed = activeFirms.filter(f => f.status === 'Closed');
            const notGoodFit = activeFirms.filter(f => f.status === 'Not a Good Fit');
            const highPriority = activeFirms.filter(f => f.priority === 'high');

            // Update stats (only count active firms)
            document.getElementById('statTotal').textContent = activeFirms.length;
            document.getElementById('statNotContacted').textContent = notContacted.length;
            document.getElementById('statTrialOngoing').textContent = trialOngoing.length;
            document.getElementById('statHighPriority').textContent = highPriority.length;
            document.getElementById('statClients').textContent = clients.length;

            // Update column counts
            document.getElementById('countNotContacted').textContent = notContacted.length;
            document.getElementById('countContacted').textContent = contacted.length;
            document.getElementById('countTrialOngoing').textContent = trialOngoing.length;
            document.getElementById('countClient').textContent = clients.length;
            document.getElementById('countClosed').textContent = closed.length;
            document.getElementById('countNotGoodFit').textContent = notGoodFit.length;

            // Render columns with pagination (left to right order)
            renderColumnPaginated('columnNotContacted', notContacted, 'Not Contacted');
            renderColumnPaginated('columnContacted', contacted, 'Contacted');
            renderColumnPaginated('columnTrialOngoing', trialOngoing, 'Trial Ongoing');
            renderColumnPaginated('columnClient', clients, 'Client');
            renderColumnPaginated('columnClosed', closed, 'Closed');
            renderColumnPaginated('columnNotGoodFit', notGoodFit, 'Not a Good Fit');
        }

        function renderColumnPaginated(elementId, firmsArray, status) {
            const column = document.getElementById(elementId);
            if (!column) return;
            column.innerHTML = '';
            
            const displayCount = columnDisplayCount[status] || 5;
            const visibleFirms = firmsArray.slice(0, displayCount);
            const remaining = firmsArray.length - displayCount;
            const isExpanded = displayCount > 5;
            
            visibleFirms.forEach(firm => {
                const card = createFirmCard(firm);
                column.appendChild(card);
            });
            
            // Show/hide load more button
            const loadMoreId = 'loadMore' + status.replace(/\s+/g, '');
            const loadMoreContainer = document.getElementById(loadMoreId);
            if (loadMoreContainer) {
                if (remaining > 0 || isExpanded) {
                    loadMoreContainer.style.display = 'block';
                    let selectHtml = `<select onchange="loadMoreFirms('${status}', this.value)" class="load-more-select">`;
                    
                    if (isExpanded) {
                        selectHtml += `<option value="">Showing ${visibleFirms.length} of ${firmsArray.length}</option>`;
                        selectHtml += `<option value="reset">â†©ï¸ Collapse to 5</option>`;
                    } else {
                        selectHtml += `<option value="">Load more (${remaining} remaining)</option>`;
                    }
                    
                    if (remaining > 0) {
                        selectHtml += `<option value="5">+5 more</option>`;
                        selectHtml += `<option value="10">+10 more</option>`;
                        if (remaining > 10) selectHtml += `<option value="20">+20 more</option>`;
                        selectHtml += `<option value="all">Show all (${firmsArray.length})</option>`;
                    }
                    
                    selectHtml += `</select>`;
                    loadMoreContainer.innerHTML = selectHtml;
                } else {
                    loadMoreContainer.style.display = 'none';
                }
            }
        }
        
        function loadMoreFirms(status, amount) {
            if (!amount) return;
            
            if (amount === 'reset') {
                columnDisplayCount[status] = 5;
            } else if (amount === 'all') {
                columnDisplayCount[status] = 9999;
            } else {
                columnDisplayCount[status] = (columnDisplayCount[status] || 5) + parseInt(amount);
            }
            renderDashboard();
        }

        // ============================================
        // FIRM LOCKING FUNCTIONS
        // ============================================
        
        // Track currently open firm for unlocking
        let currentlyOpenFirmId = null;
        
        // Check if firm is locked by another user
        function isFirmLocked(firm) {
            if (!firm.lockedBy) return false;
            if (firm.lockedBy === (currentSession?.user?.username || currentUser)) return false;
            
            // Check if lock has expired (5 minutes)
            if (firm.lockedAt) {
                const lockTime = new Date(firm.lockedAt).getTime();
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000;
                if (now - lockTime > fiveMinutes) {
                    // Lock expired, clear it
                    firm.lockedBy = null;
                    firm.lockedAt = null;
                    return false;
                }
            }
            return true;
        }
        
        // Lock a firm for editing
        async function lockFirm(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (firm) {
                firm.lockedBy = currentSession?.user?.username || currentUser || 'unknown';
                firm.lockedAt = new Date().toISOString();
                await saveToStorage();
            }
        }
        
        // Unlock a firm
        async function unlockFirm(firmId) {
            const firm = firms.find(f => f.id === firmId);
            const username = currentSession?.user?.username || currentUser;
            if (firm && firm.lockedBy === username) {
                firm.lockedBy = null;
                firm.lockedAt = null;
                await saveToStorage();
            }
        }

        function createFirmCard(firm) {
            const card = document.createElement('div');
            card.className = `firm-card priority-${firm.priority}-card`;
            if (firm.lockedBy && firm.lockedBy !== currentUser) {
                card.classList.add('locked');
            }
            if (firm.status === 'Client') {
                card.classList.add('client-card');
            }
            
            const priorityClass = `priority-${firm.priority}`;
            const fitScoreDisplay = firm.fitScore ? `<div class="fit-score">${firm.fitScore}/10</div>` : '';
            
            const researchStatus = firm.researchDate 
                ? `<div class="research-status">ðŸ“Š Researched ${formatDate(firm.researchDate)}</div>`
                : `<div class="research-status">â“ Not researched</div>`;
            
            // Use normalized location data
            const normalized = getNormalizedFirmData(firm);
            const displayLocation = normalized.location !== 'Unknown' ? normalized.location : (firm.location || 'Unknown');
            const displayStrategy = normalized.firmType || firm.focus || '';
            
            // Format AUM display
            const aumDisplay = firm.aum ? `$${firm.aum}B AUM` : 'AUM N/A';
            
            // Subscription badges for clients
            let subscriptionHtml = '';
            if (firm.status === 'Client' && firm.subscriptions && firm.subscriptions.length > 0) {
                const subBadges = firm.subscriptions.slice(0, 3).map(subKey => {
                    const product = IQ_PRODUCTS[subKey];
                    return product ? `<span class="subscription-badge">${product.icon} ${product.name.split(' ')[0]}</span>` : '';
                }).join('');
                const upsellCount = Object.keys(IQ_PRODUCTS).length - firm.subscriptions.length;
                subscriptionHtml = `
                    <div class="subscription-badges">${subBadges}</div>
                    ${upsellCount > 0 ? `<div class="upsell-indicator">ðŸ’¡ ${upsellCount} upsell opportunities</div>` : ''}
                `;
            } else if (firm.status === 'Client') {
                subscriptionHtml = `<div class="upsell-indicator">âš ï¸ No subscriptions recorded</div>`;
            }
            
            // Trial dates display for Trial Ongoing status
            let trialDatesHtml = '';
            if (firm.status === 'Trial Ongoing') {
                const startDate = firm.trialStartDate ? new Date(firm.trialStartDate).toLocaleDateString() : 'Not set';
                const endDate = firm.trialEndDate ? new Date(firm.trialEndDate).toLocaleDateString() : 'Not set';
                const today = new Date();
                const endDateObj = firm.trialEndDate ? new Date(firm.trialEndDate) : null;
                const isExpired = endDateObj && endDateObj < today;
                const daysLeft = endDateObj ? Math.ceil((endDateObj - today) / (1000 * 60 * 60 * 24)) : null;
                
                trialDatesHtml = `
                    <div class="trial-dates" style="font-size: 0.75rem; margin-top: 0.5rem; padding: 0.4rem; background: rgba(69, 123, 157, 0.15); border-radius: 4px;">
                        <div style="color: var(--silver);">ðŸ“… ${startDate} â†’ ${endDate}</div>
                        ${daysLeft !== null ? `<div style="color: ${isExpired ? 'var(--red-flag)' : daysLeft <= 3 ? 'var(--yellow-flag)' : 'var(--green-flag)'}; font-weight: 600;">
                            ${isExpired ? 'âš ï¸ Trial Expired' : `${daysLeft} days left`}
                        </div>` : ''}
                    </div>
                `;
            }
            
            // Lock indicator
            let lockHtml = '';
            if (isFirmLocked(firm)) {
                lockHtml = `
                    <div class="lock-indicator" style="position: absolute; top: 0.5rem; left: 0.5rem; background: rgba(230, 57, 70, 0.9); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; z-index: 1;">
                        ðŸ”’ ${firm.lockedBy}
                    </div>
                `;
            }
            
            // Contact method badge and days since contact (for Contacted status)
            let contactInfoHtml = '';
            if (firm.status === 'Contacted' && firm.contactMethod) {
                const methodIcons = { 'Email': 'ðŸ“§', 'Phone': 'ðŸ“ž', 'LinkedIn': 'ðŸ’¼' };
                const methodIcon = methodIcons[firm.contactMethod] || 'ðŸ“¨';
                
                // Calculate days since last contact
                let daysSinceContact = '';
                if (firm.contactDate) {
                    const contactDate = new Date(firm.contactDate);
                    const now = new Date();
                    const days = Math.floor((now - contactDate) / (1000 * 60 * 60 * 24));
                    const dayColor = days > 7 ? 'var(--red-flag)' : days > 3 ? 'var(--yellow-flag)' : 'var(--green-flag)';
                    daysSinceContact = `<span style="color: ${dayColor}; font-weight: 600;">${days === 0 ? 'Today' : days === 1 ? '1 day ago' : days + ' days ago'}</span>`;
                }
                
                // Show all methods tried
                const methodsUsed = firm.contactHistory ? [...new Set(firm.contactHistory.map(h => h.method))] : [firm.contactMethod];
                const methodBadges = methodsUsed.map(m => `<span style="background: rgba(212, 165, 116, 0.2); padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">${methodIcons[m] || 'ðŸ“¨'} ${m}</span>`).join(' ');
                
                contactInfoHtml = `
                    <div class="contact-info" style="font-size: 0.75rem; margin-top: 0.5rem; padding: 0.4rem; background: rgba(212, 165, 116, 0.1); border-radius: 4px; border-left: 2px solid var(--gold-accent);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.3rem;">
                            <div>${methodBadges}</div>
                            ${daysSinceContact ? `<div>${daysSinceContact}</div>` : ''}
                        </div>
                        ${firm.contactHistory && firm.contactHistory.length > 1 ? `<div style="color: var(--silver); margin-top: 0.3rem;">${firm.contactHistory.length} contact attempts</div>` : ''}
                    </div>
                `;
            }
            
            // Source and added by badge
            let sourceInfoHtml = '';
            if (firm.source || firm.addedBy) {
                const sourceIcon = firm.source === 'AI Discovery' ? 'ðŸ¤–' : firm.source === 'Excel Import' ? 'ðŸ“Š' : firm.source === 'Manual Entry' ? 'âœï¸' : 'ðŸ“';
                const addedDate = firm.addedDate ? new Date(firm.addedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                sourceInfoHtml = `
                    <div style="font-size: 0.65rem; color: var(--silver); margin-top: 0.4rem; display: flex; justify-content: space-between; align-items: center; opacity: 0.8;">
                        <span>${sourceIcon} ${firm.source || 'Unknown'}</span>
                        <span>by ${firm.addedBy || '?'} ${addedDate ? `â€¢ ${addedDate}` : ''}</span>
                    </div>
                `;
            }
            
            // Follow-up reminder countdown
            let reminderHtml = '';
            if (firm.scheduledReminders && firm.scheduledReminders.length > 0) {
                // Find the next upcoming reminder
                const now = new Date();
                const sortedReminders = [...firm.scheduledReminders]
                    .map(r => ({ ...r, dateObj: new Date(r.date) }))
                    .sort((a, b) => a.dateObj - b.dateObj);
                
                const nextReminder = sortedReminders.find(r => r.dateObj >= now);
                const overdueReminder = sortedReminders.find(r => r.dateObj < now);
                
                if (overdueReminder) {
                    const daysOverdue = Math.floor((now - overdueReminder.dateObj) / (1000 * 60 * 60 * 24));
                    reminderHtml = `
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; padding: 0.4rem; background: rgba(230, 57, 70, 0.2); border-radius: 4px; border-left: 3px solid var(--red-flag);">
                            <div style="color: var(--red-flag); font-weight: 600;">
                                âš ï¸ OVERDUE: ${daysOverdue === 0 ? 'Today' : daysOverdue === 1 ? '1 day' : daysOverdue + ' days'}
                            </div>
                            <div style="color: var(--silver); font-size: 0.7rem; margin-top: 0.2rem;">${overdueReminder.notes || 'Follow-up needed'}</div>
                        </div>
                    `;
                } else if (nextReminder) {
                    const daysUntil = Math.ceil((nextReminder.dateObj - now) / (1000 * 60 * 60 * 24));
                    const urgencyColor = daysUntil <= 1 ? 'var(--red-flag)' : daysUntil <= 3 ? 'var(--yellow-flag)' : 'var(--green-flag)';
                    reminderHtml = `
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; padding: 0.4rem; background: rgba(244, 162, 97, 0.15); border-radius: 4px; border-left: 3px solid ${urgencyColor};">
                            <div style="color: ${urgencyColor}; font-weight: 600;">
                                ðŸ”” Follow-up: ${daysUntil === 0 ? 'Today' : daysUntil === 1 ? 'Tomorrow' : 'in ' + daysUntil + ' days'}
                            </div>
                            <div style="color: var(--silver); font-size: 0.7rem; margin-top: 0.2rem;">${nextReminder.notes || 'Scheduled reminder'}</div>
                        </div>
                    `;
                }
            }
            
            // User assignment badge - Different colors for each user
            let assignmentHtml = '';
            if (firm.assignedTo) {
                const isMe = firm.assignedTo.toLowerCase() === currentUser?.toLowerCase();
                
                // Define unique colors for each team member
                const userColors = {
                    'zabih': { bg: 'rgba(76, 175, 80, 0.9)', icon: 'ðŸŸ¢' },      // Green for Zabih
                    'noor': { bg: 'rgba(33, 150, 243, 0.9)', icon: 'ðŸ”µ' },       // Blue for Noor
                    'huzaifa': { bg: 'rgba(255, 152, 0, 0.9)', icon: 'ðŸŸ ' }      // Orange for Huzaifa
                };
                
                const userKey = firm.assignedTo.toLowerCase();
                const userStyle = userColors[userKey] || { bg: 'rgba(126, 87, 194, 0.9)', icon: 'âšª' };
                
                assignmentHtml = `
                    <div style="position: absolute; top: 0.5rem; right: 0.5rem; background: ${userStyle.bg}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.65rem; z-index: 1; display: flex; align-items: center; gap: 0.25rem; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        ${userStyle.icon} ${firm.assignedTo}${isMe ? ' (Me)' : ''}
                    </div>
                `;
            }
            
            card.innerHTML = `
                ${lockHtml}
                ${assignmentHtml}
                <div class="firm-name">${firm.name}</div>
                <div class="firm-meta">
                    <div class="meta-item">ðŸ“ ${displayLocation}</div>
                    <div class="meta-item">ðŸ’° ${aumDisplay}</div>
                    <div class="meta-item"><span class="priority-badge ${priorityClass}">${firm.priority}</span></div>
                </div>
                ${displayStrategy ? `<div class="firm-strategy">${displayStrategy.substring(0, 50)}${displayStrategy.length > 50 ? '...' : ''}</div>` : ''}
                ${researchStatus}
                ${fitScoreDisplay}
                ${contactInfoHtml}
                ${subscriptionHtml}
                ${trialDatesHtml}
                ${reminderHtml}
                ${sourceInfoHtml}
            `;
            
            card.onclick = () => openFirmDetails(firm);
            return card;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            if (days === 0) return 'today';
            if (days === 1) return 'yesterday';
            if (days < 30) return `${days} days ago`;
            if (days < 90) return `${Math.floor(days/30)} months ago`;
            return `${Math.floor(days/30)} months ago`;
        }

        // Add firm
        function openAddFirmModal() {
            document.getElementById('addFirmModal').classList.add('active');
        }

        async function addFirm(event) {
            event.preventDefault();
            
            const firm = {
                id: generateId(),
                name: document.getElementById('firmName').value,
                location: document.getElementById('firmLocation').value,
                aum: parseFloat(document.getElementById('firmAUM').value) || 0,
                website: document.getElementById('firmWebsite').value,
                linkedIn: document.getElementById('firmLinkedIn').value,
                focus: document.getElementById('firmStrategy').value,
                notes: document.getElementById('firmNotes').value,
                status: 'Not Contacted',
                priority: 'medium',
                fitScore: null,
                researchDate: null,
                researchData: null,
                source: 'Manual Entry',
                addedBy: currentUser,
                addedDate: new Date().toISOString(),
                lockedBy: null
            };
            
            firms.push(firm);
            await saveToStorage();
            renderDashboard();
            closeModal('addFirmModal');
            
            // Automatically suggest research
            setTimeout(() => {
                if (confirm(`Would you like to research "${firm.name}" now?`)) {
                    initiateResearch(firm.id);
                }
            }, 500);
        }

        // Research workflow
        function initiateResearch(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            // Check budget
            if (budgetUsed >= BUDGET_LIMIT) {
                alert('Monthly budget limit reached. Please wait until next month or increase budget.');
                return;
            }
            
            // Check which LLMs are configured
            const availableLLMs = [];
            if (API_KEYS.claude) availableLLMs.push('claude');
            if (API_KEYS.openai) availableLLMs.push('openai');
            if (API_KEYS.deepseek) availableLLMs.push('deepseek');
            if (API_KEYS.gemini) availableLLMs.push('gemini');
            
            if (availableLLMs.length === 0) {
                alert('âŒ No API keys configured!\n\nPlease click âš™ï¸ Settings to add at least one API key.');
                return;
            }
            
            // Show research preview with LLM selection
            const preview = `
                <div class="research-preview">
                    <div class="preview-section">
                        <div class="preview-heading">Research Plan for ${firm.name}</div>
                        <p style="color: var(--silver); margin-bottom: 1rem;">Select AI models to research this firm. Use multiple models for comparison.</p>
                    </div>
                    
                    <div class="preview-section">
                        <div class="preview-heading">Select AI Models</div>
                        <div class="llm-selection-grid">
                            ${Object.entries(LLM_CONFIG).map(([key, config]) => {
                                const isAvailable = API_KEYS[key];
                                const isChecked = isAvailable && (key === 'claude' || availableLLMs.length === 1);
                                return `
                                    <label class="llm-checkbox ${!isAvailable ? 'disabled' : ''}" style="--llm-color: ${config.color}">
                                        <input type="checkbox" 
                                            name="llm-select" 
                                            value="${key}" 
                                            ${isChecked ? 'checked' : ''} 
                                            ${!isAvailable ? 'disabled' : ''}
                                            onchange="updateResearchCostEstimate()">
                                        <span class="llm-checkbox-content">
                                            <span class="llm-icon">${config.icon}</span>
                                            <span class="llm-name">${config.name}</span>
                                            ${!isAvailable ? '<span class="llm-status">Not configured</span>' : '<span class="llm-status ready">Ready</span>'}
                                        </span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <div class="preview-heading">Research Mode</div>
                        <div class="research-mode-selection">
                            <label class="mode-radio">
                                <input type="radio" name="research-mode" value="single" checked onchange="updateResearchModeUI()">
                                <span class="mode-content">
                                    <span class="mode-icon">ðŸŽ¯</span>
                                    <span class="mode-label">Single Best Result</span>
                                    <span class="mode-desc">Use first selected model</span>
                                </span>
                            </label>
                            <label class="mode-radio">
                                <input type="radio" name="research-mode" value="compare" onchange="updateResearchModeUI()">
                                <span class="mode-content">
                                    <span class="mode-icon">âš–ï¸</span>
                                    <span class="mode-label">Side-by-Side Compare</span>
                                    <span class="mode-desc">Run all selected models & compare</span>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="cost-estimate" id="researchCostEstimate">
                        <div class="cost-label">Estimated Cost</div>
                        <div class="cost-amount">~$0.03</div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button class="btn" onclick="startMultiLLMResearch('${firmId}')" style="flex: 1;">
                            ðŸš€ Start Research
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('researchModal')">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('researchPreview').innerHTML = preview;
            document.getElementById('researchModal').classList.add('active');
            updateResearchCostEstimate();
        }
        
        function updateResearchCostEstimate() {
            const selected = Array.from(document.querySelectorAll('input[name="llm-select"]:checked')).map(el => el.value);
            let totalCost = 0;
            selected.forEach(llm => {
                const config = LLM_CONFIG[llm];
                // Estimate ~2000 input tokens, ~1500 output tokens
                totalCost += (2 * config.costPer1kInput) + (1.5 * config.costPer1kOutput);
            });
            
            const costEl = document.querySelector('#researchCostEstimate .cost-amount');
            if (costEl) {
                costEl.textContent = `~$${totalCost.toFixed(3)}`;
            }
        }
        
        function updateResearchModeUI() {
            const mode = document.querySelector('input[name="research-mode"]:checked')?.value;
            const checkboxes = document.querySelectorAll('input[name="llm-select"]');
            
            if (mode === 'compare') {
                // Enable all configured LLMs for comparison
                checkboxes.forEach(cb => {
                    if (!cb.disabled) cb.checked = true;
                });
            }
            updateResearchCostEstimate();
        }
        
        async function startMultiLLMResearch(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const selectedLLMs = Array.from(document.querySelectorAll('input[name="llm-select"]:checked')).map(el => el.value);
            const mode = document.querySelector('input[name="research-mode"]:checked')?.value || 'single';
            
            if (selectedLLMs.length === 0) {
                alert('Please select at least one AI model.');
                return;
            }
            
            closeModal('researchModal');
            
            // Lock the firm
            firm.lockedBy = currentUser;
            await saveToStorage();
            renderDashboard();
            
            if (mode === 'compare' && selectedLLMs.length > 1) {
                // Run comparison mode
                await runComparisonResearch(firm, selectedLLMs);
            } else {
                // Single mode - use first selected
                await runSingleLLMResearch(firm, selectedLLMs[0]);
            }
        }
        
        async function runSingleLLMResearch(firm, llmKey) {
            const config = LLM_CONFIG[llmKey];
            addNotification('ðŸ” Research Started', `${config.icon} ${config.name} is researching ${firm.name}...`, 'info');
            
            try {
                const result = await callLLMAPI(llmKey, firm);
                
                // Save results
                firm.researchData = {
                    ...result,
                    llmUsed: llmKey,
                    completedDate: new Date().toISOString()
                };
                firm.researchDate = new Date().toISOString();
                firm.fitScore = result.fitScore || 5;
                firm.lockedBy = null;
                
                // Store global offices separately for easy access
                if (result.globalOffices) {
                    firm.globalOffices = result.globalOffices;
                    // Update location to headquarters if found
                    if (result.globalOffices.headquarters) {
                        firm.location = result.globalOffices.headquarters;
                    }
                }
                
                // Update priority
                if (firm.fitScore >= 8) firm.priority = 'high';
                else if (firm.fitScore >= 6) firm.priority = 'medium';
                else firm.priority = 'low';
                
                budgetUsed += result.actualCost || 0;
                updateBudgetDisplay();
                await saveToStorage();
                renderDashboard();
                
                addNotification(
                    'âœ… Research Complete!',
                    `${config.icon} ${firm.name}: Found ${result.contacts?.length || 0} contacts | Fit: ${firm.fitScore}/10`,
                    'success'
                );
                
                openFirmDetails(firm);
                
            } catch (error) {
                console.error('Research error:', error);
                firm.lockedBy = null;
                await saveToStorage();
                renderDashboard();
                addNotification('âŒ Research Failed', `${config.name}: ${error.message}`, 'warning');
            }
        }
        
        async function runComparisonResearch(firm, llmKeys) {
            addNotification('ðŸ” Comparison Started', `Running ${llmKeys.length} AI models in parallel...`, 'info');
            
            // Show comparison modal with loading state
            showComparisonLoading(firm, llmKeys);
            
            // Run all LLMs in parallel
            const results = {};
            const promises = llmKeys.map(async (llmKey) => {
                const config = LLM_CONFIG[llmKey];
                try {
                    updateComparisonStatus(llmKey, 'running');
                    const result = await callLLMAPI(llmKey, firm);
                    results[llmKey] = { success: true, data: result };
                    updateComparisonStatus(llmKey, 'complete', result);
                } catch (error) {
                    results[llmKey] = { success: false, error: error.message };
                    updateComparisonStatus(llmKey, 'error', null, error.message);
                }
            });
            
            await Promise.all(promises);
            
            // Unlock firm
            firm.lockedBy = null;
            
            // Store comparison results
            firm.comparisonData = {
                results: results,
                completedDate: new Date().toISOString(),
                llmsUsed: llmKeys
            };
            
            // Calculate total cost
            let totalCost = 0;
            Object.values(results).forEach(r => {
                if (r.success && r.data?.actualCost) {
                    totalCost += r.data.actualCost;
                }
            });
            budgetUsed += totalCost;
            updateBudgetDisplay();
            
            await saveToStorage();
            renderDashboard();
            
            // Show final comparison
            showComparisonResults(firm, results);
            
            addNotification(
                'âœ… Comparison Complete!',
                `Compared ${llmKeys.length} models for ${firm.name} | Total: $${totalCost.toFixed(4)}`,
                'success'
            );
        }
        
        function showComparisonLoading(firm, llmKeys) {
            const content = `
                <div class="comparison-header">
                    <h3>${firm.name}</h3>
                    <p style="color: var(--silver);">Running ${llmKeys.length} AI models in parallel...</p>
                </div>
                <div class="comparison-grid" id="comparisonGrid">
                    ${llmKeys.map(key => {
                        const config = LLM_CONFIG[key];
                        return `
                            <div class="comparison-column" id="comparison-${key}" style="--llm-color: ${config.color}">
                                <div class="comparison-column-header">
                                    <span class="llm-icon-large">${config.icon}</span>
                                    <span class="llm-name-large">${config.name}</span>
                                    <span class="comparison-status loading" id="status-${key}">
                                        <span class="loading-spinner"></span> Researching...
                                    </span>
                                </div>
                                <div class="comparison-content" id="content-${key}">
                                    <div class="comparison-loading">
                                        <div class="loading-pulse"></div>
                                        <p>Searching the web...</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('llmComparisonContent').innerHTML = content;
            document.getElementById('llmComparisonModal').classList.add('active');
        }
        
        function updateComparisonStatus(llmKey, status, result = null, error = null) {
            const statusEl = document.getElementById(`status-${llmKey}`);
            const contentEl = document.getElementById(`content-${llmKey}`);
            
            if (status === 'running') {
                statusEl.innerHTML = '<span class="loading-spinner"></span> Researching...';
                statusEl.className = 'comparison-status loading';
            } else if (status === 'complete') {
                statusEl.innerHTML = 'âœ“ Complete';
                statusEl.className = 'comparison-status complete';
                
                if (result) {
                    contentEl.innerHTML = renderComparisonResult(result);
                }
            } else if (status === 'error') {
                statusEl.innerHTML = 'âœ— Failed';
                statusEl.className = 'comparison-status error';
                contentEl.innerHTML = `<div class="comparison-error"><p>âŒ ${error}</p></div>`;
            }
        }
        
        function renderComparisonResult(result) {
            const contacts = result.contacts || [];
            const flags = result.flags || { green: [], yellow: [], red: [] };
            
            return `
                <div class="comparison-fit-score">
                    <span class="fit-label">Fit Score</span>
                    <span class="fit-value">${result.fitScore || 'N/A'}/10</span>
                </div>
                
                <!-- Detailed Flags -->
                <div class="comparison-flags-detailed">
                    ${flags.green?.length ? `
                        <div class="flag-box-mini green">
                            <div class="flag-title-mini">ðŸŸ¢ Green Flags</div>
                            <ul class="flag-list-mini">
                                ${flags.green.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${flags.yellow?.length ? `
                        <div class="flag-box-mini yellow">
                            <div class="flag-title-mini">ðŸŸ¡ Yellow Flags</div>
                            <ul class="flag-list-mini">
                                ${flags.yellow.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${flags.red?.length ? `
                        <div class="flag-box-mini red">
                            <div class="flag-title-mini">ðŸ”´ Red Flags</div>
                            <ul class="flag-list-mini">
                                ${flags.red.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Full Reasoning -->
                <div class="comparison-section">
                    <h4>AI Fit Analysis</h4>
                    <p class="full-reasoning">${result.reasoning || 'No reasoning provided'}</p>
                </div>
                
                <!-- Detailed Contacts -->
                <div class="comparison-section">
                    <h4>Recommended Contacts (${contacts.length})</h4>
                    ${contacts.length > 0 ? contacts.map(c => `
                        <div class="contact-card-mini">
                            <div class="contact-header-mini">
                                <div class="contact-info-mini">
                                    <strong>${c.name || 'Unknown'}</strong>
                                    <span class="contact-title-mini">${c.title || ''}</span>
                                </div>
                                <div class="confidence-mini">${c.confidence || 0}%</div>
                            </div>
                            <div class="contact-details-mini">
                                ${c.email ? `<div>ðŸ“§ ${c.email} <span class="email-conf">(${c.emailConfidence || 'Unverified'})</span></div>` : ''}
                                ${c.linkedIn ? `<div>ðŸ”— <a href="${c.linkedIn}" target="_blank" style="color: var(--gold-accent);">${c.linkedIn.replace('https://linkedin.com/in/', '')}</a></div>` : ''}
                                ${c.phone ? `<div>ðŸ“ž ${c.phone}</div>` : ''}
                            </div>
                            ${c.reasoning ? `
                                <div class="contact-reasoning-mini">
                                    <strong>Why this contact?</strong>
                                    <p>${c.reasoning}</p>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') : '<p class="no-data">No contacts found</p>'}
                </div>
                
                <!-- Cost & Tokens -->
                <div class="comparison-footer">
                    <span>Cost: $${(result.actualCost || 0).toFixed(4)}</span>
                    ${result.tokensUsed ? `<span>Tokens: ${result.tokensUsed.input}â†’${result.tokensUsed.output}</span>` : ''}
                </div>
            `;
        }
        
        function showComparisonResults(firm, results) {
            // Add action buttons to select winner
            const actionsHtml = `
                <div class="comparison-actions">
                    <h4>Select Best Result to Save:</h4>
                    <div class="winner-buttons">
                        ${Object.entries(results).filter(([k, v]) => v.success).map(([key, result]) => {
                            const config = LLM_CONFIG[key];
                            return `
                                <button class="btn btn-winner" style="--llm-color: ${config.color}" 
                                    onclick="selectWinningResult('${firm.id}', '${key}')">
                                    ${config.icon} Use ${config.name} Result
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="closeModal('llmComparisonModal')">
                        Close Without Saving
                    </button>
                </div>
            `;
            
            const container = document.getElementById('llmComparisonContent');
            container.innerHTML += actionsHtml;
            
            // Store results temporarily
            window.tempComparisonResults = results;
        }
        
        async function selectWinningResult(firmId, winningLLM) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !window.tempComparisonResults) return;
            
            const result = window.tempComparisonResults[winningLLM];
            if (!result?.success) return;
            
            const config = LLM_CONFIG[winningLLM];
            
            // Save the winning result
            firm.researchData = {
                ...result.data,
                llmUsed: winningLLM,
                comparisonWinner: true,
                completedDate: new Date().toISOString()
            };
            firm.researchDate = new Date().toISOString();
            firm.fitScore = result.data.fitScore || 5;
            
            // Update priority
            if (firm.fitScore >= 8) firm.priority = 'high';
            else if (firm.fitScore >= 6) firm.priority = 'medium';
            else firm.priority = 'low';
            
            await saveToStorage();
            renderDashboard();
            
            closeModal('llmComparisonModal');
            delete window.tempComparisonResults;
            
            addNotification(
                'âœ… Result Saved',
                `${config.icon} ${config.name} result saved for ${firm.name}`,
                'success'
            );
            
            openFirmDetails(firm);
        }

        // Unified LLM API Caller
        async function callLLMAPI(llmKey, firm) {
            const config = LLM_CONFIG[llmKey];
            const apiKey = API_KEYS[llmKey];
            
            if (!apiKey) {
                throw new Error(`${config.name} API key not configured`);
            }
            
            const researchPrompt = buildResearchPrompt(firm);
            
            switch (llmKey) {
                case 'claude':
                    return await callClaudeAPI(firm, researchPrompt, apiKey);
                case 'openai':
                    return await callOpenAIAPI(firm, researchPrompt, apiKey);
                case 'deepseek':
                    return await callDeepSeekAPI(firm, researchPrompt, apiKey);
                case 'gemini':
                    return await callGeminiAPI(firm, researchPrompt, apiKey);
                default:
                    throw new Error(`Unknown LLM: ${llmKey}`);
            }
        }
        
        function buildResearchPrompt(firm) {
            return `You are researching ${firm.name} for 2iQ Research, a leading provider of alternative financial data.

**Firm Information:**
- Name: ${firm.name}
- Location: ${firm.location}
- AUM: $${firm.aum || 'Unknown'}B
- Website: ${firm.website || 'Unknown'}
- LinkedIn: ${firm.linkedIn || 'Unknown'}
- Focus: ${firm.focus || 'Unknown'}

**ABOUT 2iQ RESEARCH PRODUCTS:**
1. INSIDER DATA FEED - Global insider transaction data (60,000+ stocks, 58 countries)
2. INSIDER MODEL - Quantitative predictive model for insider activity
3. SHORT INTEREST DATA - Securities lending & short selling data
4. EUROPEAN SHORT INTEREST DATA - EU regulatory short disclosures
5. SEC FORM 144 FILINGS - Proposed sale of securities notices
6. SEC RULE 10b5-1 PLANS - Pre-arranged insider trading plans
7. GLOBAL SHARE BUYBACK DATA - Corporate repurchase data
8. CAPITOL TRADES - US politician stock disclosures

**2iQ's EXISTING CLIENTS (for context):**
Multi-strategy: Citadel, Millennium, Balyasny, Point72, Schonfeld
Quant Funds: PDT Partners, Squarepoint, Jump Trading
Event-Driven: Elliott Advisors, Tiger Global
Banks: Morgan Stanley

**YOUR TASK:**
Research this firm to find REAL, VERIFIABLE contacts, ALL GLOBAL OFFICE LOCATIONS, and evaluate fit for 2iQ's data products.

**ðŸŒ GLOBAL OFFICE LOCATIONS - IMPORTANT:**
Find ALL office locations for this firm worldwide. Many hedge funds have offices in multiple regions:
- Americas: New York, Chicago, Miami, San Francisco, Greenwich, Stamford, Toronto, etc.
- EMEA: London, Dublin, Paris, Zug, Geneva, Tel Aviv, Dubai, etc.
- APAC: Singapore, Hong Kong, Tokyo, Sydney, Mumbai, Bengaluru, etc.

Check the firm's website (especially /locations, /offices, /contact, /about pages) for office listings.
List EVERY office location you find - this is important for sales targeting.

**Target Contact Roles (in priority order):**
1. Chief Data Officer / Head of Data / Head of Alternative Data
2. Head of Quantitative Research / Quant PM
3. Director of Research / Head of Research
4. Portfolio Manager focusing on equities
5. Data Procurement / Vendor Management

**âš ï¸ CRITICAL CONTACT RULES - READ CAREFULLY:**
- ONLY include contacts you have ACTUALLY FOUND via your web search
- Every contact MUST have a LinkedIn URL that you found - if no LinkedIn URL, do not include the contact
- The LinkedIn URL proves the person is real - made up LinkedIn URLs will be obvious
- Do NOT invent names based on what "typical" executives might be named
- Do NOT guess that "a company like this probably has a John Smith as CFO"
- If you cannot find specific named individuals, return an EMPTY contacts array - that is better than fake names
- In the reasoning field, state EXACTLY where you found this person (e.g., "Found on LinkedIn", "Listed on company About page", "Mentioned in press release dated X")

**Research Areas:**
- Key decision-makers for data purchases
- Recent news, performance, hiring signals
- Evidence of alternative data usage
- Investment strategy fit (quant, event-driven, long/short equity = GOOD FIT)
- Red flags (layoffs, poor performance, closures, crypto-only, VC)
- Green flags (growth, hiring quant roles, strong returns, similar to 2iQ clients)

**EMAIL PATTERN MATCHING:**
If you found a REAL person with a REAL LinkedIn profile:
1. Determine the company's email pattern (firstname.lastname@, flastname@, etc.)
2. Construct their email based on the pattern
3. Mark as "Pattern Match" 
4. Only mark as "Verified" if you found their email published somewhere

**WHAT TO AVOID:**
- Inventing names like "John Smith", "Sarah Johnson", "Michael Brown"
- Generic names that sound plausible but you didn't actually find
- LinkedIn URLs that look made up (they should be real URLs you found)
- If you're not sure a person exists at this firm, DO NOT include them

**âš ï¸ REFLECTION STEP - BEFORE RETURNING:**
Before you finalize your response, verify each contact:
1. Did I actually find this person's name in my search results? (Not guessed)
2. Is the LinkedIn URL real and from my search results? (Not constructed)
3. Is this person's job title related to DATA BUYING or QUANTITATIVE RESEARCH?
4. Would this person realistically be a BUYER of financial data products?

If ANY contact fails these checks, REMOVE them from your response. 
It's better to return 0-2 verified contacts than 5 fake ones.

**IDEAL CONTACTS (in order of priority):**
- Head of Alternative Data / Data Procurement â†’ They BUY data
- Chief Data Officer / Head of Data â†’ They DECIDE on data purchases
- Quant Researcher / PM â†’ They USE the data
- Do NOT include: IT admins, general developers, HR, marketing, or junior analysts

**Return ONLY this JSON structure (no markdown, no explanation):**
{
  "contacts": [
    {
      "name": "Full Name (ONLY if you actually found this person)",
      "title": "Job Title",
      "email": "pattern_matched@email.com or null",
      "emailConfidence": "Verified|Pattern Match|Unverified",
      "phone": "phone or null",
      "linkedIn": "REQUIRED - actual LinkedIn URL you found, or do not include this contact",
      "confidence": 60-95,
      "reasoning": "MUST state where you found this person - e.g., 'Found on LinkedIn profile at [URL]' or 'Listed on company team page'"
    }
  ],
  "globalOffices": {
    "headquarters": "City, Country",
    "americas": ["New York", "Miami", "Chicago"],
    "emea": ["London", "Dublin", "Paris"],
    "apac": ["Singapore", "Hong Kong", "Tokyo"]
  },
  "fitScore": 1-10,
  "flags": {
    "green": ["positive findings - growth, hiring, quant focus, similar to 2iQ clients"],
    "yellow": ["neutral findings - unknown strategy, limited info"],
    "red": ["negative findings - crypto focus, VC, layoffs, no equity exposure"]
  },
  "reasoning": "Overall assessment of fit for 2iQ products and which products they'd likely want"
}`;
        }
        
        // Claude API
        // Claude API - Uses local proxy to avoid CORS
        async function callClaudeAPI(firm, prompt, apiKey) {
            const response = await fetch("http://localhost:8001", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": apiKey,
                    "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 4000,
                    tools: [{
                        "type": "web_search_20250305",
                        "name": "web_search"
                    }],
                    messages: [{ role: "user", content: prompt }]
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || 'Claude API request failed. Make sure proxy server is running on port 8001.');
            }

            const data = await response.json();
            
            // Extract text from response (may have multiple blocks with web search)
            let researchText = '';
            for (const block of data.content) {
                if (block.type === 'text') {
                    researchText += block.text;
                }
            }
            
            const result = parseResearchResponse(researchText);
            
            // Calculate cost (Sonnet pricing)
            const inputTokens = data.usage?.input_tokens || 0;
            const outputTokens = data.usage?.output_tokens || 0;
            result.actualCost = (inputTokens * 0.000003) + (outputTokens * 0.000015);
            result.tokensUsed = { input: inputTokens, output: outputTokens };
            
            return result;
        }
        
        // OpenAI API
        async function callOpenAIAPI(firm, prompt, apiKey) {
            // Add explicit JSON instruction
            const jsonPrompt = prompt + '\n\nIMPORTANT: Return ONLY valid JSON. No markdown, no code fences, no explanation.';
            
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o",
                    max_tokens: 4000,
                    response_format: { type: "json_object" },
                    messages: [
                        { role: "system", content: "You are a research assistant. Return only valid JSON with no markdown formatting." },
                        { role: "user", content: jsonPrompt }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('OpenAI API error:', error);
                throw new Error(error.error?.message || 'OpenAI API request failed');
            }

            const data = await response.json();
            const researchText = data.choices[0]?.message?.content || '';
            
            console.log('ðŸŸ¢ OpenAI raw response:', researchText?.substring(0, 500));
            
            const result = parseResearchResponse(researchText);
            
            // Calculate cost (GPT-4o pricing)
            const inputTokens = data.usage?.prompt_tokens || 0;
            const outputTokens = data.usage?.completion_tokens || 0;
            result.actualCost = (inputTokens * 0.000005) + (outputTokens * 0.000015);
            result.tokensUsed = { input: inputTokens, output: outputTokens };
            
            return result;
        }
        
        // DeepSeek API
        async function callDeepSeekAPI(firm, prompt, apiKey) {
            // Add explicit JSON instruction
            const jsonPrompt = prompt + '\n\nIMPORTANT: Return ONLY valid JSON. No markdown, no code fences, no explanation.';
            
            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    max_tokens: 4000,
                    messages: [
                        { role: "system", content: "You are a research assistant. Return only valid JSON with no markdown formatting." },
                        { role: "user", content: jsonPrompt }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('DeepSeek API error:', error);
                throw new Error(error.error?.message || 'DeepSeek API request failed');
            }

            const data = await response.json();
            const researchText = data.choices[0]?.message?.content || '';
            
            console.log('ðŸ”µ DeepSeek raw response:', researchText?.substring(0, 500));
            
            const result = parseResearchResponse(researchText);
            
            // Calculate cost (DeepSeek pricing - very cheap)
            const inputTokens = data.usage?.prompt_tokens || 0;
            const outputTokens = data.usage?.completion_tokens || 0;
            result.actualCost = (inputTokens * 0.00000014) + (outputTokens * 0.00000028);
            result.tokensUsed = { input: inputTokens, output: outputTokens };
            
            return result;
        }
        
        // Gemini API
        async function callGeminiAPI(firm, prompt, apiKey) {
            // Add explicit JSON instruction to prompt
            const jsonPrompt = prompt + '\n\nIMPORTANT: Return ONLY the JSON object. No markdown, no explanation, no code fences. Start with { and end with }';
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: jsonPrompt }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 4000,
                        temperature: 0.7
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('Gemini API error:', error);
                throw new Error(error.error?.message || 'Gemini API request failed');
            }

            const data = await response.json();
            const researchText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            
            console.log('ðŸŸ¡ Gemini raw response:', researchText?.substring(0, 800));
            
            const result = parseResearchResponse(researchText);
            
            // Gemini 2.0 Flash is free during experimental period
            const inputTokens = data.usageMetadata?.promptTokenCount || 2000;
            const outputTokens = data.usageMetadata?.candidatesTokenCount || 1500;
            result.actualCost = 0; // Free during experimental
            result.tokensUsed = { input: inputTokens, output: outputTokens };
            
            return result;
        }
        
        // ============================================
        // APOLLO.IO API INTEGRATION
        // ============================================
        
        // Search for people at a company using Apollo
        async function apolloSearchPeople(companyName, titles = []) {
            if (!SEARCH_API.apolloKey) {
                throw new Error('Apollo API key not configured. Add it in Settings.');
            }
            
            // Default titles to search for if none provided
            const searchTitles = titles.length > 0 ? titles : [
                'Head of Data', 'Chief Data Officer', 'Head of Alternative Data',
                'Head of Quantitative Research', 'Quant PM', 'Portfolio Manager',
                'Director of Research', 'Data Procurement', 'Vendor Management'
            ];
            
            console.log('ðŸš€ Apollo: Searching for people at', companyName);
            
            try {
                // Route through proxy to bypass CORS
                const response = await fetch('http://localhost:8001/apollo/mixed_people', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: SEARCH_API.apolloKey,
                        q_organization_name: companyName,
                        person_titles: searchTitles,
                        page: 1,
                        per_page: 25  // Get more results to filter from
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.message || `Apollo API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ðŸš€ Apollo response:', data);
                
                // Transform Apollo response to our contact format
                const allContacts = (data.people || []).map(person => {
                    // Properly construct name from first_name and last_name
                    let fullName = person.name;
                    if (!fullName || fullName.includes('undefined')) {
                        const firstName = person.first_name || '';
                        const lastName = person.last_name || '';
                        fullName = `${firstName} ${lastName}`.trim();
                    }
                    
                    // Normalize title for deduplication
                    const normalizedTitle = (person.title || 'Unknown').toLowerCase().trim();
                    
                    return {
                        name: fullName || 'Unknown',
                        title: person.title || 'Unknown',
                        normalizedTitle: normalizedTitle,
                        email: person.email || null,
                        emailConfidence: person.email ? (person.email_status === 'verified' ? 'Verified' : 'Pattern Match') : 'Unverified',
                        phone: person.phone_numbers?.[0]?.sanitized_number || null,
                        linkedIn: person.linkedin_url || null,
                        confidence: person.email ? 90 : 70,
                        reasoning: `Found via Apollo.io - ${person.title || 'Unknown'} at ${person.organization?.name || companyName}`,
                        source: 'Apollo.io',
                        apolloId: person.id
                    };
                });
                
                // Deduplicate by first name + job category - keep only one person per role type
                const seenFirstNames = new Set();
                const contacts = [];
                for (const contact of allContacts) {
                    // Get first name for deduplication
                    const firstName = (contact.name || '').split(' ')[0].toLowerCase().trim();
                    
                    // Skip if we already have someone with this first name (likely same person)
                    if (firstName && seenFirstNames.has(firstName)) continue;
                    
                    // Skip contacts with no name
                    if (!contact.name || contact.name === 'Unknown' || contact.name.trim() === '') continue;
                    
                    if (firstName) seenFirstNames.add(firstName);
                    contacts.push(contact);
                    
                    // Stop after 5 unique contacts
                    if (contacts.length >= 5) break;
                }
                
                // Remove the normalizedTitle helper field
                contacts.forEach(c => delete c.normalizedTitle);
                
                return {
                    contacts,
                    company: data.organization || null,
                    totalFound: data.pagination?.total_entries || contacts.length,
                    creditsUsed: contacts.length // Apollo charges per contact revealed
                };
                
            } catch (error) {
                console.error('ðŸš€ Apollo error:', error);
                throw error;
            }
        }
        
        // Enrich a specific person by name and company
        async function apolloEnrichPerson(name, companyName, domain = null, apolloId = null) {
            if (!SEARCH_API.apolloKey) {
                throw new Error('Apollo API key not configured');
            }
            
            console.log('ðŸš€ Apollo: Enriching', name, 'at', companyName);
            
            try {
                // Build request body
                const requestBody = {
                    api_key: SEARCH_API.apolloKey,
                    reveal_personal_emails: true  // Request email reveal
                };
                
                // If we have Apollo ID from search, use it for better matching
                if (apolloId) {
                    requestBody.id = apolloId;
                } else {
                    // Otherwise use name and organization
                    requestBody.name = name;
                    requestBody.organization_name = companyName;
                    if (domain) requestBody.domain = domain;
                }
                
                // Route through proxy to bypass CORS
                const response = await fetch('http://localhost:8001/apollo/people/match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.message || `Apollo API error: ${response.status}`);
                }
                
                const data = await response.json();
                const person = data.person;
                
                if (!person) {
                    return null;
                }
                
                // Construct proper name
                let fullName = person.name;
                if (!fullName || fullName.includes('undefined')) {
                    const firstName = person.first_name || '';
                    const lastName = person.last_name || '';
                    fullName = `${firstName} ${lastName}`.trim();
                }
                
                return {
                    name: fullName || name,
                    title: person.title || 'Unknown',
                    email: person.email || null,
                    emailConfidence: person.email ? (person.email_status === 'verified' ? 'Verified' : 'Pattern Match') : 'Unverified',
                    phone: person.phone_numbers?.[0]?.sanitized_number || person.mobile_phone || null,
                    linkedIn: person.linkedin_url || null,
                    confidence: person.email ? 95 : 75,
                    reasoning: `Enriched via Apollo.io - verified contact`,
                    source: 'Apollo.io',
                    apolloId: person.id
                };
                
            } catch (error) {
                console.error('ðŸš€ Apollo enrich error:', error);
                return null;
            }
        }
        
        // Search for company/organization info
        async function apolloSearchCompany(companyName) {
            if (!SEARCH_API.apolloKey) {
                throw new Error('Apollo API key not configured');
            }
            
            console.log('ðŸš€ Apollo: Searching company', companyName);
            
            try {
                // Route through proxy to bypass CORS
                const response = await fetch('http://localhost:8001/apollo/organizations/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: SEARCH_API.apolloKey,
                        q_organization_name: companyName,
                        page: 1,
                        per_page: 5
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Apollo API error: ${response.status}`);
                }
                
                const data = await response.json();
                const org = data.organizations?.[0];
                
                if (!org) return null;
                
                return {
                    name: org.name,
                    domain: org.primary_domain,
                    industry: org.industry,
                    employeeCount: org.estimated_num_employees,
                    location: org.raw_address || `${org.city}, ${org.country}`,
                    linkedIn: org.linkedin_url,
                    website: org.website_url,
                    description: org.short_description,
                    apolloId: org.id
                };
                
            } catch (error) {
                console.error('ðŸš€ Apollo company search error:', error);
                return null;
            }
        }
        
        // Main function to enrich a firm with Apollo data
        async function enrichWithApollo(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            if (!SEARCH_API.apolloKey) {
                alert('Apollo API key not configured. Please add it in Settings (âš™ï¸).');
                return;
            }
            
            // Check if firm has been researched with contacts
            if (!firm.researchData || !firm.researchData.contacts || firm.researchData.contacts.length === 0) {
                alert('Please research this firm first with AI to find contact names. Apollo will then verify and enrich those contacts.\n\nOr use "Search with Apollo" to find contacts directly.');
                return;
            }
            
            // Show loading modal
            document.getElementById('firmDetailsModal').classList.remove('active');
            
            // Create a simple loading overlay
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'apolloLoadingOverlay';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: var(--navy-card); padding: 2rem; border-radius: 12px; text-align: center; max-width: 400px;">
                        <div class="loading"></div>
                        <h3 style="color: var(--gold-accent); margin: 1rem 0;">ðŸš€ Verifying with Apollo</h3>
                        <p style="color: var(--silver);">Verifying ${firm.researchData.contacts.length} contacts at ${firm.name}...</p>
                        <p style="color: var(--silver); font-size: 0.8rem; margin-top: 1rem;">This uses Apollo credits for each verified contact</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Get company domain from website if available
                let domain = null;
                if (firm.website) {
                    try {
                        domain = new URL(firm.website.startsWith('http') ? firm.website : 'https://' + firm.website).hostname.replace('www.', '');
                    } catch (e) {}
                }
                
                // Enrich each contact found by LLM
                const enrichedContacts = [];
                let creditsUsed = 0;
                
                for (const contact of firm.researchData.contacts) {
                    if (!contact.name) continue;
                    
                    console.log(`ðŸš€ Apollo: Enriching ${contact.name} at ${firm.name}`);
                    
                    try {
                        const enriched = await apolloEnrichPerson(contact.name, firm.name, domain);
                        
                        if (enriched && enriched.email) {
                            // Merge Apollo data with existing contact data
                            enrichedContacts.push({
                                ...contact,
                                email: enriched.email || contact.email,
                                emailConfidence: enriched.email ? 'Verified' : contact.emailConfidence,
                                phone: enriched.phone || contact.phone,
                                linkedIn: enriched.linkedIn || contact.linkedIn,
                                title: enriched.title || contact.title,
                                confidence: enriched.email ? 95 : contact.confidence,
                                source: 'Apollo.io',
                                apolloVerified: true
                            });
                            creditsUsed++;
                        } else {
                            // Keep original contact if Apollo couldn't find them
                            enrichedContacts.push({
                                ...contact,
                                apolloVerified: false
                            });
                        }
                    } catch (err) {
                        console.log(`âš ï¸ Apollo couldn't verify ${contact.name}:`, err.message);
                        enrichedContacts.push(contact);
                    }
                    
                    // Small delay between requests to avoid rate limiting
                    await new Promise(r => setTimeout(r, 300));
                }
                
                // Remove loading overlay
                document.getElementById('apolloLoadingOverlay')?.remove();
                
                // Update firm with enriched contacts
                firm.researchData.contacts = enrichedContacts;
                firm.apolloData = {
                    enrichedDate: new Date().toISOString(),
                    creditsUsed: creditsUsed,
                    totalContacts: enrichedContacts.length,
                    verifiedContacts: enrichedContacts.filter(c => c.apolloVerified).length
                };
                
                const verifiedCount = enrichedContacts.filter(c => c.apolloVerified).length;
                
                if (verifiedCount > 0) {
                    firm.researchData.flags.green.push(`${verifiedCount} contacts verified by Apollo.io`);
                    addNotification('ðŸš€ Apollo Enrichment Complete', `Verified ${verifiedCount} of ${enrichedContacts.length} contacts at ${firm.name}`, 'success');
                } else {
                    addNotification('âš ï¸ No Matches', `Apollo couldn't verify contacts at ${firm.name}. Try "Search with Apollo" instead.`, 'warning');
                }
                
                await saveToStorage();
                
                // Refresh the firm details view
                openFirmDetails(firm);
                
            } catch (error) {
                document.getElementById('apolloLoadingOverlay')?.remove();
                addNotification('âŒ Apollo Error', error.message, 'error');
                openFirmDetails(firm);
            }
        }
        
        // Search for contacts DIRECTLY using Apollo (not just verify)
        async function searchWithApollo(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            if (!SEARCH_API.apolloKey) {
                alert('Apollo API key not configured. Please add it in Settings (âš™ï¸).');
                return;
            }
            
            // Check if Apollo was already searched for this company
            if (firm.apolloSearchHistory && firm.apolloSearchHistory.length > 0) {
                const lastSearch = firm.apolloSearchHistory[firm.apolloSearchHistory.length - 1];
                const lastSearchDate = new Date(lastSearch.date);
                const hoursSinceSearch = (Date.now() - lastSearchDate.getTime()) / (1000 * 60 * 60);
                const daysSinceSearch = Math.floor(hoursSinceSearch / 24);
                
                // Format time string
                let timeAgo;
                if (hoursSinceSearch < 1) {
                    timeAgo = `${Math.floor(hoursSinceSearch * 60)} minutes ago`;
                } else if (hoursSinceSearch < 24) {
                    timeAgo = `${Math.floor(hoursSinceSearch)} hours ago`;
                } else {
                    timeAgo = `${daysSinceSearch} day${daysSinceSearch > 1 ? 's' : ''} ago`;
                }
                
                // Always warn if searched within last 7 days
                if (hoursSinceSearch < 168) { // 7 days = 168 hours
                    const warningMessage = lastSearch.contactsFound === 0 
                        ? `âš ï¸ APOLLO SEARCH WARNING\n\n` +
                          `This company was already searched on Apollo:\n\n` +
                          `ðŸ“… Date: ${lastSearchDate.toLocaleDateString()} at ${lastSearchDate.toLocaleTimeString()}\n` +
                          `â±ï¸ Time: ${timeAgo}\n` +
                          `ðŸ‘¤ By: ${lastSearch.user || 'Unknown'}\n` +
                          `ðŸ“Š Result: NO CONTACTS FOUND\n\n` +
                          `âŒ Apollo did not have contacts for this company.\n` +
                          `Searching again will likely return the same result and waste credits.\n\n` +
                          `Do you still want to search? (Uses API credits)`
                        : `âš ï¸ APOLLO SEARCH WARNING\n\n` +
                          `This company was already searched on Apollo:\n\n` +
                          `ðŸ“… Date: ${lastSearchDate.toLocaleDateString()} at ${lastSearchDate.toLocaleTimeString()}\n` +
                          `â±ï¸ Time: ${timeAgo}\n` +
                          `ðŸ‘¤ By: ${lastSearch.user || 'Unknown'}\n` +
                          `ðŸ“Š Result: ${lastSearch.contactsFound} contacts found\n\n` +
                          `ðŸ’¡ TIP: Use "Add Contact" to search for a specific person instead.\n` +
                          `This uses fewer credits than a full company search.\n\n` +
                          `Do you still want to search the whole company again? (Uses API credits)`;
                    
                    if (!confirm(warningMessage)) {
                        return;
                    }
                }
            }
            
            // Show loading modal
            document.getElementById('firmDetailsModal').classList.remove('active');
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'apolloLoadingOverlay';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: var(--navy-card); padding: 2rem; border-radius: 12px; text-align: center; max-width: 400px;">
                        <div class="loading"></div>
                        <h3 style="color: var(--gold-accent); margin: 1rem 0;">ðŸš€ Searching Apollo Database</h3>
                        <p style="color: var(--silver);" id="apolloSearchStatus">Finding quants, data scientists & analysts at ${firm.name}...</p>
                        <p style="color: var(--silver); font-size: 0.8rem; margin-top: 1rem;">Searching for decision-makers</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Target job titles for 2iQ data products - these are the BUYERS of financial data
                // Priority: Data procurement, Alt Data heads, Quant researchers who need data
                const targetTitles = [
                    // Primary targets - Data buyers/procurement
                    'Head of Alternative Data',
                    'Director of Alternative Data', 
                    'Head of Data',
                    'Chief Data Officer',
                    'Data Procurement',
                    'Director of Data Acquisition',
                    'VP Alternative Data',
                    
                    // Secondary - Quant researchers who consume data
                    'Head of Quantitative Research',
                    'Director of Quantitative Research',
                    'Quantitative Research Analyst',
                    'Senior Quant Researcher',
                    
                    // Decision makers
                    'Portfolio Manager',
                    'Quantitative Portfolio Manager',
                    'Head of Systematic Strategies',
                    
                    // Technical implementers
                    'Head of Data Engineering',
                    'Quantitative Developer'
                ];
                
                const result = await apolloSearchPeople(firm.name, targetTitles);
                
                // Initialize Apollo search history
                if (!firm.apolloSearchHistory) {
                    firm.apolloSearchHistory = [];
                }
                
                // Record this search
                const searchRecord = {
                    date: new Date().toISOString(),
                    user: currentSession?.user?.username || currentUser || 'unknown',
                    contactsFound: result.contacts.length,
                    titlesSearched: targetTitles.length,
                    searchType: 'company'
                };
                firm.apolloSearchHistory.push(searchRecord);
                
                if (result.contacts.length === 0) {
                    document.getElementById('apolloLoadingOverlay')?.remove();
                    
                    // Save the search record even with no results
                    await saveToStorage();
                    
                    addNotification('âš ï¸ No contacts found', `Apollo couldn't find matching contacts at ${firm.name}. Search recorded.`, 'warning');
                    openFirmDetails(firm);
                    return;
                }
                
                // Update status - now enriching to get emails
                const statusEl = document.getElementById('apolloSearchStatus');
                if (statusEl) {
                    statusEl.textContent = `Found ${result.contacts.length} contacts. Getting emails...`;
                }
                
                // Get company domain for enrichment
                let domain = null;
                if (firm.website) {
                    try {
                        domain = new URL(firm.website.startsWith('http') ? firm.website : 'https://' + firm.website).hostname.replace('www.', '');
                    } catch (e) {}
                }
                
                // Enrich each contact to get their email
                const enrichedContacts = [];
                for (const contact of result.contacts) {
                    if (!contact.name) continue;
                    
                    try {
                        // Try to enrich to get email - pass apolloId for better matching
                        const enriched = await apolloEnrichPerson(contact.name, firm.name, domain, contact.apolloId);
                        
                        if (enriched && enriched.email) {
                            enrichedContacts.push({
                                ...contact,
                                name: enriched.name || contact.name,
                                email: enriched.email,
                                emailConfidence: 'Verified',
                                phone: enriched.phone || contact.phone,
                                linkedIn: enriched.linkedIn || contact.linkedIn,
                                confidence: 95,
                                source: 'Apollo.io',
                                apolloVerified: true
                            });
                        } else {
                            // Keep contact even without email
                            enrichedContacts.push({
                                ...contact,
                                source: 'Apollo.io',
                                apolloVerified: false
                            });
                        }
                    } catch (err) {
                        console.log(`âš ï¸ Couldn't enrich ${contact.name}:`, err.message);
                        enrichedContacts.push({
                            ...contact,
                            source: 'Apollo.io',
                            apolloVerified: false
                        });
                    }
                    
                    // Rate limiting
                    await new Promise(r => setTimeout(r, 300));
                }
                
                document.getElementById('apolloLoadingOverlay')?.remove();
                
                // Initialize research data if needed
                if (!firm.researchData) {
                    firm.researchData = {
                        contacts: [],
                        fitScore: 7,
                        flags: { green: [], yellow: [], red: [] },
                        reasoning: 'Contacts discovered via Apollo.io search'
                    };
                }
                
                // Smart deduplication - match by first name + similar title
                // Apollo verified contacts should replace LLM-found contacts
                const existingContacts = firm.researchData.contacts || [];
                const newContacts = [];
                
                for (const apolloContact of enrichedContacts) {
                    const apolloFirstName = (apolloContact.name || '').split(' ')[0].toLowerCase().trim();
                    const apolloTitle = (apolloContact.title || '').toLowerCase().trim();
                    
                    // Find matching existing contact (same first name AND similar title)
                    const matchIndex = existingContacts.findIndex(existing => {
                        const existingFirstName = (existing.name || '').split(' ')[0].toLowerCase().trim();
                        const existingTitle = (existing.title || '').toLowerCase().trim();
                        
                        // Match if first names are the same and titles are similar
                        const firstNameMatch = apolloFirstName && existingFirstName && 
                                               apolloFirstName === existingFirstName;
                        const titleMatch = apolloTitle && existingTitle && 
                                          (apolloTitle.includes(existingTitle) || 
                                           existingTitle.includes(apolloTitle) ||
                                           apolloTitle === existingTitle);
                        
                        return firstNameMatch && titleMatch;
                    });
                    
                    if (matchIndex >= 0) {
                        // Found a match - replace if Apollo contact has verified email
                        if (apolloContact.apolloVerified && apolloContact.email) {
                            console.log(`ðŸ”„ Replacing LLM contact "${existingContacts[matchIndex].name}" with Apollo contact "${apolloContact.name}"`);
                            existingContacts.splice(matchIndex, 1); // Remove LLM contact
                            newContacts.push(apolloContact); // Add Apollo contact
                        }
                        // If Apollo doesn't have email but LLM does, keep LLM contact (do nothing)
                    } else {
                        // No match found - add as new contact
                        newContacts.push(apolloContact);
                    }
                }
                
                // Add new contacts at the beginning, keeping remaining existing contacts
                firm.researchData.contacts = [...newContacts, ...existingContacts];
                
                const verifiedCount = newContacts.filter(c => c.apolloVerified).length;
                firm.researchData.flags.green.push(`${newContacts.length} contacts from Apollo (${verifiedCount} verified emails)`);
                
                firm.apolloData = {
                    searchDate: new Date().toISOString(),
                    contactsFound: result.contacts.length,
                    totalFound: result.totalFound || result.contacts.length,
                    newContactsAdded: newContacts.length,
                    emailsVerified: verifiedCount,
                    currentPage: 1
                };
                firm.researchDate = new Date().toISOString();
                
                await saveToStorage();
                
                addNotification('ðŸš€ Apollo Search Complete', `Found ${newContacts.length} contacts (${verifiedCount} with emails) at ${firm.name}`, 'success');
                openFirmDetails(firm);
                
            } catch (error) {
                document.getElementById('apolloLoadingOverlay')?.remove();
                addNotification('âŒ Apollo Search Error', error.message, 'error');
                openFirmDetails(firm);
            }
        }
        
        // Show more contacts (pagination - no API call needed)
        function showMoreContacts(firmId, totalContacts) {
            const container = document.getElementById('contactsContainer');
            if (!container) return;
            
            // Show all hidden contact cards
            const hiddenCards = container.querySelectorAll('.contact-item[style*="display: none"]');
            hiddenCards.forEach(card => {
                card.style.display = '';
            });
            
            // Update the count display
            const countSpan = document.getElementById('contactsShowing');
            if (countSpan) {
                countSpan.textContent = totalContacts;
            }
            
            // Toggle buttons
            const showMoreBtn = document.getElementById('showMoreContactsBtn');
            const showLessBtn = document.getElementById('showLessContactsBtn');
            if (showMoreBtn) showMoreBtn.style.display = 'none';
            if (showLessBtn) showLessBtn.style.display = 'inline-block';
            
            addNotification('ðŸ‘ï¸ Showing All', `Now displaying all ${totalContacts} contacts`, 'info');
        }
        
        // Show less contacts (collapse back to 5)
        function showLessContacts(firmId) {
            const container = document.getElementById('contactsContainer');
            if (!container) return;
            
            // Hide contacts beyond index 4 (keep first 5)
            const allCards = container.querySelectorAll('.contact-item');
            let visibleCount = 0;
            allCards.forEach((card, idx) => {
                if (idx >= 5) {
                    card.style.display = 'none';
                } else {
                    card.style.display = '';
                    visibleCount++;
                }
            });
            
            // Update the count display
            const countSpan = document.getElementById('contactsShowing');
            if (countSpan) {
                countSpan.textContent = visibleCount;
            }
            
            // Toggle buttons
            const showMoreBtn = document.getElementById('showMoreContactsBtn');
            const showLessBtn = document.getElementById('showLessContactsBtn');
            if (showMoreBtn) showMoreBtn.style.display = 'inline-block';
            if (showLessBtn) showLessBtn.style.display = 'none';
            
            // Scroll to top of contacts section
            const heading = document.querySelector('.preview-heading');
            if (heading) {
                heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Delete a contact from a firm
        async function deleteContact(firmId, contactIndex) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.researchData || !firm.researchData.contacts) return;
            
            const contact = firm.researchData.contacts[contactIndex];
            if (!contact) return;
            
            // Confirm deletion
            if (!confirm(`Remove ${contact.name} from contacts?`)) return;
            
            // Remove the contact
            firm.researchData.contacts.splice(contactIndex, 1);
            await saveToStorage();
            
            addNotification('ðŸ—‘ï¸ Contact Removed', `${contact.name} has been removed`, 'info');
            
            // Refresh the view
            openFirmDetails(firm);
        }
        
        // ============================================
        // ADD CONTACT WITH APOLLO RESEARCH
        // ============================================
        
        function openAddContactModal(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const apolloAvailable = !!SEARCH_API.apolloKey;
            
            // Check if we've searched this person before (show last search info)
            let lastSearchInfo = '';
            if (firm.apolloSearchHistory && firm.apolloSearchHistory.length > 0) {
                const lastSearch = firm.apolloSearchHistory[firm.apolloSearchHistory.length - 1];
                const searchDate = new Date(lastSearch.date);
                lastSearchInfo = `
                    <div style="background: rgba(69, 123, 157, 0.1); border: 1px solid rgba(69, 123, 157, 0.3); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.8rem;">
                        <div style="color: var(--blue-info);">â„¹ï¸ Last Apollo company search: ${searchDate.toLocaleDateString()} at ${searchDate.toLocaleTimeString()}</div>
                        <div style="color: var(--silver);">By: ${lastSearch.user || 'Unknown'} | Found: ${lastSearch.contactsFound || 0} contacts</div>
                    </div>
                `;
            }
            
            document.getElementById('addContactModalContent').innerHTML = `
                ${lastSearchInfo}
                <form id="addContactForm" onsubmit="submitAddContact(event, '${firmId}')">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Contact Name *</label>
                        <input type="text" id="newContactName" required placeholder="e.g., John Smith"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Job Title (helps Apollo find the right person)</label>
                        <input type="text" id="newContactTitle" placeholder="e.g., Head of Data, Portfolio Manager"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Email (optional - Apollo will try to find it)</label>
                        <input type="email" id="newContactEmail" placeholder="john.smith@company.com"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">LinkedIn URL (optional)</label>
                        <input type="url" id="newContactLinkedIn" placeholder="https://linkedin.com/in/johnsmith"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: ${apolloAvailable ? 'rgba(126, 87, 194, 0.15)' : 'rgba(100,100,100,0.1)'}; border: 1px solid ${apolloAvailable ? 'rgba(126, 87, 194, 0.3)' : 'transparent'}; border-radius: 6px;">
                        <input type="checkbox" id="enrichWithApollo" ${apolloAvailable ? 'checked' : 'disabled'}>
                        <label for="enrichWithApollo" style="color: ${apolloAvailable ? 'var(--white)' : 'var(--silver)'}; opacity: ${apolloAvailable ? '1' : '0.5'};">
                            ðŸš€ Search Apollo for this person (1 API credit)
                        </label>
                        ${!apolloAvailable ? '<span style="color: var(--yellow-flag); font-size: 0.75rem; margin-left: auto;">Apollo key not set</span>' : ''}
                    </div>
                    <p style="color: var(--silver); font-size: 0.75rem; margin-bottom: 1rem; opacity: 0.8;">
                        ðŸ’¡ Apollo will search for this specific person at ${firm.name} and return their verified email & LinkedIn if found.
                    </p>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn" style="flex: 1;">âž• Add Contact</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
                    </div>
                </form>
            `;
            
            document.getElementById('addContactModal').querySelector('.modal-title').textContent = `âž• Add Contact to ${firm.name}`;
            document.getElementById('addContactModal').classList.add('active');
        }
        
        async function submitAddContact(event, firmId) {
            event.preventDefault();
            
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const name = document.getElementById('newContactName').value.trim();
            const title = document.getElementById('newContactTitle').value.trim();
            const email = document.getElementById('newContactEmail').value.trim();
            const linkedIn = document.getElementById('newContactLinkedIn').value.trim();
            const enrichWithApollo = document.getElementById('enrichWithApollo')?.checked && SEARCH_API.apolloKey;
            
            if (!name) {
                alert('Contact name is required');
                return;
            }
            
            // Check if contact already exists
            if (firm.researchData?.contacts) {
                const existingContact = firm.researchData.contacts.find(c => 
                    c.name.toLowerCase().trim() === name.toLowerCase().trim()
                );
                if (existingContact) {
                    if (!confirm(`âš ï¸ "${name}" already exists in contacts.\n\nDo you want to add them again?`)) {
                        return;
                    }
                }
            }
            
            // Initialize research data if needed
            if (!firm.researchData) {
                firm.researchData = {
                    contacts: [],
                    fitScore: 5,
                    flags: { green: [], yellow: [], red: [] },
                    reasoning: 'No AI research yet'
                };
            }
            
            // Create base contact
            let newContact = {
                name: name,
                title: title || 'Unknown',
                email: email || null,
                emailConfidence: email ? 'Manual Entry' : 'Unknown',
                linkedIn: linkedIn || null,
                phone: null,
                confidence: email ? 60 : 40,
                reasoning: `Manually added by ${currentUser} on ${new Date().toLocaleDateString()}`,
                source: 'Manual',
                addedBy: currentUser,
                addedDate: new Date().toISOString()
            };
            
            closeModal('addContactModal');
            
            // If Apollo enrichment requested - search for THIS SPECIFIC PERSON
            if (enrichWithApollo) {
                // Show loading overlay
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'addContactLoadingOverlay';
                loadingDiv.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                        <div style="background: var(--navy-rich); padding: 2rem; border-radius: 12px; text-align: center; max-width: 450px; border: 1px solid rgba(212, 165, 116, 0.3);">
                            <div class="loading"></div>
                            <h3 style="color: var(--gold-accent); margin: 1rem 0;">ðŸš€ Searching Apollo</h3>
                            <p style="color: var(--white); font-size: 1.1rem;">Looking up <strong>"${name}"</strong></p>
                            <p style="color: var(--silver);">at ${firm.name}</p>
                            <p style="color: var(--silver); font-size: 0.8rem; margin-top: 1rem;">Searching for verified email & LinkedIn...</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingDiv);
                
                try {
                    // Get company domain
                    let domain = null;
                    if (firm.website) {
                        try {
                            domain = new URL(firm.website.startsWith('http') ? firm.website : 'https://' + firm.website)
                                .hostname.replace('www.', '');
                        } catch (e) {}
                    }
                    
                    // Search Apollo for this SPECIFIC person (single person lookup)
                    const enriched = await apolloEnrichPerson(name, firm.name, domain);
                    
                    // Remove loading overlay
                    document.getElementById('addContactLoadingOverlay')?.remove();
                    
                    if (enriched && enriched.email) {
                        // SUCCESS - Found person with email
                        newContact = {
                            ...newContact,
                            name: enriched.name || name,
                            title: enriched.title || title || 'Unknown',
                            email: enriched.email,
                            emailConfidence: 'Verified',
                            linkedIn: enriched.linkedIn || linkedIn || null,
                            phone: enriched.phone || null,
                            confidence: 95,
                            reasoning: `Found via Apollo.io - ${enriched.title || 'Contact'} at ${firm.name}`,
                            source: 'Apollo.io',
                            apolloVerified: true,
                            apolloId: enriched.apolloId,
                            apolloSearchDate: new Date().toISOString(),
                            apolloSearchBy: currentUser
                        };
                        
                        addNotification('âœ… Contact Found!', `${enriched.name || name} found on Apollo with verified email: ${enriched.email}`, 'success');
                        
                    } else if (enriched && !enriched.email) {
                        // Found person but no email
                        newContact = {
                            ...newContact,
                            name: enriched.name || name,
                            title: enriched.title || title || 'Unknown',
                            linkedIn: enriched.linkedIn || linkedIn || null,
                            phone: enriched.phone || null,
                            confidence: 70,
                            reasoning: `Found on Apollo but no email available - ${enriched.title || 'Contact'} at ${firm.name}`,
                            source: 'Apollo.io (No Email)',
                            apolloVerified: false,
                            apolloSearchDate: new Date().toISOString(),
                            apolloSearchBy: currentUser
                        };
                        
                        addNotification('âš ï¸ Partial Match', `${enriched.name || name} found on Apollo but no email available`, 'warning');
                        
                    } else {
                        // NOT FOUND
                        newContact = {
                            ...newContact,
                            reasoning: `Added manually - not found on Apollo (searched ${new Date().toLocaleDateString()} by ${currentUser})`,
                            apolloSearchDate: new Date().toISOString(),
                            apolloSearchBy: currentUser,
                            apolloNotFound: true
                        };
                        
                        addNotification('âŒ Not Found on Apollo', `"${name}" was not found in Apollo database. Added manually.`, 'warning');
                    }
                    
                } catch (err) {
                    document.getElementById('addContactLoadingOverlay')?.remove();
                    console.error('Apollo enrichment failed:', err);
                    
                    newContact.reasoning = `Added manually - Apollo search failed: ${err.message}`;
                    newContact.apolloSearchDate = new Date().toISOString();
                    newContact.apolloSearchBy = currentUser;
                    newContact.apolloError = err.message;
                    
                    addNotification('âš ï¸ Apollo Error', `Could not search Apollo: ${err.message}. Contact added manually.`, 'error');
                }
            }
            
            // Add to contacts list at the beginning
            firm.researchData.contacts.unshift(newContact);
            
            // Save and refresh
            await saveToStorage();
            
            if (!enrichWithApollo) {
                addNotification('âœ… Contact Added', `${name} added to ${firm.name} (no Apollo search)`, 'success');
            }
            
            openFirmDetails(firm);
        }
        
        // ============================================
        // EDIT CONTACT MODAL
        // ============================================
        
        function openEditContactModal(firmId, contactIndex) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.researchData?.contacts?.[contactIndex]) return;
            
            const contact = firm.researchData.contacts[contactIndex];
            
            document.getElementById('editContactModalContent').innerHTML = `
                <form id="editContactForm" onsubmit="submitEditContact(event, '${firmId}', ${contactIndex})">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Contact Name *</label>
                        <input type="text" id="editContactName" required value="${contact.name || ''}"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Job Title</label>
                        <input type="text" id="editContactTitle" value="${contact.title || ''}" placeholder="e.g., Head of Data, Portfolio Manager"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Email</label>
                        <input type="email" id="editContactEmail" value="${contact.email || ''}" placeholder="john.smith@company.com"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Phone</label>
                        <input type="tel" id="editContactPhone" value="${contact.phone || ''}" placeholder="+1 555-123-4567"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">LinkedIn URL</label>
                        <input type="url" id="editContactLinkedIn" value="${contact.linkedIn || ''}" placeholder="https://linkedin.com/in/johnsmith"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: var(--silver); margin-bottom: 0.5rem;">Notes/Reasoning</label>
                        <textarea id="editContactReasoning" rows="2" placeholder="Why is this contact relevant?"
                            style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px; resize: vertical;">${contact.reasoning || ''}</textarea>
                    </div>
                    <div style="background: rgba(100,100,100,0.1); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.8rem; color: var(--silver);">
                        <div>Source: <strong>${contact.source || 'Unknown'}</strong></div>
                        ${contact.addedBy ? `<div>Added by: ${contact.addedBy} on ${new Date(contact.addedDate).toLocaleDateString()}</div>` : ''}
                        ${contact.apolloSearchDate ? `<div>Apollo checked: ${new Date(contact.apolloSearchDate).toLocaleDateString()} by ${contact.apolloSearchBy || 'Unknown'}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn" style="flex: 1;">ðŸ’¾ Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editContactModal')">Cancel</button>
                    </div>
                </form>
            `;
            
            document.getElementById('editContactModal').querySelector('.modal-title').textContent = `âœï¸ Edit: ${contact.name}`;
            document.getElementById('editContactModal').classList.add('active');
        }
        
        async function submitEditContact(event, firmId, contactIndex) {
            event.preventDefault();
            
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.researchData?.contacts?.[contactIndex]) return;
            
            const contact = firm.researchData.contacts[contactIndex];
            
            // Update contact with new values
            contact.name = document.getElementById('editContactName').value.trim();
            contact.title = document.getElementById('editContactTitle').value.trim() || 'Unknown';
            contact.email = document.getElementById('editContactEmail').value.trim() || null;
            contact.phone = document.getElementById('editContactPhone').value.trim() || null;
            contact.linkedIn = document.getElementById('editContactLinkedIn').value.trim() || null;
            contact.reasoning = document.getElementById('editContactReasoning').value.trim();
            
            // Track edit
            contact.lastEditedBy = currentUser;
            contact.lastEditedDate = new Date().toISOString();
            
            // Update email confidence based on source
            if (contact.email && !contact.emailConfidence) {
                contact.emailConfidence = 'Manual Entry';
            }
            
            closeModal('editContactModal');
            
            await saveToStorage();
            addNotification('âœ… Contact Updated', `${contact.name} details saved`, 'success');
            openFirmDetails(firm);
        }
        
        // ============================================
        // CALENDAR / SCHEDULE VIEW
        // ============================================
        
        function openCalendarView() {
            // Gather all follow-ups and scheduled contacts
            const followUps = [];
            
            firms.forEach(firm => {
                // Check for scheduled follow-ups in contact history
                if (firm.contactHistory) {
                    firm.contactHistory.forEach((entry, idx) => {
                        if (entry.followUpDate) {
                            followUps.push({
                                type: 'follow-up',
                                firm: firm,
                                firmId: firm.id,
                                firmName: firm.name,
                                date: new Date(entry.followUpDate),
                                contact: entry.contactPerson,
                                method: entry.method,
                                notes: entry.notes,
                                createdBy: entry.user,
                                entryIndex: idx
                            });
                        }
                    });
                }
                
                // Check for trial dates
                if (firm.trialStartDate) {
                    followUps.push({
                        type: 'trial-start',
                        firm: firm,
                        firmId: firm.id,
                        firmName: firm.name,
                        date: new Date(firm.trialStartDate),
                        notes: 'Trial period starts'
                    });
                }
                if (firm.trialEndDate) {
                    followUps.push({
                        type: 'trial-end',
                        firm: firm,
                        firmId: firm.id,
                        firmName: firm.name,
                        date: new Date(firm.trialEndDate),
                        notes: 'Trial period ends - Follow up!'
                    });
                }
                
                // Check for scheduled reminders in notes
                if (firm.scheduledReminders) {
                    firm.scheduledReminders.forEach((reminder, idx) => {
                        followUps.push({
                            type: 'reminder',
                            firm: firm,
                            firmId: firm.id,
                            firmName: firm.name,
                            date: new Date(reminder.date),
                            notes: reminder.notes,
                            createdBy: reminder.user,
                            reminderIndex: idx
                        });
                    });
                }
            });
            
            // Sort by date
            followUps.sort((a, b) => a.date - b.date);
            
            // Group by week
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const thisWeek = [];
            const nextWeek = [];
            const later = [];
            const overdue = [];
            
            followUps.forEach(item => {
                const itemDate = new Date(item.date.getFullYear(), item.date.getMonth(), item.date.getDate());
                const daysDiff = Math.floor((itemDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysDiff < 0) {
                    overdue.push(item);
                } else if (daysDiff <= 7) {
                    thisWeek.push(item);
                } else if (daysDiff <= 14) {
                    nextWeek.push(item);
                } else {
                    later.push(item);
                }
            });
            
            // Render calendar
            const renderItems = (items, title, bgColor) => {
                if (items.length === 0) return '';
                
                const rows = items.map(item => {
                    const dateStr = item.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const timeStr = item.date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const typeIcon = item.type === 'follow-up' ? 'ðŸ“ž' : item.type === 'trial-start' ? 'ðŸš€' : item.type === 'trial-end' ? 'â°' : 'ðŸ””';
                    const typeLabel = item.type === 'follow-up' ? 'Follow-up' : item.type === 'trial-start' ? 'Trial Start' : item.type === 'trial-end' ? 'Trial End' : 'Reminder';
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid ${bgColor};">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>${typeIcon}</span>
                                    <strong style="color: var(--white);">${item.firmName}</strong>
                                    <span style="background: ${bgColor}20; color: ${bgColor}; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${typeLabel}</span>
                                    ${item.firm.assignedTo ? `<span style="background: rgba(126, 87, 194, 0.2); color: #9575CD; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">ðŸ‘¤ ${item.firm.assignedTo}</span>` : ''}
                                </div>
                                <div style="color: var(--silver); font-size: 0.85rem; margin-top: 0.25rem;">
                                    ${item.contact ? `Contact: ${item.contact} | ` : ''}${item.notes || ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--gold-accent); font-weight: 500;">${dateStr}</div>
                                <div style="color: var(--silver); font-size: 0.8rem;">${timeStr !== '12:00 AM' ? timeStr : ''}</div>
                            </div>
                            <button onclick="closeModal('calendarModal'); setTimeout(() => { const firm = firms.find(f => f.id === '${item.firmId}'); if(firm) openFirmDetails(firm); }, 100);" 
                                style="margin-left: 0.75rem; background: transparent; border: 1px solid var(--gold-accent); color: var(--gold-accent); padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                View
                            </button>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: ${bgColor}; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: ${bgColor}; width: 8px; height: 8px; border-radius: 50%;"></span>
                            ${title} (${items.length})
                        </h3>
                        ${rows}
                    </div>
                `;
            };
            
            // Add new reminder form
            const addReminderForm = `
                <div style="background: rgba(212, 165, 116, 0.1); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--gold-accent); margin-bottom: 0.75rem;">âž• Add New Reminder</h3>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: flex-end;">
                        <div>
                            <label style="display: block; color: var(--silver); font-size: 0.8rem; margin-bottom: 0.3rem;">Company</label>
                            <select id="reminderFirmSelect" style="padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 4px; min-width: 200px;">
                                <option value="">Select company...</option>
                                ${firms.filter(f => !f.isDeleted && f.status !== 'Client').map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: var(--silver); font-size: 0.8rem; margin-bottom: 0.3rem;">Date</label>
                            <input type="date" id="reminderDate" style="padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--silver); font-size: 0.8rem; margin-bottom: 0.3rem;">Time</label>
                            <input type="time" id="reminderTime" value="09:00" style="padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 4px;">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; color: var(--silver); font-size: 0.8rem; margin-bottom: 0.3rem;">Note</label>
                            <input type="text" id="reminderNote" placeholder="e.g., Follow up on pricing discussion" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 4px;">
                        </div>
                        <button onclick="addReminder()" class="btn" style="padding: 0.5rem 1rem;">Add</button>
                    </div>
                </div>
            `;
            
            let content = addReminderForm;
            
            if (overdue.length > 0) {
                content += renderItems(overdue, 'âš ï¸ Overdue', '#ef4444');
            }
            
            content += renderItems(thisWeek, 'ðŸ“… This Week', 'var(--gold-accent)');
            content += renderItems(nextWeek, 'ðŸ“† Next Week', 'var(--blue-info)');
            content += renderItems(later, 'ðŸ—“ï¸ Later', 'var(--silver)');
            
            if (followUps.length === 0) {
                content += `
                    <div style="text-align: center; padding: 3rem; color: var(--silver);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“…</div>
                        <p>No scheduled follow-ups or reminders yet.</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Add trial dates to firms or create reminders above to see them here.</p>
                    </div>
                `;
            }
            
            document.getElementById('calendarModalContent').innerHTML = content;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('reminderDate').value = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('calendarModal').classList.add('active');
        }
        
        async function addReminder() {
            const firmId = document.getElementById('reminderFirmSelect').value;
            const date = document.getElementById('reminderDate').value;
            const time = document.getElementById('reminderTime').value;
            const note = document.getElementById('reminderNote').value.trim();
            
            if (!firmId) {
                alert('Please select a company');
                return;
            }
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            // Initialize scheduledReminders if needed
            if (!firm.scheduledReminders) {
                firm.scheduledReminders = [];
            }
            
            // Create reminder
            const reminderDateTime = new Date(`${date}T${time || '09:00'}`);
            firm.scheduledReminders.push({
                date: reminderDateTime.toISOString(),
                notes: note || 'Follow-up reminder',
                user: currentUser,
                createdDate: new Date().toISOString()
            });
            
            await saveToStorage();
            addNotification('ðŸ”” Reminder Added', `Reminder set for ${firm.name} on ${reminderDateTime.toLocaleDateString()}`, 'success');
            
            // Refresh calendar view
            openCalendarView();
        }
        
        // Add follow-up reminder from firm details page
        async function addFollowUpReminder(firmId) {
            const dateInput = document.getElementById(`followUpDate_${firmId}`);
            const timeInput = document.getElementById(`followUpTime_${firmId}`);
            const notesTextarea = document.getElementById('firmNotesTextarea');
            
            const date = dateInput?.value;
            const time = timeInput?.value || '09:00';
            const notes = notesTextarea?.value?.trim() || '';
            
            if (!date) {
                alert('Please select a date for the follow-up reminder');
                return;
            }
            
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            // Initialize scheduledReminders if needed
            if (!firm.scheduledReminders) {
                firm.scheduledReminders = [];
            }
            
            // Create reminder
            const reminderDateTime = new Date(`${date}T${time}`);
            
            // Check if reminder is in the past
            if (reminderDateTime < new Date()) {
                if (!confirm('âš ï¸ This date is in the past. Add reminder anyway?')) {
                    return;
                }
            }
            
            firm.scheduledReminders.push({
                date: reminderDateTime.toISOString(),
                notes: notes ? `Follow-up: ${notes.substring(0, 100)}` : 'Follow-up reminder',
                user: currentUser,
                createdDate: new Date().toISOString()
            });
            
            // Also save the notes if they're filled
            if (notes) {
                firm.notes = notes;
            }
            
            await saveToStorage();
            addNotification('ðŸ”” Reminder Set', `Follow-up reminder for ${firm.name} on ${reminderDateTime.toLocaleDateString()} at ${reminderDateTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}`, 'success');
            
            // Refresh the firm details to show the new reminder
            openFirmDetails(firm);
        }
        
        // Delete a scheduled reminder
        async function deleteReminder(firmId, reminderIndex) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.scheduledReminders) return;
            
            const reminder = firm.scheduledReminders[reminderIndex];
            if (!reminder) return;
            
            const reminderDate = new Date(reminder.date);
            if (!confirm(`Delete reminder for ${reminderDate.toLocaleDateString()}?`)) {
                return;
            }
            
            // Remove the reminder
            firm.scheduledReminders.splice(reminderIndex, 1);
            
            await saveToStorage();
            addNotification('ðŸ—‘ï¸ Reminder Deleted', 'Follow-up reminder removed', 'info');
            
            // Refresh the firm details
            openFirmDetails(firm);
        }
        
        // ============================================
        // EDITABLE LLM-ASSIGNED PRIORITY
        // ============================================
        
        function renderPriorityEditor(firm) {
            const priorities = ['high', 'medium', 'low'];
            const priorityColors = {
                high: 'var(--green-flag)',
                medium: 'var(--yellow-flag)',
                low: 'var(--red-flag)'
            };
            const priorityIcons = {
                high: 'ðŸŸ¢',
                medium: 'ðŸŸ¡', 
                low: 'ðŸ”´'
            };
            
            const aiSuggestion = firm.researchData?.fitScore 
                ? `(AI suggested based on Fit Score: ${firm.researchData.fitScore}/10)` 
                : '';
            
            return `
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <label style="display: block; color: var(--silver); margin-bottom: 0.75rem; font-size: 0.85rem;">
                        Priority ${aiSuggestion}
                    </label>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        ${priorities.map(p => `
                            <button onclick="updateFirmPriority('${firm.id}', '${p}')"
                                style="
                                    padding: 0.5rem 1rem;
                                    border-radius: 6px;
                                    border: 2px solid ${priorityColors[p]};
                                    background: ${firm.priority === p ? priorityColors[p] + '30' : 'transparent'};
                                    color: ${priorityColors[p]};
                                    cursor: pointer;
                                    font-weight: ${firm.priority === p ? '600' : '400'};
                                    transition: all 0.2s ease;
                                    font-size: 0.9rem;
                                "
                                onmouseover="this.style.background='${priorityColors[p]}20'"
                                onmouseout="this.style.background='${firm.priority === p ? priorityColors[p] + '30' : 'transparent'}'">
                                ${priorityIcons[p]} ${p.charAt(0).toUpperCase() + p.slice(1)}
                            </button>
                        `).join('')}
                    </div>
                    ${firm.priorityOverride ? `
                        <div style="color: var(--yellow-flag); font-size: 0.75rem; margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>âš ï¸ Manually set by ${firm.priorityOverride.by} on ${new Date(firm.priorityOverride.date).toLocaleDateString()}</span>
                            <button onclick="resetToAIPriority('${firm.id}')" style="background: transparent; border: 1px solid var(--silver); color: var(--silver); padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">
                                Reset to AI
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        async function updateFirmPriority(firmId, newPriority) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const oldPriority = firm.priority;
            if (oldPriority === newPriority) return; // No change
            
            firm.priority = newPriority;
            firm.priorityOverride = {
                by: currentUser,
                date: new Date().toISOString(),
                previousPriority: oldPriority,
                reason: 'Manual override'
            };
            
            await saveToStorage();
            
            addNotification('âœ… Priority Updated', 
                `${firm.name}: ${oldPriority} â†’ ${newPriority}`, 'success');
            
            renderDashboard();
            openFirmDetails(firm);
        }
        
        async function resetToAIPriority(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.researchData?.fitScore) {
                alert('No AI research data available to determine priority');
                return;
            }
            
            // Calculate AI priority from fitScore
            const fitScore = firm.researchData.fitScore;
            let aiPriority;
            if (fitScore >= 8) aiPriority = 'high';
            else if (fitScore >= 6) aiPriority = 'medium';
            else aiPriority = 'low';
            
            const oldPriority = firm.priority;
            firm.priority = aiPriority;
            delete firm.priorityOverride; // Remove override flag
            
            await saveToStorage();
            
            addNotification('ðŸ¤– Priority Reset', 
                `${firm.name} reset to AI priority: ${aiPriority} (Fit Score: ${fitScore}/10)`, 'success');
            
            renderDashboard();
            openFirmDetails(firm);
        }
        
        // Load more contacts from Apollo (pagination)
        async function loadMoreApollo(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            if (!SEARCH_API.apolloKey) {
                alert('Apollo API key not configured. Please add it in Settings (âš™ï¸).');
                return;
            }
            
            // Initialize apolloData if needed
            if (!firm.apolloData) firm.apolloData = {};
            
            // Get current contacts count and total available
            const currentContacts = firm.researchData?.contacts?.length || 0;
            const totalAvailable = firm.apolloData.totalFound || 0;
            const remaining = totalAvailable - currentContacts;
            
            // If we know there are more, ask user how many to load
            if (remaining > 0) {
                const loadCount = remaining > 5 
                    ? prompt(`${remaining} more contacts available at ${firm.name}.\n\nHow many would you like to load?\n\nâ€¢ Enter a number (e.g., 5, 10, or ${remaining} for all)\nâ€¢ Leave blank for default (5)`, '5')
                    : null;
                
                if (loadCount === null && remaining > 5) return; // User cancelled
                
                var maxToLoad = parseInt(loadCount) || 5;
                if (maxToLoad > remaining) maxToLoad = remaining;
                if (maxToLoad > 25) maxToLoad = 25; // Cap at 25 to avoid excessive API usage
            } else {
                var maxToLoad = 5; // Default if we don't know the total
            }
            
            // Track which page we're on
            const currentPage = (firm.apolloData.currentPage || 1) + 1;
            
            // Show loading
            document.getElementById('firmDetailsModal').classList.remove('active');
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'apolloLoadingOverlay';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: var(--navy-card); padding: 2rem; border-radius: 12px; text-align: center; max-width: 400px;">
                        <div class="loading"></div>
                        <h3 style="color: var(--gold-accent); margin: 1rem 0;">ðŸš€ Loading More Contacts</h3>
                        <p style="color: var(--silver);" id="loadMoreStatus">Fetching up to ${maxToLoad} contacts from Apollo...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Target job titles for 2iQ data buyers
                const targetTitles = [
                    'Head of Data', 'Chief Data Officer', 'Head of Alternative Data',
                    'Director of Data', 'VP Data', 'Data Procurement',
                    'Head of Quantitative Research', 'Quantitative Researcher',
                    'Portfolio Manager', 'Quantitative Portfolio Manager',
                    'Director of Research', 'Head of Research',
                    'Data Scientist', 'Quantitative Developer', 'Quant Analyst'
                ];
                
                // Get existing contact IDs and names to avoid duplicates
                const existingIds = new Set(
                    (firm.researchData?.contacts || []).filter(c => c.apolloId).map(c => c.apolloId)
                );
                const existingNames = new Set(
                    (firm.researchData?.contacts || []).map(c => (c.name || '').toLowerCase().trim())
                );
                
                // Fetch next page with enough results
                const response = await fetch('http://localhost:8001/apollo/mixed_people', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: SEARCH_API.apolloKey,
                        q_organization_name: firm.name,
                        person_titles: targetTitles,
                        page: currentPage,
                        per_page: Math.min(maxToLoad + 10, 25) // Get extra to filter duplicates
                    })
                });
                
                const data = await response.json();
                console.log('ðŸš€ Apollo loadMore response:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.people || data.people.length === 0) {
                    document.getElementById('apolloLoadingOverlay')?.remove();
                    addNotification('â„¹ï¸ No More Contacts', `No additional contacts found at ${firm.name}`, 'info');
                    openFirmDetails(firm);
                    return;
                }
                
                // Update total count from pagination
                if (data.pagination?.total_entries) {
                    firm.apolloData.totalFound = data.pagination.total_entries;
                }
                
                // Process new contacts
                const newContacts = [];
                let processed = 0;
                
                for (const person of data.people) {
                    if (newContacts.length >= maxToLoad) break;
                    
                    const firstName = (person.first_name || '').trim();
                    const lastName = (person.last_name || '').trim();
                    const fullName = `${firstName} ${lastName}`.trim();
                    
                    // Skip if no name
                    if (!fullName || fullName === '') continue;
                    
                    // Skip duplicates by apolloId or name
                    if (person.id && existingIds.has(person.id)) continue;
                    if (existingNames.has(fullName.toLowerCase())) continue;
                    
                    processed++;
                    const statusEl = document.getElementById('loadMoreStatus');
                    if (statusEl) {
                        statusEl.textContent = `Processing contact ${processed}/${data.people.length}: ${fullName}...`;
                    }
                    
                    // Try to enrich for email
                    let email = person.email || null;
                    let emailConfidence = person.email ? (person.email_status === 'verified' ? 'Verified' : 'Pattern Match') : 'Unverified';
                    
                    if (!email) {
                        try {
                            const enriched = await apolloEnrichPerson(fullName, firm.name, null, person.id);
                            if (enriched?.email) {
                                email = enriched.email;
                                emailConfidence = 'Verified';
                            }
                        } catch (e) {
                            console.log('Enrich failed for', fullName);
                        }
                    }
                    
                    newContacts.push({
                        name: fullName,
                        title: person.title || 'Unknown',
                        email: email,
                        emailConfidence: emailConfidence,
                        linkedIn: person.linkedin_url || null,
                        phone: person.phone_numbers?.[0]?.sanitized_number || null,
                        confidence: email ? 95 : 70,
                        reasoning: `Found via Apollo.io - ${person.title || 'Unknown'} at ${firm.name}`,
                        source: 'Apollo.io',
                        apolloVerified: !!email,
                        apolloId: person.id
                    });
                    
                    // Add to tracking sets
                    if (person.id) existingIds.add(person.id);
                    existingNames.add(fullName.toLowerCase());
                    
                    // Rate limiting
                    await new Promise(r => setTimeout(r, 300));
                }
                
                document.getElementById('apolloLoadingOverlay')?.remove();
                
                if (newContacts.length === 0) {
                    addNotification('â„¹ï¸ No New Contacts', 'All contacts on this page are duplicates or already added', 'info');
                    openFirmDetails(firm);
                    return;
                }
                
                // Add to existing contacts
                if (!firm.researchData) {
                    firm.researchData = { contacts: [], fitScore: 7, flags: { green: [], yellow: [], red: [] }, reasoning: '' };
                }
                firm.researchData.contacts = [...firm.researchData.contacts, ...newContacts];
                firm.apolloData.currentPage = currentPage;
                
                await saveToStorage();
                
                const verifiedCount = newContacts.filter(c => c.apolloVerified).length;
                const totalNow = firm.researchData.contacts.length;
                const totalAvailableNow = firm.apolloData.totalFound || totalNow;
                const stillRemaining = totalAvailableNow - totalNow;
                
                let message = `Added ${newContacts.length} contacts (${verifiedCount} with verified emails)`;
                if (stillRemaining > 0) {
                    message += `. ${stillRemaining} more available.`;
                }
                
                addNotification('ðŸš€ More Contacts Loaded', message, 'success');
                openFirmDetails(firm);
                
            } catch (error) {
                document.getElementById('apolloLoadingOverlay')?.remove();
                console.error('âŒ loadMoreApollo error:', error);
                addNotification('âŒ Error', error.message, 'error');
                openFirmDetails(firm);
            }
        }
        
        // ============================================
        // HUNTER.IO API INTEGRATION
        // ============================================
        
        // Search for emails at a domain using Hunter
        async function hunterDomainSearch(domain, limit = 10) {
            if (!SEARCH_API.hunterKey) {
                throw new Error('Hunter.io API key not configured. Add it in Settings.');
            }
            
            console.log('ðŸ“§ Hunter: Searching domain', domain);
            
            try {
                const response = await fetch('http://localhost:8001/hunter/domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: SEARCH_API.hunterKey,
                        domain: domain,
                        limit: limit
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.errors?.[0]?.details || `Hunter API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                return {
                    domain: data.data?.domain,
                    emails: (data.data?.emails || []).map(e => ({
                        email: e.value,
                        type: e.type,
                        confidence: e.confidence,
                        firstName: e.first_name,
                        lastName: e.last_name,
                        position: e.position,
                        department: e.department,
                        linkedIn: e.linkedin,
                        sources: e.sources?.length || 0
                    })),
                    organization: data.data?.organization,
                    pattern: data.data?.pattern
                };
                
            } catch (error) {
                console.error('ðŸ“§ Hunter domain search error:', error);
                throw error;
            }
        }
        
        // Find email for a specific person using Hunter
        async function hunterEmailFinder(domain, firstName, lastName) {
            if (!SEARCH_API.hunterKey) {
                throw new Error('Hunter.io API key not configured');
            }
            
            console.log('ðŸ“§ Hunter: Finding email for', firstName, lastName, 'at', domain);
            
            try {
                const response = await fetch('http://localhost:8001/hunter/finder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: SEARCH_API.hunterKey,
                        domain: domain,
                        first_name: firstName,
                        last_name: lastName
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.errors?.[0]?.details || `Hunter API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.data?.email) {
                    return null;
                }
                
                return {
                    email: data.data.email,
                    confidence: data.data.score || data.data.confidence,
                    firstName: data.data.first_name,
                    lastName: data.data.last_name,
                    position: data.data.position,
                    linkedIn: data.data.linkedin,
                    sources: data.data.sources?.length || 0
                };
                
            } catch (error) {
                console.error('ðŸ“§ Hunter email finder error:', error);
                return null;
            }
        }
        
        // Verify an email using Hunter
        async function hunterEmailVerifier(email) {
            if (!SEARCH_API.hunterKey) {
                throw new Error('Hunter.io API key not configured');
            }
            
            console.log('ðŸ“§ Hunter: Verifying', email);
            
            try {
                const response = await fetch('http://localhost:8001/hunter/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: SEARCH_API.hunterKey,
                        email: email
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.errors?.[0]?.details || `Hunter API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                return {
                    email: data.data?.email,
                    status: data.data?.status, // valid, invalid, accept_all, webmail, disposable, unknown
                    score: data.data?.score,
                    regexp: data.data?.regexp,
                    gibberish: data.data?.gibberish,
                    disposable: data.data?.disposable,
                    webmail: data.data?.webmail,
                    mxRecords: data.data?.mx_records,
                    smtpServer: data.data?.smtp_server,
                    smtpCheck: data.data?.smtp_check
                };
                
            } catch (error) {
                console.error('ðŸ“§ Hunter verify error:', error);
                return null;
            }
        }
        
        // Main function to enrich a firm with Hunter.io data
        async function enrichWithHunter(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            if (!SEARCH_API.hunterKey) {
                alert('Hunter.io API key not configured. Please add it in Settings (âš™ï¸).');
                return;
            }
            
            // Get domain from website
            let domain = null;
            if (firm.website) {
                try {
                    domain = new URL(firm.website.startsWith('http') ? firm.website : 'https://' + firm.website).hostname.replace('www.', '');
                } catch (e) {}
            }
            
            if (!domain) {
                // Try to derive domain from company name
                const companyDomain = firm.name.toLowerCase()
                    .replace(/\s+(capital|management|partners|advisors|asset|investments|group|llc|lp|ltd|inc|corp)$/gi, '')
                    .replace(/[^a-z0-9]/g, '') + '.com';
                domain = companyDomain;
            }
            
            // Show loading modal
            document.getElementById('firmDetailsModal').classList.remove('active');
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'hunterLoadingOverlay';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: var(--navy-card); padding: 2rem; border-radius: 12px; text-align: center; max-width: 400px;">
                        <div class="loading"></div>
                        <h3 style="color: var(--gold-accent); margin: 1rem 0;">ðŸ“§ Finding Emails with Hunter</h3>
                        <p style="color: var(--silver);">Searching ${domain}...</p>
                        <p style="color: var(--silver); font-size: 0.8rem; margin-top: 1rem;">Free: 25 searches/month</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // If we have contacts from AI, try to find their specific emails
                if (firm.researchData?.contacts?.length > 0) {
                    let foundEmails = 0;
                    
                    for (const contact of firm.researchData.contacts) {
                        if (!contact.name || contact.hunterVerified) continue;
                        
                        // Parse first and last name
                        const nameParts = contact.name.trim().split(/\s+/);
                        if (nameParts.length < 2) continue;
                        
                        const firstName = nameParts[0];
                        const lastName = nameParts[nameParts.length - 1];
                        
                        const result = await hunterEmailFinder(domain, firstName, lastName);
                        
                        if (result?.email) {
                            contact.email = result.email;
                            contact.emailConfidence = result.confidence >= 90 ? 'Verified' : 'High Confidence';
                            contact.linkedIn = result.linkedIn || contact.linkedIn;
                            contact.title = result.position || contact.title;
                            contact.confidence = Math.max(contact.confidence || 0, result.confidence || 80);
                            contact.source = 'Hunter.io';
                            contact.hunterVerified = true;
                            foundEmails++;
                        }
                        
                        // Rate limiting - Hunter allows 10 requests/second but let's be safe
                        await new Promise(r => setTimeout(r, 200));
                    }
                    
                    document.getElementById('hunterLoadingOverlay')?.remove();
                    
                    if (foundEmails > 0) {
                        firm.hunterData = {
                            enrichedDate: new Date().toISOString(),
                            domain: domain,
                            emailsFound: foundEmails
                        };
                        firm.researchData.flags.green.push(`${foundEmails} emails found by Hunter.io`);
                        await saveToStorage();
                        addNotification('ðŸ“§ Hunter Complete', `Found ${foundEmails} verified emails`, 'success');
                    } else {
                        addNotification('âš ï¸ No Emails Found', `Hunter couldn't find emails at ${domain}`, 'warning');
                    }
                    
                } else {
                    // No contacts yet, do a domain search to find emails
                    const result = await hunterDomainSearch(domain, 10);
                    
                    document.getElementById('hunterLoadingOverlay')?.remove();
                    
                    if (result.emails.length > 0) {
                        // Create contacts from Hunter results
                        const newContacts = result.emails
                            .filter(e => e.firstName && e.lastName)
                            .map(e => ({
                                name: `${e.firstName} ${e.lastName}`,
                                title: e.position || 'Unknown',
                                email: e.email,
                                emailConfidence: e.confidence >= 90 ? 'Verified' : 'High Confidence',
                                linkedIn: e.linkedIn || null,
                                confidence: e.confidence || 80,
                                reasoning: `Found via Hunter.io domain search (${e.sources} sources)`,
                                source: 'Hunter.io',
                                hunterVerified: true
                            }));
                        
                        if (!firm.researchData) {
                            firm.researchData = {
                                contacts: [],
                                fitScore: 5,
                                flags: { green: [], yellow: [], red: [] },
                                reasoning: 'Contacts found via Hunter.io'
                            };
                        }
                        
                        firm.researchData.contacts = [...newContacts, ...firm.researchData.contacts];
                        firm.researchData.flags.green.push(`${newContacts.length} contacts from Hunter.io`);
                        firm.hunterData = {
                            enrichedDate: new Date().toISOString(),
                            domain: domain,
                            pattern: result.pattern,
                            emailsFound: newContacts.length
                        };
                        
                        await saveToStorage();
                        addNotification('ðŸ“§ Hunter Complete', `Found ${newContacts.length} contacts at ${domain}`, 'success');
                    } else {
                        addNotification('âš ï¸ No Emails', `No emails found at ${domain}`, 'warning');
                    }
                }
                
                openFirmDetails(firm);
                
            } catch (error) {
                document.getElementById('hunterLoadingOverlay')?.remove();
                addNotification('âŒ Hunter Error', error.message, 'error');
                openFirmDetails(firm);
            }
        }
        
        function parseResearchResponse(responseText) {
            // Debug log raw response
            console.log('ðŸ” Raw AI Response (first 500 chars):', responseText?.substring(0, 500));
            
            // Remove markdown fences (handle various formats)
            let jsonText = responseText
                .replace(/```json\s*/gi, '')
                .replace(/```\s*/g, '')
                .replace(/^\s*[\r\n]+/, '')  // Remove leading newlines
                .trim();
            
            // Try to extract JSON object
            const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
            
            if (!jsonMatch) {
                console.error('âŒ No JSON found in response:', responseText?.substring(0, 300));
                return {
                    contacts: [],
                    findings: [],
                    leads: [],
                    fitScore: 5,
                    flags: { green: [], yellow: ['Could not find JSON in AI response'], red: [] },
                    reasoning: 'AI response did not contain valid JSON',
                    research_summary: 'Failed to parse response'
                };
            }

            try {
                const data = JSON.parse(jsonMatch[0]);
                console.log('âœ… Parsed JSON successfully. Keys:', Object.keys(data));
                console.log('   findings:', data.findings?.length || 0, 'leads:', data.leads?.length || 0);
                
                // Helper function to detect placeholder/fake emails
                function isPlaceholderEmail(email) {
                    if (!email) return true;
                    const emailLower = email.toLowerCase();
                    
                    // Known placeholder patterns
                    const placeholderPatterns = [
                        'john.doe@', 'jane.doe@', 'john.smith@', 'jane.smith@',
                        'johndoe@', 'janedoe@', 'johnsmith@', 'janesmith@',
                        'contact@', 'contact1@', 'contact2@',
                        'info@', 'sales@', 'support@', 'hello@',
                        'firstname.lastname@', 'first.last@',
                        'name@', 'email@', 'test@', 'example@',
                        'user@', 'admin@', 'noreply@',
                        'placeholder@', 'fake@', 'sample@'
                    ];
                    
                    // Check if email matches any placeholder pattern
                    if (placeholderPatterns.some(pattern => emailLower.includes(pattern))) {
                        console.log('âš ï¸ Filtered placeholder email:', email);
                        return true;
                    }
                    
                    // Check for generic patterns like firstname.lastname@ with no real name verification
                    const genericPattern = /^[a-z]+\.[a-z]+@/i;
                    const parts = emailLower.split('@')[0].split('.');
                    if (parts.length === 2) {
                        // Common fake first names
                        const fakeFirstNames = ['john', 'jane', 'joe', 'bob', 'alice', 'mary', 'mike', 'david', 'sarah'];
                        // Common fake last names
                        const fakeLastNames = ['doe', 'smith', 'jones', 'johnson', 'williams', 'brown'];
                        
                        if (fakeFirstNames.includes(parts[0]) && fakeLastNames.includes(parts[1])) {
                            console.log('âš ï¸ Filtered generic fake email:', email);
                            return true;
                        }
                    }
                    
                    return false;
                }
                
                // Filter out placeholder contacts (for firm research)
                if (data.contacts && data.contacts.length > 0) {
                    data.contacts = data.contacts.filter(c => {
                        // Filter out placeholder names
                        if (!c.name) return false;
                        const nameLower = c.name.toLowerCase();
                        if (nameLower.includes('contact ') || 
                            nameLower.includes('contact1') || 
                            nameLower.includes('contact2') ||
                            nameLower === 'john doe' ||
                            nameLower === 'jane doe' ||
                            nameLower === 'john smith' ||
                            nameLower === 'jane smith' ||
                            nameLower === 'michael johnson' ||
                            nameLower === 'sarah williams' ||
                            nameLower === 'david brown') {
                            console.log('âš ï¸ Filtered placeholder contact name:', c.name);
                            return false;
                        }
                        
                        // Filter out contacts without LinkedIn URL (likely made up)
                        if (!c.linkedIn || !c.linkedIn.includes('linkedin.com')) {
                            console.log('âš ï¸ Filtered contact without LinkedIn URL:', c.name);
                            return false;
                        }
                        
                        return true;
                    });
                    
                    // Clean placeholder emails from remaining contacts (set to null instead of removing contact)
                    data.contacts = data.contacts.map(c => {
                        if (isPlaceholderEmail(c.email)) {
                            return { ...c, email: null, emailConfidence: 'Unverified' };
                        }
                        return c;
                    });
                    
                    console.log('ðŸ“§ Contacts after filtering:', data.contacts.length);
                }
                
                // Return unified response that works for both firm research and discovery
                return {
                    // Firm research fields
                    contacts: data.contacts || [],
                    fitScore: data.fitScore || 5,
                    flags: data.flags || { green: [], yellow: [], red: [] },
                    reasoning: data.reasoning || data.research_summary || 'No reasoning provided',
                    
                    // Global office locations
                    globalOffices: data.globalOffices || null,
                    
                    // Discovery fields
                    findings: data.findings || [],
                    leads: data.leads || [],
                    searches_performed: data.searches_performed || [],
                    methodology: data.methodology || '',
                    research_summary: data.research_summary || data.methodology || ''
                };
            } catch (e) {
                console.error('âŒ JSON parse error:', e.message);
                console.error('   Attempted to parse:', jsonMatch[0]?.substring(0, 300));
                return {
                    contacts: [],
                    findings: [],
                    leads: [],
                    fitScore: 5,
                    flags: { green: [], yellow: ['JSON parse error: ' + e.message], red: [] },
                    reasoning: 'Could not parse AI response',
                    research_summary: 'JSON parse failed'
                };
            }
        }
        
        // Test all API connections
        async function testAllConnections() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'rgba(69, 123, 157, 0.1)';
            resultDiv.style.border = '1px solid var(--blue-info)';
            resultDiv.innerHTML = '<div class="loading"></div> Testing all API connections...';
            
            const results = [];
            
            for (const [key, config] of Object.entries(LLM_CONFIG)) {
                if (API_KEYS[key]) {
                    try {
                        let success = false;
                        let errorMsg = '';
                        
                        if (key === 'claude') {
                            // Claude uses localhost proxy due to CORS
                            try {
                                const resp = await fetch("http://localhost:8001", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "x-api-key": API_KEYS.claude,
                                        "anthropic-version": "2023-06-01"
                                    },
                                    body: JSON.stringify({
                                        model: "claude-sonnet-4-20250514",
                                        max_tokens: 10,
                                        messages: [{ role: "user", content: "test" }]
                                    })
                                });
                                success = resp.ok;
                                if (!success) errorMsg = 'API error';
                            } catch (e) {
                                errorMsg = 'Proxy not running';
                            }
                        } else if (key === 'openai') {
                            const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${API_KEYS.openai}`
                                },
                                body: JSON.stringify({
                                    model: "gpt-4o",
                                    max_tokens: 10,
                                    messages: [{ role: "user", content: "test" }]
                                })
                            });
                            success = resp.ok;
                        } else if (key === 'deepseek') {
                            const resp = await fetch("https://api.deepseek.com/chat/completions", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${API_KEYS.deepseek}`
                                },
                                body: JSON.stringify({
                                    model: "deepseek-chat",
                                    max_tokens: 10,
                                    messages: [{ role: "user", content: "test" }]
                                })
                            });
                            success = resp.ok;
                        } else if (key === 'gemini') {
                            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEYS.gemini}`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: "test" }] }]
                                })
                            });
                            success = resp.ok;
                        }
                        
                        if (success) {
                            results.push(`${config.icon} ${config.name}: âœ“`);
                        } else {
                            results.push(`${config.icon} ${config.name}: âœ— ${errorMsg || 'Failed'}`);
                        }
                    } catch (e) {
                        results.push(`${config.icon} ${config.name}: âœ— ${e.message || 'Error'}`);
                    }
                } else {
                    results.push(`${config.icon} ${config.name}: â—‹ Not configured`);
                }
            }
            
            // Add proxy reminder if Claude failed
            const claudeFailed = results.some(r => r.includes('Claude') && r.includes('Proxy'));
            if (claudeFailed) {
                results.push('<br><small style="color: var(--yellow-flag);">âš ï¸ Claude requires proxy server on port 8001</small>');
            }
            
            const allGood = results.every(r => r.includes('âœ“') || r.includes('â—‹') || r.includes('<br>'));
            resultDiv.style.background = allGood ? 'rgba(6, 214, 160, 0.1)' : 'rgba(244, 162, 97, 0.1)';
            resultDiv.style.border = allGood ? '1px solid var(--green-flag)' : '1px solid var(--yellow-flag)';
            resultDiv.innerHTML = results.join('<br>');
        }
        
        // Show previous comparison results
        function showPreviousComparison(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.comparisonData) return;
            
            closeModal('firmDetailsModal');
            
            const results = firm.comparisonData.results;
            const llmKeys = firm.comparisonData.llmsUsed;
            
            const content = `
                <div class="comparison-header">
                    <h3>${firm.name}</h3>
                    <p style="color: var(--silver);">Comparison from ${new Date(firm.comparisonData.completedDate).toLocaleString()}</p>
                </div>
                <div class="comparison-grid" id="comparisonGrid">
                    ${llmKeys.map(key => {
                        const config = LLM_CONFIG[key];
                        const result = results[key];
                        const isWinner = firm.researchData?.llmUsed === key;
                        
                        return `
                            <div class="comparison-column ${isWinner ? 'winner' : ''}" style="--llm-color: ${config.color}; ${isWinner ? 'border-color: var(--gold-accent);' : ''}">
                                <div class="comparison-column-header">
                                    <span class="llm-icon-large">${config.icon}</span>
                                    <span class="llm-name-large">${config.name}</span>
                                    ${isWinner ? '<span class="winner-badge">â­ Selected</span>' : ''}
                                    <span class="comparison-status ${result.success ? 'complete' : 'error'}">
                                        ${result.success ? 'âœ“ Complete' : 'âœ— Failed'}
                                    </span>
                                </div>
                                <div class="comparison-content">
                                    ${result.success ? renderComparisonResult(result.data) : `<div class="comparison-error"><p>âŒ ${result.error}</p></div>`}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="comparison-actions">
                    <button class="btn" onclick="initiateResearch('${firm.id}'); closeModal('llmComparisonModal');">
                        ðŸ”„ Run New Comparison
                    </button>
                    <button class="btn btn-secondary" style="margin-left: 1rem;" onclick="closeModal('llmComparisonModal'); openFirmDetails(firms.find(f => f.id === '${firm.id}'));">
                        â† Back to Firm Details
                    </button>
                </div>
            `;
            
            document.getElementById('llmComparisonContent').innerHTML = content;
            document.getElementById('llmComparisonModal').classList.add('active');
        }

        // Open firm details
        function openFirmDetails(firm) {
            // Check if locked by another user
            if (isFirmLocked(firm)) {
                const lockTime = firm.lockedAt ? new Date(firm.lockedAt).toLocaleTimeString() : 'recently';
                alert(`ðŸ”’ This firm is currently being viewed by ${firm.lockedBy}.\n\nLocked since: ${lockTime}\n\nPlease try again in a few minutes or contact them to release the lock.`);
                return;
            }
            
            // Lock the firm
            lockFirm(firm.id);
            currentlyOpenFirmId = firm.id;
            console.log('ðŸ“‚ Opening firm details for:', firm.name, 'ID:', firm.id, 'currentlyOpenFirmId set to:', currentlyOpenFirmId);
            
            document.getElementById('firmDetailsTitle').textContent = firm.name;
            
            // Format date helper
            function formatDate(isoDate) {
                if (!isoDate) return 'Unknown';
                const d = new Date(isoDate);
                return d.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            let content = `
                <div class="firm-meta" style="margin-bottom: 1rem;">
                    <div class="meta-item" style="display: flex; align-items: center; gap: 0.5rem;">
                        ðŸ“ <span id="firmLocationDisplay">${firm.location || 'Unknown'}</span>
                    </div>
                    <div class="meta-item">ðŸ’° $${firm.aum || 0}B AUM</div>
                    <div class="meta-item">${firm.focus || 'Strategy not specified'}</div>
                </div>
                
                <!-- Location Editor - Always visible -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(212, 165, 116, 0.1); border-radius: 8px; border: 1px solid rgba(212, 165, 116, 0.3);">
                    <label style="display: block; color: var(--gold-accent); font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem;">ðŸ“ Change Location</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="newLocationInput" value="${firm.location || ''}" placeholder="Enter new location..." style="flex: 1; min-width: 200px; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                        <select id="locationQuickSelect" onchange="document.getElementById('newLocationInput').value = this.value" style="padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                            <option value="">-- Quick Select --</option>
                            <optgroup label="â­ Priority Markets">
                                <option value="New York, USA">New York, USA</option>
                                <option value="London, UK">London, UK</option>
                                <option value="Hong Kong">Hong Kong</option>
                                <option value="Singapore">Singapore</option>
                                <option value="Zurich, Switzerland">Zurich, Switzerland</option>
                                <option value="Geneva, Switzerland">Geneva, Switzerland</option>
                            </optgroup>
                            <optgroup label="ðŸ‡ºðŸ‡¸ United States">
                                <option value="Boston, USA">Boston, USA</option>
                                <option value="Chicago, USA">Chicago, USA</option>
                                <option value="San Francisco, USA">San Francisco, USA</option>
                                <option value="Greenwich, USA">Greenwich, USA</option>
                                <option value="Stamford, USA">Stamford, USA</option>
                                <option value="Miami, USA">Miami, USA</option>
                                <option value="Los Angeles, USA">Los Angeles, USA</option>
                            </optgroup>
                            <optgroup label="ðŸ‡ªðŸ‡º Europe">
                                <option value="Paris, France">Paris, France</option>
                                <option value="Frankfurt, Germany">Frankfurt, Germany</option>
                                <option value="Amsterdam, Netherlands">Amsterdam, Netherlands</option>
                                <option value="Dublin, Ireland">Dublin, Ireland</option>
                                <option value="Stockholm, Sweden">Stockholm, Sweden</option>
                            </optgroup>
                            <optgroup label="ðŸŒ Asia Pacific">
                                <option value="Tokyo, Japan">Tokyo, Japan</option>
                                <option value="Sydney, Australia">Sydney, Australia</option>
                                <option value="Mumbai, India">Mumbai, India</option>
                                <option value="Dubai, UAE">Dubai, UAE</option>
                            </optgroup>
                        </select>
                        <button class="btn" onclick="saveCurrentFirmLocation()" style="padding: 0.5rem 1rem;">ðŸ’¾ Save</button>
                    </div>
                </div>
            `;
            
            // ADD: Priority Editor (editable LLM-assigned priority)
            content += renderPriorityEditor(firm);
            
            // Source and added by info
            if (firm.source || firm.addedBy || firm.addedDate) {
                const sourceIcon = firm.source === 'AI Discovery' ? 'ðŸ¤–' : firm.source === 'Excel Import' ? 'ðŸ“Š' : firm.source === 'Manual Entry' ? 'âœï¸' : 'ðŸ“';
                content += `
                    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 0.85rem;">
                        ${firm.source ? `<div><span style="color: var(--silver);">Source:</span> <span style="color: var(--white);">${sourceIcon} ${firm.source}</span></div>` : ''}
                        ${firm.addedBy ? `<div><span style="color: var(--silver);">Added by:</span> <span style="color: var(--gold-accent); font-weight: 600;">${firm.addedBy}</span></div>` : ''}
                        ${firm.addedDate ? `<div><span style="color: var(--silver);">Date:</span> <span style="color: var(--white);">${formatDate(firm.addedDate)}</span></div>` : ''}
                    </div>
                `;
            }
            
            // Show global offices if available
            if (firm.globalOffices || firm.researchData?.globalOffices) {
                const offices = firm.globalOffices || firm.researchData?.globalOffices;
                const americas = offices.americas || [];
                const emea = offices.emea || [];
                const apac = offices.apac || [];
                const allOffices = [...americas, ...emea, ...apac];
                
                if (allOffices.length > 0 || offices.headquarters) {
                    content += `
                        <div style="background: rgba(69, 123, 157, 0.1); border: 1px solid rgba(69, 123, 157, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="color: var(--blue-info); font-weight: 600; margin-bottom: 0.75rem;">ðŸŒ Global Office Locations</div>
                            ${offices.headquarters ? `<div style="margin-bottom: 0.5rem;"><strong style="color: var(--gold-accent);">HQ:</strong> <span style="color: var(--white);">${offices.headquarters}</span></div>` : ''}
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                ${americas.length > 0 ? `
                                    <div>
                                        <div style="color: var(--silver); font-size: 0.8rem; margin-bottom: 0.3rem;">ðŸ‡ºðŸ‡¸ Americas</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                                            ${americas.map(loc => `<span style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${loc}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${emea.length > 0 ? `
                                    <div>
                                        <div style="color: var(--silver); font-size: 0.8rem; margin-bottom: 0.3rem;">ðŸ‡ªðŸ‡º EMEA</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                                            ${emea.map(loc => `<span style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${loc}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${apac.length > 0 ? `
                                    <div>
                                        <div style="color: var(--silver); font-size: 0.8rem; margin-bottom: 0.3rem;">ðŸŒ APAC</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                                            ${apac.map(loc => `<span style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${loc}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Show discovery data if firm was discovered via AI
            if (firm.discoveryData) {
                const dd = firm.discoveryData;
                content += `
                    <div style="background: rgba(6, 214, 160, 0.1); border: 1px solid rgba(6, 214, 160, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
                            <span style="color: var(--green-flag); font-weight: 600;">ðŸŽ¯ AI-Discovered Lead</span>
                            <span style="font-size: 0.75rem; color: var(--silver);">Found: ${formatDate(dd.discoveredDate)}</span>
                        </div>
                        
                        <!-- Discovery metadata -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            ${firm.dateAdded ? `
                                <div style="font-size: 0.75rem;">
                                    <span style="color: var(--gold-accent);">ðŸ“… Added:</span>
                                    <span style="color: var(--silver);"> ${formatDate(firm.dateAdded)}</span>
                                </div>
                            ` : ''}
                            ${dd.discoveredBy ? `
                                <div style="font-size: 0.75rem;">
                                    <span style="color: var(--gold-accent);">ðŸ¤– Discovered by:</span>
                                    <span style="color: var(--silver);"> ${dd.discoveredBy}</span>
                                </div>
                            ` : ''}
                            ${dd.confidence ? `
                                <div style="font-size: 0.75rem;">
                                    <span style="color: var(--gold-accent);">ðŸ“Š Confidence:</span>
                                    <span style="color: var(--silver);"> ${dd.confidence}%</span>
                                </div>
                            ` : ''}
                            ${dd.region ? `
                                <div style="font-size: 0.75rem;">
                                    <span style="color: var(--gold-accent);">ðŸŒ Region:</span>
                                    <span style="color: var(--silver);"> ${dd.region}</span>
                                </div>
                            ` : ''}
                            ${dd.originalPriority ? `
                                <div style="font-size: 0.75rem;">
                                    <span style="color: var(--gold-accent);">ðŸŽ¯ Priority:</span>
                                    <span style="color: ${dd.originalPriority === 'hot' ? 'var(--red-flag)' : dd.originalPriority === 'warm' ? 'var(--yellow-flag)' : 'var(--blue-info)'}; text-transform: uppercase;"> ${dd.originalPriority}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${dd.buyingSignals && dd.buyingSignals.length > 0 ? `
                            <div style="margin-bottom: 0.75rem;">
                                <strong style="color: var(--gold-accent); font-size: 0.8rem;">ðŸ”¥ Buying Signals:</strong>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.3rem;">
                                    ${dd.buyingSignals.map(s => `<span class="signal-tag positive">âœ“ ${s}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${dd.dataInterest ? `
                            <div style="margin-bottom: 0.75rem;">
                                <strong style="color: var(--gold-accent); font-size: 0.8rem;">ðŸ’¡ Data Fit:</strong>
                                <p style="color: var(--silver); font-size: 0.85rem; margin: 0.3rem 0 0 0;">${dd.dataInterest}</p>
                            </div>
                        ` : ''}
                        
                        ${dd.decisionMaker ? `
                            <div style="margin-bottom: 0.5rem;">
                                <strong style="color: var(--gold-accent); font-size: 0.8rem;">ðŸ‘¤ Target Contact:</strong>
                                <span style="color: var(--silver); font-size: 0.85rem;"> ${dd.decisionMaker}</span>
                            </div>
                        ` : ''}
                        
                        ${dd.source ? `
                            <div style="font-size: 0.75rem; color: var(--silver); opacity: 0.8;">
                                ðŸ“ Source: ${dd.source.startsWith('http') ? `<a href="${dd.source}" target="_blank" style="color: var(--gold-accent);">${dd.source}</a>` : dd.source}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (firm.dateAdded) {
                // Show when manually added firms were added
                content += `
                    <div style="background: rgba(69, 123, 157, 0.1); border: 1px solid rgba(69, 123, 157, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 1.5rem; font-size: 0.8rem; color: var(--silver);">
                        ðŸ“… Added to pipeline: ${formatDate(firm.dateAdded)}
                    </div>
                `;
            }
            
            if (firm.researchData) {
                // Show research results
                const data = firm.researchData;
                
                // Flags
                content += '<div class="flags-container">';
                if (data.flags.green && data.flags.green.length > 0) {
                    content += `
                        <div class="flag-box green">
                            <div class="flag-title">ðŸŸ¢ Green Flags</div>
                            <ul class="flag-list">
                                ${data.flags.green.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                if (data.flags.yellow && data.flags.yellow.length > 0) {
                    content += `
                        <div class="flag-box yellow">
                            <div class="flag-title">ðŸŸ¡ Yellow Flags</div>
                            <ul class="flag-list">
                                ${data.flags.yellow.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                if (data.flags.red && data.flags.red.length > 0) {
                    content += `
                        <div class="flag-box red">
                            <div class="flag-title">ðŸ”´ Red Flags</div>
                            <ul class="flag-list">
                                ${data.flags.red.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                content += '</div>';
                
                // Reasoning
                content += `
                    <div class="reasoning-box" style="margin-bottom: 1.5rem;">
                        <div class="reasoning-heading">AI Fit Analysis (${data.fitScore}/10)</div>
                        <div class="reasoning-text">${data.reasoning}</div>
                    </div>
                `;
                
                // Contacts - paginated display (5 initially, show more on click)
                const allContacts = data.contacts;
                const initialDisplayCount = 5;
                const hasMoreContacts = allContacts.length > initialDisplayCount;
                
                content += '<div class="research-results">';
                content += `<div class="preview-heading">Recommended Contacts <span style="opacity: 0.6; font-size: 0.85rem;">(<span id="contactsShowing">${Math.min(initialDisplayCount, allContacts.length)}</span> of ${allContacts.length}) - Select a contact to generate personalized email</span></div>`;
                content += `<div id="contactsContainer">`;
                
                allContacts.forEach((contact, idx) => {
                    // Source badge - Apollo, Hunter, Manual, or AI
                    let sourceLabel = '';
                    if (contact.source === 'Apollo.io' || contact.apolloVerified) {
                        sourceLabel = '<span style="background: linear-gradient(135deg, #5C6BC0, #3949AB); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">ðŸš€ Apollo</span>';
                    } else if (contact.source === 'Apollo.io (No Email)') {
                        sourceLabel = '<span style="background: linear-gradient(135deg, #5C6BC0, #3949AB); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; opacity: 0.7;">ðŸš€ Apollo (No Email)</span>';
                    } else if (contact.source === 'Hunter.io') {
                        sourceLabel = '<span style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">ðŸ“§ Hunter</span>';
                    } else if (contact.source === 'Manual' || contact.addedBy) {
                        sourceLabel = `<span style="background: linear-gradient(135deg, #6B7280, #4B5563); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">ðŸ‘¤ Manual${contact.apolloSearchDate ? ' (Apollo checked)' : ''}</span>`;
                    } else {
                        sourceLabel = '<span style="background: linear-gradient(135deg, #6B7280, #4B5563); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">ðŸ¤– AI</span>';
                    }
                    
                    // Contact action buttons
                    const contactEmail = contact.email ? encodeURIComponent(contact.email) : '';
                    const contactName = encodeURIComponent(contact.name);
                    
                    // Hide contacts beyond initial display count
                    const hiddenStyle = idx >= initialDisplayCount ? 'display: none;' : '';
                    
                    content += `
                        <div class="contact-card contact-item" id="contact-${firm.id}-${idx}" style="${hiddenStyle}" data-contact-index="${idx}">
                            <div class="contact-header">
                                <div>
                                    <div class="contact-name">${contact.name}${sourceLabel}</div>
                                    <div class="contact-title">${contact.title}</div>
                                </div>
                                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                    <button onclick="openEditContactModal('${firm.id}', ${idx})" style="background: transparent; border: 1px solid var(--gold-accent); color: var(--gold-accent); padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Edit contact">âœï¸</button>
                                    <button onclick="deleteContact('${firm.id}', ${idx})" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Remove contact">âœ•</button>
                                    <div class="confidence-score">
                                        <div class="confidence-label">Confidence</div>
                                        <div class="confidence-value">${contact.confidence}%</div>
                                        <div class="confidence-tooltip">
                                            <h4>ðŸ“Š Confidence Scale</h4>
                                            <table>
                                                <tr><td>90-95%</td><td>Verified contact info, perfect role match (e.g., Chief Data Officer with confirmed email)</td></tr>
                                                <tr><td>80-89%</td><td>Strong match, mostly verified info</td></tr>
                                                <tr><td>70-79%</td><td>Good match, some info inferred (like pattern-matched email)</td></tr>
                                                <tr><td>60-69%</td><td>Possible match, significant uncertainty</td></tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="contact-details">
                                ${contact.email ? `<div class="detail-item">ðŸ“§ ${contact.email} <span style="opacity: 0.7; font-size: 0.8rem;">(${contact.emailConfidence || 'Pattern Match'})</span></div>` : '<div class="detail-item" style="opacity: 0.5;">ðŸ“§ No email found</div>'}
                                ${contact.phone ? `<div class="detail-item">ðŸ“ž ${contact.phone}</div>` : ''}
                                ${contact.linkedIn ? `<div class="detail-item">ðŸ”— <a href="${contact.linkedIn}" target="_blank" style="color: var(--gold-accent);">${contact.linkedIn}</a></div>` : ''}
                            </div>
                            <div class="reasoning-box">
                                <div class="reasoning-heading">Why this contact?</div>
                                <div class="reasoning-text">${contact.reasoning}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(212, 165, 116, 0.1);">
                                <button class="btn btn-sm" onclick="generateOutreachEmailToContact('${firm.id}', ${idx})" style="background: linear-gradient(135deg, var(--green-flag), #04a777); font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                    âœ‰ï¸ Generate Email to ${contact.name.split(' ')[0]}
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="recordContactAttempt('${firm.id}', '${contactName}', 'Email')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;" title="Record that you contacted this person">
                                    ðŸ“§ Mark Emailed
                                </button>
                                ${contact.linkedIn ? `
                                    <button class="btn btn-sm btn-secondary" onclick="recordContactAttempt('${firm.id}', '${contactName}', 'LinkedIn')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;" title="Record LinkedIn contact">
                                        ðŸ’¼ Mark LinkedIn
                                    </button>
                                ` : ''}
                                ${contact.phone ? `
                                    <button class="btn btn-sm btn-secondary" onclick="recordContactAttempt('${firm.id}', '${contactName}', 'Phone')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;" title="Record phone contact">
                                        ðŸ“ž Mark Called
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>'; // Close contactsContainer
                
                // Add "Show More" / "Show Less" buttons if there are more contacts
                if (hasMoreContacts) {
                    const hiddenCount = allContacts.length - initialDisplayCount;
                    content += `
                        <div id="contactsPagination" style="text-align: center; margin: 1rem 0; padding: 1rem; background: rgba(92, 107, 192, 0.1); border-radius: 8px; border: 1px dashed rgba(92, 107, 192, 0.3);">
                            <button id="showMoreContactsBtn" onclick="showMoreContacts('${firm.id}', ${allContacts.length})" class="btn" style="background: linear-gradient(135deg, #5C6BC0, #3949AB);">
                                ðŸ‘ï¸ Show ${hiddenCount} More Contacts
                            </button>
                            <button id="showLessContactsBtn" onclick="showLessContacts('${firm.id}')" class="btn btn-secondary" style="display: none; margin-left: 0.5rem;">
                                ðŸ‘† Show Less
                            </button>
                        </div>
                    `;
                }
                
                content += '</div>';
                
                // Add re-research button
                const llmUsed = data.llmUsed ? LLM_CONFIG[data.llmUsed] : null;
                const llmBadge = llmUsed ? `<span style="background: ${llmUsed.color}20; color: ${llmUsed.color}; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${llmUsed.icon} ${llmUsed.name}</span>` : '';
                
                // Format research date safely
                let researchDateStr = 'Unknown';
                if (firm.researchDate) {
                    const rDate = new Date(firm.researchDate);
                    if (!isNaN(rDate.getTime())) {
                        researchDateStr = `${rDate.toLocaleDateString()} at ${rDate.toLocaleTimeString()}`;
                    }
                }
                
                content += `
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(212, 165, 116, 0.2);">
                        <p style="color: var(--silver); font-size: 0.85rem; margin-bottom: 1rem;">
                            ${llmBadge} Research completed: ${researchDateStr}
                            ${data.actualCost ? ` | Cost: $${data.actualCost.toFixed(4)}` : ''}
                        </p>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn" onclick="openAddContactModal('${firm.id}')" style="background: linear-gradient(135deg, #10b981, #059669);" title="Add a new contact manually (with optional Apollo lookup)">
                                ðŸ‘¤ Add Contact
                            </button>
                            <button class="btn" onclick="generateOutreachEmail('${firm.id}')" style="background: linear-gradient(135deg, var(--green-flag), #04a777);">
                                âœ‰ï¸ Generate Email
                            </button>
                            <button class="btn" onclick="searchWithApollo('${firm.id}')" style="background: linear-gradient(135deg, #7E57C2, #5E35B1);" title="Search Apollo for data buyers, quants & analysts">
                                ðŸ” Search Apollo
                            </button>
                            <button class="btn" onclick="loadMoreApollo('${firm.id}')" style="background: linear-gradient(135deg, #5C6BC0, #3949AB);" title="Load 5 more contacts from Apollo">
                                âž• More Contacts
                            </button>
                            <button class="btn" onclick="enrichWithHunter('${firm.id}')" style="background: linear-gradient(135deg, #ff6b35, #f7931e);" title="Find emails with Hunter.io">
                                ðŸ“§ Find with Hunter
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal('firmDetailsModal'); initiateResearch('${firm.id}');">
                                ðŸ”„ Re-Research
                            </button>
                            ${firm.comparisonData ? `
                                <button class="btn btn-secondary" onclick="closeModal('firmDetailsModal'); showPreviousComparison('${firm.id}');">
                                    âš–ï¸ View Last Comparison
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                // Show Apollo search history warning if exists
                let apolloWarningHtml = '';
                if (firm.apolloSearchHistory && firm.apolloSearchHistory.length > 0) {
                    const lastSearch = firm.apolloSearchHistory[firm.apolloSearchHistory.length - 1];
                    const lastSearchDate = new Date(lastSearch.date);
                    const dateStr = lastSearchDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = lastSearchDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    if (lastSearch.contactsFound === 0) {
                        apolloWarningHtml = `
                            <div style="background: rgba(230, 57, 70, 0.15); border: 1px solid rgba(230, 57, 70, 0.4); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--red-flag); font-weight: 600; margin-bottom: 0.5rem;">
                                    âš ï¸ Apollo Search: No Contacts Found
                                </div>
                                <div style="color: var(--silver); font-size: 0.85rem;">
                                    <div>Last searched: <strong>${dateStr}</strong> at <strong>${timeStr}</strong></div>
                                    <div>Searched by: <strong>${lastSearch.user || 'Unknown'}</strong></div>
                                    <div style="margin-top: 0.5rem; color: var(--yellow-flag);">
                                        ðŸ’¡ Apollo API calls cost credits. Consider trying different search methods or waiting before re-searching.
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        apolloWarningHtml = `
                            <div style="background: rgba(6, 214, 160, 0.1); border: 1px solid rgba(6, 214, 160, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                <div style="color: var(--green-flag); font-size: 0.85rem;">
                                    ðŸš€ Last Apollo search: ${dateStr} - Found ${lastSearch.contactsFound} contacts
                                </div>
                            </div>
                        `;
                    }
                }
                
                content += apolloWarningHtml;
                content += `
                    <p style="color: var(--silver); margin-bottom: 1.5rem;">This firm hasn't been researched yet.</p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn" onclick="initiateResearch('${firm.id}'); closeModal('firmDetailsModal');">
                            ðŸ” Research with AI
                        </button>
                        <button class="btn" onclick="searchWithApollo('${firm.id}')" style="background: linear-gradient(135deg, #7E57C2, #5E35B1);" title="Search Apollo for quants, data scientists & analysts">
                            ðŸš€ Search Apollo
                        </button>
                        <button class="btn" onclick="openAddContactModal('${firm.id}')" style="background: linear-gradient(135deg, #10b981, #059669);" title="Add a contact manually">
                            ðŸ‘¤ Add Contact
                        </button>
                    </div>
                    <p style="color: var(--silver); font-size: 0.8rem; margin-top: 1rem; opacity: 0.7;">
                        ðŸ’¡ "Search Apollo" finds quants, data scientists & analysts directly from Apollo's database
                    </p>
                `;
            }
            
            // Actions - Updated status options
            const statusOptions = ['Not Contacted', 'Contacted', 'Trial Ongoing', 'Client', 'Closed', 'Not a Good Fit'];
            const contactMethods = ['Email', 'Phone', 'LinkedIn'];
            
            // Trial date display for Trial Ongoing status
            const trialDateHtml = firm.status === 'Trial Ongoing' ? `
                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                    <label style="color: var(--silver); font-size: 0.85rem;">
                        Start: <input type="date" value="${firm.trialStartDate || ''}" 
                            onchange="updateTrialDates('${firm.id}', 'start', this.value)"
                            style="padding: 0.3rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 4px;">
                    </label>
                    <label style="color: var(--silver); font-size: 0.85rem;">
                        End: <input type="date" value="${firm.trialEndDate || ''}" 
                            onchange="updateTrialDates('${firm.id}', 'end', this.value)"
                            style="padding: 0.3rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 4px;">
                    </label>
                </div>
            ` : '';
            
            // Contact method display and history
            let contactHistoryHtml = '';
            if (firm.contactHistory && firm.contactHistory.length > 0) {
                const historyRows = firm.contactHistory.map((h, idx) => {
                    const methodIcon = h.method === 'Email' ? 'ðŸ“§' : h.method === 'Phone' ? 'ðŸ“ž' : 'ðŸ’¼';
                    const date = new Date(h.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const time = new Date(h.date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px; margin-bottom: 0.3rem;">
                            <div>
                                <span>${methodIcon} ${h.method}${h.contactPerson ? ` â†’ ${h.contactPerson}` : ''}</span>
                                ${h.notes ? `<div style="color: var(--silver); font-size: 0.75rem; margin-top: 0.2rem; font-style: italic;">"${h.notes}"</div>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--silver); font-size: 0.75rem;">${date} ${time}<br>by ${h.user || 'unknown'}</span>
                                <button onclick="editContactHistoryEntry('${firm.id}', ${idx})" style="background: transparent; border: none; color: var(--gold-accent); cursor: pointer; font-size: 0.8rem;" title="Edit">âœï¸</button>
                                <button onclick="deleteContactHistoryEntry('${firm.id}', ${idx})" style="background: transparent; border: none; color: var(--red-flag); cursor: pointer; font-size: 0.8rem;" title="Delete">ðŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                contactHistoryHtml = `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(212, 165, 116, 0.08); border-radius: 8px; border-left: 3px solid var(--gold-accent);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: var(--gold-accent); font-weight: 600;">ðŸ“ž Contact History (${firm.contactHistory.length})</span>
                            <button class="btn btn-secondary btn-sm" onclick="openAddContactModal('${firm.id}')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                + Add Follow-up
                            </button>
                        </div>
                        ${historyRows}
                    </div>
                `;
            } else {
                contactHistoryHtml = `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(212, 165, 116, 0.08); border-radius: 8px; border-left: 3px solid var(--gold-accent);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--silver);">No contact history yet</span>
                            <button class="btn btn-secondary btn-sm" onclick="openAddContactModal('${firm.id}')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                + Add Contact
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Notes section with follow-up reminder
            const notesHtml = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(69, 123, 157, 0.08); border-radius: 8px; border-left: 3px solid var(--blue-info);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: var(--blue-info); font-weight: 600;">ðŸ“ Notes</span>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-secondary btn-sm" onclick="saveFirmNotes('${firm.id}')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                ðŸ’¾ Save Notes
                            </button>
                        </div>
                    </div>
                    <textarea id="firmNotesTextarea" 
                        style="width: 100%; min-height: 80px; padding: 0.5rem; background: var(--navy-deep); border: 1px solid rgba(212, 165, 116, 0.2); color: var(--white); border-radius: 4px; resize: vertical; font-family: inherit; font-size: 0.85rem;"
                        placeholder="Add notes about this firm... (meetings, discussions, preferences, follow-up reminders)"
                    >${firm.notes || ''}</textarea>
                    
                    <!-- Follow-up Reminder Section -->
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(244, 162, 97, 0.1); border: 1px solid rgba(244, 162, 97, 0.3); border-radius: 6px;">
                        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                            <span style="color: var(--yellow-flag); font-weight: 500; font-size: 0.85rem;">ðŸ”” Set Follow-up Reminder:</span>
                            <input type="date" id="followUpDate_${firm.id}" 
                                style="padding: 0.4rem; background: var(--navy-deep); border: 1px solid rgba(244, 162, 97, 0.4); color: var(--white); border-radius: 4px; font-size: 0.8rem;">
                            <input type="time" id="followUpTime_${firm.id}" value="09:00"
                                style="padding: 0.4rem; background: var(--navy-deep); border: 1px solid rgba(244, 162, 97, 0.4); color: var(--white); border-radius: 4px; font-size: 0.8rem;">
                            <button class="btn btn-sm" onclick="addFollowUpReminder('${firm.id}')" 
                                style="background: linear-gradient(135deg, var(--yellow-flag), #e76f51); font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                âž• Add Reminder
                            </button>
                        </div>
                        ${firm.scheduledReminders && firm.scheduledReminders.length > 0 ? `
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(244, 162, 97, 0.2);">
                                <div style="font-size: 0.75rem; color: var(--silver); margin-bottom: 0.3rem;">Scheduled reminders:</div>
                                ${firm.scheduledReminders.map((r, idx) => {
                                    const rDate = new Date(r.date);
                                    const isPast = rDate < new Date();
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem; background: ${isPast ? 'rgba(230,57,70,0.15)' : 'rgba(255,255,255,0.03)'}; border-radius: 4px; margin-bottom: 0.25rem;">
                                            <span style="color: ${isPast ? 'var(--red-flag)' : 'var(--silver)'}; font-size: 0.8rem;">
                                                ${isPast ? 'âš ï¸ OVERDUE: ' : 'ðŸ“… '}
                                                ${rDate.toLocaleDateString()} at ${rDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}
                                                ${r.notes ? ` - ${r.notes}` : ''}
                                            </span>
                                            <button onclick="deleteReminder('${firm.id}', ${idx})" style="background: transparent; border: none; color: var(--red-flag); cursor: pointer; font-size: 0.7rem;">âœ•</button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Contact method radio buttons
            const contactMethodHtml = `
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label style="color: var(--silver); font-size: 0.85rem;">Contact via:</label>
                    ${contactMethods.map(method => `
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer; color: ${firm.contactMethod === method ? 'var(--gold-accent)' : 'var(--silver)'};">
                            <input type="radio" name="contactMethod" value="${method}" 
                                ${firm.contactMethod === method ? 'checked' : ''} 
                                onchange="updateContactMethod('${firm.id}', '${method}')"
                                style="accent-color: var(--gold-accent);">
                            ${method === 'Email' ? 'ðŸ“§' : method === 'Phone' ? 'ðŸ“ž' : 'ðŸ’¼'} ${method}
                        </label>
                    `).join('')}
                </div>
            `;
            
            content += `
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(212, 165, 116, 0.2);">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem;">
                        <label style="color: var(--silver);">Status:</label>
                        <select onchange="changeStatus('${firm.id}', this.value)" style="padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px;">
                            ${statusOptions.map(s => `<option value="${s}" ${firm.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                        <label style="color: var(--silver);">Assigned to:</label>
                        <select onchange="assignFirmToUser('${firm.id}', this.value)" style="padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(126, 87, 194, 0.3); color: var(--white); border-radius: 6px;">
                            <option value="" ${!firm.assignedTo ? 'selected' : ''}>Unassigned</option>
                            <option value="zabih" ${firm.assignedTo === 'zabih' ? 'selected' : ''}>ðŸ‘¤ Zabih</option>
                            <option value="noor" ${firm.assignedTo === 'noor' ? 'selected' : ''}>ðŸ‘¤ Noor</option>
                            <option value="huzaifa" ${firm.assignedTo === 'huzaifa' ? 'selected' : ''}>ðŸ‘¤ Huzaifa</option>
                        </select>
                        ${contactMethodHtml}
                        ${firm.status === 'Client' ? `
                            <button class="btn" onclick="openSubscriptionManager('${firm.id}')" style="background: linear-gradient(135deg, var(--gold-accent), var(--gold-bright)); color: var(--navy-deep);">
                                ðŸ“¦ Manage Subscriptions
                            </button>
                        ` : ''}
                    </div>
                    ${trialDateHtml}
                    ${contactHistoryHtml}
                    ${notesHtml}
                    ${firm.status === 'Client' && firm.subscriptions && firm.subscriptions.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div class="preview-heading" style="margin-bottom: 0.5rem;">Active Subscriptions</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${firm.subscriptions.map(subKey => {
                                    const product = IQ_PRODUCTS[subKey];
                                    return product ? `<span class="subscription-badge" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">${product.icon} ${product.name}</span>` : '';
                                }).join('')}
                            </div>
                            ${Object.keys(IQ_PRODUCTS).length - firm.subscriptions.length > 0 ? `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(6, 214, 160, 0.1); border-radius: 6px; border-left: 3px solid var(--green-flag);">
                                    <strong style="color: var(--green-flag);">ðŸ’¡ Upsell Opportunities:</strong>
                                    <div style="color: var(--silver); font-size: 0.85rem; margin-top: 0.3rem;">
                                        ${Object.entries(IQ_PRODUCTS).filter(([key]) => !firm.subscriptions.includes(key)).map(([key, prod]) => prod.name).join(', ')}
                                    </div>
                                </div>
                            ` : `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(212, 165, 116, 0.1); border-radius: 6px;">
                                    <strong style="color: var(--gold-accent);">ðŸ† Full Suite Client!</strong>
                                </div>
                            `}
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="editCurrentFirm()">âœï¸ Edit Details</button>
                        <button class="btn btn-secondary" onclick="deleteCurrentFirm()" style="color: var(--red-flag);">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            `;
            
            document.getElementById('firmDetailsContent').innerHTML = content;
            document.getElementById('firmDetailsModal').classList.add('active');
        }
        
        // Edit current firm (using stored ID)
        function editCurrentFirm() {
            console.log('âœï¸ editCurrentFirm called, currentlyOpenFirmId:', currentlyOpenFirmId);
            if (currentlyOpenFirmId) {
                editFirm(currentlyOpenFirmId);
            } else {
                alert('Error: No firm selected. Please close and reopen the firm details.');
            }
        }
        
        // Delete current firm (using stored ID)
        function deleteCurrentFirm() {
            console.log('ðŸ—‘ï¸ deleteCurrentFirm called, currentlyOpenFirmId:', currentlyOpenFirmId);
            if (currentlyOpenFirmId) {
                deleteFirm(currentlyOpenFirmId);
            } else {
                alert('Error: No firm selected. Please close and reopen the firm details.');
            }
        }
        
        // Generate Outreach Email - Step 1: Show LLM selector
        async function generateOutreachEmail(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            // Store firm ID for later
            window.currentEmailFirmId = firmId;
            
            // Check which APIs are available
            const availableLLMs = [];
            if (API_KEYS.claude) availableLLMs.push('claude');
            if (API_KEYS.openai) availableLLMs.push('openai');
            if (API_KEYS.deepseek) availableLLMs.push('deepseek');
            if (API_KEYS.gemini) availableLLMs.push('gemini');
            
            if (availableLLMs.length === 0) {
                alert('No API keys configured. Please add an API key in Settings.');
                return;
            }
            
            // Show the modal with LLM selector
            document.getElementById('emailGenerationModal').classList.add('active');
            document.getElementById('emailGenerationContent').innerHTML = `
                <div style="padding: 1rem;">
                    <h3 style="color: var(--gold-accent); margin-bottom: 1.5rem;">Select AI Model for Email Generation</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        ${availableLLMs.map((llm, idx) => {
                            const config = LLM_CONFIG[llm];
                            return `
                                <label class="llm-option" style="display: flex; flex-direction: column; align-items: center; padding: 1rem; background: var(--navy-light); border: 2px solid ${idx === 0 ? config.color : 'rgba(212, 165, 116, 0.2)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <input type="radio" name="email-llm" value="${llm}" ${idx === 0 ? 'checked' : ''} style="display: none;" onchange="this.parentElement.parentElement.querySelectorAll('.llm-option').forEach(el => el.style.borderColor = 'rgba(212, 165, 116, 0.2)'); this.parentElement.style.borderColor = '${config.color}';">
                                    <span style="font-size: 1.5rem; margin-bottom: 0.5rem;">${config.icon}</span>
                                    <span style="color: var(--white); font-weight: 600;">${config.name}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="background: rgba(69, 123, 157, 0.1); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                        <div style="color: var(--silver); font-size: 0.85rem;">
                            <strong>Generating email for:</strong> ${firm.name}<br>
                            <strong>Strategy:</strong> ${firm.focus || 'Unknown'}<br>
                            <strong>Contact:</strong> ${window.selectedEmailContact?.name || firm.researchData?.contacts?.[0]?.name || 'Team'}
                            ${window.selectedEmailContact ? `<br><strong>Title:</strong> ${window.selectedEmailContact.title}` : ''}
                            ${window.selectedEmailContact?.email ? `<br><strong>Email:</strong> ${window.selectedEmailContact.email}` : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn" onclick="executeEmailGeneration('${firmId}')" style="flex: 1;">
                            âœ‰ï¸ Generate Email
                        </button>
                        <button class="btn btn-secondary" onclick="window.selectedEmailContact = null; closeModal('emailGenerationModal')">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Generate Outreach Email - Step 2: Execute with selected LLM
        async function executeEmailGeneration(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const selectedLLM = document.querySelector('input[name="email-llm"]:checked')?.value;
            if (!selectedLLM) {
                alert('Please select an AI model');
                return;
            }
            
            const config = LLM_CONFIG[selectedLLM];
            
            // Show loading state
            document.getElementById('emailGenerationContent').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="color: var(--silver); margin-top: 1rem;">
                        ${config.icon} ${config.name} is generating your email...
                    </p>
                </div>
            `;
            
            // Build context from research data
            const researchData = firm.researchData || {};
            const discoveryData = firm.discoveryData || {};
            
            const greenFlags = researchData.flags?.green || [];
            const strategy = firm.focus || discoveryData.strategy || 'investment strategy';
            const buyingSignals = discoveryData.buyingSignals || [];
            const dataInterest = discoveryData.dataInterest || researchData.reasoning || '';
            const contacts = researchData.contacts || [];
            const fitScore = researchData.fitScore || 5;
            
            // Use selected contact if available, otherwise use first contact
            let contactName = '';
            let contactTitle = '';
            let contactEmail = '';
            
            if (window.selectedEmailContact) {
                contactName = window.selectedEmailContact.name ? window.selectedEmailContact.name.split(' ')[0] : '';
                contactTitle = window.selectedEmailContact.title || '';
                contactEmail = window.selectedEmailContact.email || '';
            } else if (contacts.length > 0) {
                const firstContact = contacts[0];
                contactName = firstContact.name ? firstContact.name.split(' ')[0] : '';
                contactTitle = firstContact.title || '';
                contactEmail = firstContact.email || '';
            }
            
            // Clear selected contact after use
            window.selectedEmailContact = null;
            
            // Build the email generation prompt - NO JSON, just plain text
            const emailPrompt = `You are Zabih Ullah, Managing Partner at 2iQ Research. Write a short, natural outreach email to ${firm.name}.

**ABOUT THE FIRM:**
- Name: ${firm.name}
- Location: ${firm.location || 'Unknown'}
- AUM: $${firm.aum || 'Unknown'}B
- Strategy: ${strategy}
- Contact: ${contactName || 'the team'}${contactTitle ? ` (${contactTitle})` : ''}
${greenFlags.length > 0 ? `- What we know: ${greenFlags.join(', ')}` : ''}
${buyingSignals.length > 0 ? `- Signals: ${buyingSignals.join(', ')}` : ''}
${dataInterest ? `- Potential interest: ${dataInterest}` : ''}

**2iQ PRODUCTS & STRATEGY FIT:**
Match the RIGHT products to their strategy:

For QUANTITATIVE/SYSTEMATIC funds â†’ Insider Data Feed + Insider Model (predictive signals for systematic strategies)
For EVENT-DRIVEN/M&A funds â†’ Insider Data (insiders trade before announcements) + Short Interest (sentiment indicator)
For LONG/SHORT EQUITY funds â†’ Insider Data (conviction signals) + Short Interest + Buybacks (capital allocation signals)
For MULTI-STRATEGY platforms â†’ Full suite - each pod/team may need different datasets
For MACRO funds â†’ Capitol Trades (policy signals) + Insider Data (sector rotation)
For ASSET MANAGERS â†’ Insider Data for alpha generation + Buybacks for corporate governance

**PRODUCT DETAILS (use naturally, don't list all):**
- Global Insider Data: 60,000+ stocks, 58 countries, tracks what executives are buying/selling
- Insider Model: Quantitative scores predicting insider activity impact
- Short Interest Data: Real-time short selling & securities lending data
- European Short Disclosures: Regulatory short position data
- Buyback Data: Corporate share repurchase tracking
- Capitol Trades: US politicians' stock transactions

**WRITING STYLE:**
- Sound like a real person, not an AI
- NEVER start with "Given", "Based on", "I noticed that", "I came across", "I wanted to reach out"
- Start with a warm, direct greeting
- Get to the point quickly - why YOU specifically might find our data useful
- Be specific about which 1-2 products fit THEIR strategy (not a generic list)
- Keep it conversational, like you're emailing a colleague
- End with a soft ask for a quick call (10-15 mins)

**VARY YOUR OPENINGS - use different approaches:**
- Reference something specific about their firm/strategy
- Lead with a relevant data insight
- Connect to industry trend they'd care about
- Mention a mutual connection or similar client (without naming)

**FORMAT:**
- 2 short paragraphs MAX
- First paragraph: Why 2iQ data specifically fits their strategy
- Second paragraph: Quick mention of next step (brief call)
- Sign off: Best regards, Zabih Ullah

**EXAMPLE TONE (don't copy, just get the vibe):**
"Hi [Name], I work with several [strategy type] funds who use our insider transaction data to [specific use case]. Given [firm]'s focus on [their strategy], I think our [specific product] could add real value to your research process - particularly for [specific application]. Would you have 10-15 minutes this week for a quick call? I can walk you through how similar funds are using the data. Best regards, Zabih Ullah"

Now write a unique, natural email for ${firm.name}. Return ONLY the email text, starting directly with "Hi" - no explanations.`;


            try {
                let emailText = '';
                let actualCost = 0;
                
                // Call the appropriate API and get RAW text response
                if (selectedLLM === 'claude') {
                    const response = await fetch("http://localhost:8001", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": API_KEYS.claude,
                            "anthropic-version": "2023-06-01"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            messages: [{ role: "user", content: emailPrompt }]
                        })
                    });
                    const data = await response.json();
                    emailText = data.content?.[0]?.text || '';
                    actualCost = ((data.usage?.input_tokens || 0) * 0.000003) + ((data.usage?.output_tokens || 0) * 0.000015);
                    
                } else if (selectedLLM === 'openai') {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${API_KEYS.openai}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            max_tokens: 1000,
                            messages: [
                                { role: "system", content: "You are a sales email writer. Return only the email text, no JSON or markdown." },
                                { role: "user", content: emailPrompt }
                            ]
                        })
                    });
                    const data = await response.json();
                    emailText = data.choices?.[0]?.message?.content || '';
                    actualCost = ((data.usage?.prompt_tokens || 0) * 0.0000025) + ((data.usage?.completion_tokens || 0) * 0.00001);
                    
                } else if (selectedLLM === 'deepseek') {
                    const response = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${API_KEYS.deepseek}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            max_tokens: 1000,
                            messages: [
                                { role: "system", content: "You are a sales email writer. Return only the email text, no JSON or markdown." },
                                { role: "user", content: emailPrompt }
                            ]
                        })
                    });
                    const data = await response.json();
                    emailText = data.choices?.[0]?.message?.content || '';
                    actualCost = ((data.usage?.prompt_tokens || 0) * 0.00000014) + ((data.usage?.completion_tokens || 0) * 0.00000028);
                    
                } else if (selectedLLM === 'gemini') {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEYS.gemini}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: emailPrompt }] }],
                            generationConfig: { maxOutputTokens: 1000 }
                        })
                    });
                    const data = await response.json();
                    emailText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    actualCost = 0; // Gemini free tier
                }
                
                // Clean up the email text
                emailText = emailText
                    .replace(/```/g, '')
                    .replace(/^```\w*\n?/gm, '')
                    .replace(/\n```$/gm, '')
                    .trim();
                
                if (!emailText || emailText.length < 50) {
                    throw new Error('Failed to generate email. Please try again.');
                }
                
                // Generate subject line suggestion
                const subjectLine = `2iQ Insider & Short Selling Data for ${firm.name}`;
                
                // Display the email
                displayGeneratedEmail(firm, emailText, subjectLine, config, actualCost);
                
                // Track cost
                if (actualCost) {
                    budgetUsed += actualCost;
                    updateBudgetDisplay();
                }
                
            } catch (error) {
                document.getElementById('emailGenerationContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <span style="font-size: 3rem;">âŒ</span>
                        <p style="color: var(--red-flag); margin-top: 1rem;">${error.message}</p>
                        <button class="btn" onclick="generateOutreachEmail('${firmId}')" style="margin-top: 1rem;">Try Again</button>
                        <button class="btn btn-secondary" onclick="closeModal('emailGenerationModal')" style="margin-top: 1rem; margin-left: 0.5rem;">Close</button>
                    </div>
                `;
            }
        }
        
        // Display generated email
        function displayGeneratedEmail(firm, emailText, subjectLine, config, actualCost) {
            document.getElementById('emailGenerationContent').innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <label style="color: var(--gold-accent); font-weight: 600; display: block; margin-bottom: 0.5rem;">ðŸ“§ Subject Line:</label>
                    <input type="text" id="emailSubject" value="${subjectLine}" 
                        style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px; font-size: 0.95rem;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: var(--gold-accent); font-weight: 600; display: block; margin-bottom: 0.5rem;">âœ‰ï¸ Email Body:</label>
                    <textarea id="emailBody" rows="12" 
                        style="width: 100%; padding: 0.75rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); color: var(--white); border-radius: 6px; font-size: 0.95rem; line-height: 1.6; resize: vertical;">${emailText}</textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn" onclick="copyEmailToClipboard()" style="flex: 1;">
                        ðŸ“‹ Copy Email
                    </button>
                    <button class="btn btn-secondary" onclick="openInEmailClient('${firm.id}')" style="flex: 1;">
                        ðŸ“¤ Open in Email Client
                    </button>
                    <button class="btn btn-secondary" onclick="generateOutreachEmail('${firm.id}')">
                        ðŸ”„ Regenerate
                    </button>
                </div>
                
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(69, 123, 157, 0.1); border-radius: 6px; font-size: 0.8rem; color: var(--silver);">
                    <strong style="color: var(--blue-info);">ðŸ’¡ Tip:</strong> Review and personalize the email before sending.
                    <br><span style="opacity: 0.7;">Generated with ${config.icon} ${config.name} ${actualCost ? `| Cost: $${actualCost.toFixed(4)}` : ''}</span>
                </div>
            `;
        }
        
        // Copy email to clipboard
        function copyEmailToClipboard() {
            const subject = document.getElementById('emailSubject')?.value || '';
            const body = document.getElementById('emailBody')?.value || '';
            const fullEmail = `Subject: ${subject}\n\n${body}`;
            
            navigator.clipboard.writeText(fullEmail).then(() => {
                addNotification('âœ… Copied!', 'Email copied to clipboard', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = fullEmail;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                addNotification('âœ… Copied!', 'Email copied to clipboard', 'success');
            });
        }
        
        // Open in email client
        function openInEmailClient(firmId) {
            const firm = firms.find(f => f.id === firmId);
            const subject = encodeURIComponent(document.getElementById('emailSubject')?.value || '');
            const body = encodeURIComponent(document.getElementById('emailBody')?.value || '');
            
            // Try to get contact email
            let toEmail = '';
            if (firm?.researchData?.contacts?.[0]?.email) {
                toEmail = firm.researchData.contacts[0].email;
            }
            
            const mailtoUrl = `mailto:${toEmail}?subject=${subject}&body=${body}`;
            window.open(mailtoUrl, '_blank');
        }
        
        // Regenerate email
        function regenerateEmail(firmId) {
            generateOutreachEmail(firmId);
        }
        
        // Subscription Manager
        function openSubscriptionManager(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const currentSubs = firm.subscriptions || [];
            
            let content = `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--gold-accent); margin-bottom: 0.5rem;">${firm.name}</h3>
                    <p style="color: var(--silver); font-size: 0.9rem;">Select the 2iQ products this client subscribes to:</p>
                </div>
                
                <div style="display: grid; gap: 0.75rem;">
                    ${Object.entries(IQ_PRODUCTS).map(([key, product]) => `
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: ${currentSubs.includes(key) ? 'rgba(6, 214, 160, 0.15)' : 'rgba(255, 255, 255, 0.03)'}; border: 1px solid ${currentSubs.includes(key) ? 'var(--green-flag)' : 'rgba(197, 209, 224, 0.1)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="checkbox" name="subscription" value="${key}" ${currentSubs.includes(key) ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: var(--green-flag);">
                            <span style="font-size: 1.3rem;">${product.icon}</span>
                            <div style="flex: 1;">
                                <div style="color: var(--white); font-weight: 500;">${product.name}</div>
                                <div style="color: var(--gold-accent); font-size: 0.8rem; font-family: var(--font-mono);">$${product.price.toLocaleString()}/year</div>
                            </div>
                        </label>
                    `).join('')}
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button class="btn" onclick="saveSubscriptions('${firm.id}')" style="flex: 1;">
                        ðŸ’¾ Save Subscriptions
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('clientSubscriptionsModal')">
                        Cancel
                    </button>
                </div>
            `;
            
            document.getElementById('clientSubscriptionsContent').innerHTML = content;
            document.getElementById('clientSubscriptionsModal').classList.add('active');
        }
        
        async function saveSubscriptions(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const checkboxes = document.querySelectorAll('input[name="subscription"]:checked');
            firm.subscriptions = Array.from(checkboxes).map(cb => cb.value);
            
            // Calculate total contract value
            const totalValue = firm.subscriptions.reduce((sum, key) => {
                return sum + (IQ_PRODUCTS[key]?.price || 0);
            }, 0);
            firm.contractValue = totalValue;
            
            await saveToStorage();
            renderDashboard();
            closeModal('clientSubscriptionsModal');
            
            addNotification(
                'âœ… Subscriptions Updated',
                `${firm.name}: ${firm.subscriptions.length} products ($${totalValue.toLocaleString()}/year)`,
                'success'
            );
            
            // Refresh firm details
            openFirmDetails(firm);
        }
        
        // ============================================
        // LOCATION EDITOR FUNCTIONS
        // ============================================
        
        // Store current firm ID for location editing
        let currentLocationEditFirmId = null;
        
        function showLocationEditor(firmId) {
            currentLocationEditFirmId = firmId;
            const editor = document.getElementById('locationEditor');
            if (editor) editor.style.display = 'block';
        }
        
        function hideLocationEditor() {
            const editor = document.getElementById('locationEditor');
            if (editor) editor.style.display = 'none';
        }
        
        // Save location using stored current firm ID
        async function saveCurrentFirmLocation() {
            if (currentlyOpenFirmId) {
                await saveFirmLocationById(currentlyOpenFirmId);
            } else {
                alert('Error: No firm selected');
            }
        }
        
        // Save location using firm ID passed directly
        async function saveFirmLocationById(firmId) {
            console.log('ðŸ“ saveFirmLocationById called with:', firmId);
            const firm = firms.find(f => f.id === firmId);
            if (!firm) {
                console.error('Firm not found:', firmId);
                alert('Error: Firm not found');
                return;
            }
            
            const newLocation = document.getElementById('newLocationInput')?.value?.trim();
            if (!newLocation) {
                alert('Please enter a location');
                return;
            }
            
            firm.location = newLocation;
            await saveToStorage();
            
            // Update the display if element exists
            const displayEl = document.getElementById('firmLocationDisplay');
            if (displayEl) displayEl.textContent = newLocation;
            
            // Refresh filters and dashboard
            populateFilters();
            renderDashboard();
            
            addNotification(
                'ðŸ“ Location Updated',
                `${firm.name} location changed to: ${newLocation}`,
                'success'
            );
        }
        
        async function saveFirmLocation(firmId) {
            // Alias for backward compatibility
            await saveFirmLocationById(firmId);
        }
        
        // ============================================
        // EDIT FIRM FUNCTION
        // ============================================
        
        // Store current edit firm ID
        let currentEditFirmId = null;
        
        function editFirm(firmId) {
            console.log('âœï¸ editFirm called with:', firmId);
            currentEditFirmId = firmId;
            
            const firm = firms.find(f => f.id === firmId);
            if (!firm) {
                console.error('Firm not found:', firmId);
                alert('Error: Firm not found');
                return;
            }
            
            // Create edit modal content
            const editContent = `
                <div style="max-width: 600px;">
                    <h3 style="color: var(--gold-accent); margin-bottom: 1.5rem;">âœï¸ Edit Firm Details</h3>
                    
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">Firm Name</label>
                            <input type="text" id="editFirmName" value="${firm.name || ''}" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                        </div>
                        
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">Location</label>
                            <input type="text" id="editFirmLocation" value="${firm.location || ''}" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                        </div>
                        
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">AUM (in $B)</label>
                            <input type="number" id="editFirmAUM" value="${firm.aum || ''}" step="0.1" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                        </div>
                        
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">Website</label>
                            <input type="text" id="editFirmWebsite" value="${firm.website || ''}" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                        </div>
                        
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">LinkedIn</label>
                            <input type="text" id="editFirmLinkedIn" value="${firm.linkedIn || ''}" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                        </div>
                        
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">Strategy/Focus</label>
                            <input type="text" id="editFirmFocus" value="${firm.focus || ''}" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                        </div>
                        
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">Priority</label>
                            <select id="editFirmPriority" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">
                                <option value="high" ${firm.priority === 'high' ? 'selected' : ''}>ðŸŸ¢ High</option>
                                <option value="medium" ${firm.priority === 'medium' ? 'selected' : ''}>ðŸŸ¡ Medium</option>
                                <option value="low" ${firm.priority === 'low' ? 'selected' : ''}>âšª Low</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; color: var(--silver); margin-bottom: 0.3rem; font-size: 0.85rem;">Notes</label>
                            <textarea id="editFirmNotes" rows="3" style="width: 100%; padding: 0.5rem; background: var(--navy-light); border: 1px solid rgba(212, 165, 116, 0.3); border-radius: 4px; color: var(--white);">${firm.notes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn" onclick="saveEditedFirmCurrent()">ðŸ’¾ Save Changes</button>
                        <button class="btn btn-secondary" onclick="cancelEditFirm()">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('firmDetailsContent').innerHTML = editContent;
        }
        
        // Save edited firm using stored ID
        async function saveEditedFirmCurrent() {
            if (!currentEditFirmId) {
                alert('Error: No firm selected for editing');
                return;
            }
            await saveEditedFirm(currentEditFirmId);
        }
        
        // Cancel edit and return to firm details
        function cancelEditFirm() {
            if (currentEditFirmId) {
                const firm = firms.find(f => f.id === currentEditFirmId);
                if (firm) openFirmDetails(firm);
            } else {
                closeModal('firmDetailsModal');
            }
        }
        
        async function saveEditedFirm(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            // Update firm with edited values
            firm.name = document.getElementById('editFirmName').value.trim() || firm.name;
            firm.location = document.getElementById('editFirmLocation').value.trim() || firm.location;
            firm.aum = parseFloat(document.getElementById('editFirmAUM').value) || firm.aum;
            firm.website = document.getElementById('editFirmWebsite').value.trim();
            firm.linkedIn = document.getElementById('editFirmLinkedIn').value.trim();
            firm.focus = document.getElementById('editFirmFocus').value.trim();
            firm.priority = document.getElementById('editFirmPriority').value;
            firm.notes = document.getElementById('editFirmNotes').value.trim();
            
            await saveToStorage();
            renderDashboard();
            populateFilters();
            
            addNotification(
                'âœ… Firm Updated',
                `${firm.name} details saved successfully`,
                'success'
            );
            
            // Reopen firm details
            openFirmDetails(firm);
        }
        
        async function deleteFirm(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            if (!confirm(`Are you sure you want to delete ${firm.name}?\n\nThis will mark the firm as deleted and it will be hidden from all users.`)) {
                return;
            }
            
            // SOFT DELETE: Mark as deleted instead of removing
            // This prevents resurrection from other users' stale caches
            firm.isDeleted = true;
            firm.deletedAt = new Date().toISOString();
            firm.deletedBy = currentUser;
            
            // Save the soft delete to Google Sheets
            await saveToStorage();
            
            // Remove from local display (but it's still in the array with isDeleted=true)
            // The renderDashboard will filter out deleted firms
            renderDashboard();
            closeModal('firmDetailsModal');
            addNotification('ðŸ—‘ï¸ Firm Deleted', `${firm.name} has been deleted`, 'warning');
            
            // Log the deletion
            logAction('DELETE_FIRM', `Soft deleted: ${firm.name}`, firmId);
        }
        
        // Permanently delete a firm (admin only - actually removes from array)
        async function permanentlyDeleteFirm(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            if (!confirm(`âš ï¸ PERMANENTLY DELETE ${firm.name}?\n\nThis is irreversible and requires a Full Sync to take effect.`)) {
                return;
            }
            
            // Actually remove from array
            firms = firms.filter(f => f.id !== firmId);
            await saveToStorage();
            renderDashboard();
            closeModal('firmDetailsModal');
            addNotification('ðŸ—‘ï¸ Permanently Deleted', `${firm.name} removed. Use Full Sync to delete from Google Sheets.`, 'warning');
        }

        // Re-research a firm (clear old data and research again)
        async function reResearchFirm(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            if (!confirm(`Re-research ${firm.name}?\n\nThis will clear existing research and search for fresh data.\n\nEstimated cost: ~$0.02-0.05`)) {
                return;
            }
            
            // Clear old research
            firm.researchData = null;
            firm.researchDate = null;
            firm.fitScore = null;
            
            await saveToStorage();
            renderDashboard();
            
            closeModal('firmDetailsModal');
            
            // Start new research
            initiateResearch(firmId);
        }

        async function changeStatus(firmId, newStatus) {
            const firm = firms.find(f => f.id === firmId);
            if (firm) {
                const oldStatus = firm.status;
                firm.status = newStatus;
                
                // Auto-assign to current user when moving to Contacted (if not already assigned)
                if (newStatus === 'Contacted' && oldStatus === 'Not Contacted' && !firm.assignedTo) {
                    const username = currentSession?.user?.username || 'unknown';
                    firm.assignedTo = username;
                    firm.assignedDate = new Date().toISOString();
                    firm.assignedBy = username;
                    addNotification('ðŸ‘¤ Auto-Assigned', `${firm.name} assigned to you`, 'info');
                }
                
                // If moving to Trial Ongoing, set default trial dates
                if (newStatus === 'Trial Ongoing' && oldStatus !== 'Trial Ongoing') {
                    const today = new Date();
                    const endDate = new Date(today);
                    endDate.setDate(endDate.getDate() + 14); // Default 14-day trial
                    
                    firm.trialStartDate = today.toISOString().split('T')[0];
                    firm.trialEndDate = endDate.toISOString().split('T')[0];
                    
                    // Also auto-assign if not assigned
                    if (!firm.assignedTo) {
                        const username = currentSession?.user?.username || 'unknown';
                        firm.assignedTo = username;
                        firm.assignedDate = new Date().toISOString();
                        firm.assignedBy = username;
                    }
                    
                    await saveToStorage();
                    renderDashboard();
                    closeModal('firmDetailsModal');
                    addNotification('â³ Trial Started!', `${firm.name} trial started. Default: 14 days.`, 'success');
                }
                // If moving to Client status, prompt to set up subscriptions
                else if (newStatus === 'Client' && oldStatus !== 'Client') {
                    firm.subscriptions = firm.subscriptions || [];
                    
                    // Also auto-assign if not assigned
                    if (!firm.assignedTo) {
                        const username = currentSession?.user?.username || 'unknown';
                        firm.assignedTo = username;
                        firm.assignedDate = new Date().toISOString();
                        firm.assignedBy = username;
                    }
                    
                    await saveToStorage();
                    renderDashboard();
                    closeModal('firmDetailsModal');
                    addNotification('ðŸ† New Client!', `${firm.name} is now a client. Set up their subscriptions.`, 'success');
                    
                    // Open subscription manager
                    setTimeout(() => openSubscriptionManager(firmId), 300);
                } else {
                    await saveToStorage();
                    renderDashboard();
                    closeModal('firmDetailsModal');
                    addNotification('Status Updated', `${firm.name} moved to ${newStatus}`, 'success');
                }
            }
        }
        
        // Assign firm to a sales team member
        async function assignFirmToUser(firmId, assignedUser) {
            const firm = firms.find(f => f.id === firmId);
            if (firm) {
                const previousUser = firm.assignedTo;
                firm.assignedTo = assignedUser || null;
                firm.assignedDate = assignedUser ? new Date().toISOString() : null;
                firm.assignedBy = assignedUser ? currentUser : null;
                
                await saveToStorage();
                renderDashboard();
                
                if (assignedUser) {
                    addNotification('ðŸ‘¤ Lead Assigned', `${firm.name} assigned to ${assignedUser}`, 'success');
                    logAction('ASSIGN_LEAD', `Assigned ${firm.name} to ${assignedUser}${previousUser ? ` (was: ${previousUser})` : ''}`, firmId);
                } else {
                    addNotification('ðŸ‘¤ Lead Unassigned', `${firm.name} is now unassigned`, 'info');
                    logAction('UNASSIGN_LEAD', `Unassigned ${firm.name}${previousUser ? ` (was: ${previousUser})` : ''}`, firmId);
                }
                
                // Refresh the firm details modal if it's open
                if (currentlyOpenFirmId === firmId) {
                    openFirmDetails(firm);
                }
            }
        }
        
        // Update contact method (Email, Phone, LinkedIn)
        async function updateContactMethod(firmId, method, contactPersonName = null) {
            const firm = firms.find(f => f.id === firmId);
            if (firm) {
                const now = new Date().toISOString();
                
                // Initialize contact history if not exists
                if (!firm.contactHistory) {
                    firm.contactHistory = [];
                }
                
                // Add to contact history
                firm.contactHistory.push({
                    method: method,
                    date: now,
                    contactPerson: contactPersonName,
                    user: currentSession?.user?.username || currentUser || 'unknown'
                });
                
                // Update current contact method and date
                firm.contactMethod = method;
                firm.contactDate = now;
                
                // Automatically set status to Contacted if not already past that stage
                if (firm.status === 'Not Contacted') {
                    firm.status = 'Contacted';
                }
                
                await saveToStorage();
                renderDashboard();
                
                const personInfo = contactPersonName ? ` to ${contactPersonName}` : '';
                addNotification('ðŸ“ž Contact Recorded', `${firm.name} contacted via ${method}${personInfo}`, 'info');
                
                // Log the action
                logAction('CONTACTED', `Contacted ${firm.name} via ${method}${personInfo}`, firmId);
                
                // Refresh the firm details modal if open
                if (currentlyOpenFirmId === firmId) {
                    openFirmDetails(firm);
                }
            }
        }
        
        // Add another contact attempt (different method)
        async function addContactAttempt(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const contactMethods = ['Email', 'Phone', 'LinkedIn'];
            const usedMethods = (firm.contactHistory || []).map(h => h.method);
            const availableMethods = contactMethods.filter(m => !usedMethods.includes(m));
            
            let method;
            if (availableMethods.length > 0) {
                method = prompt(`Previous contacts: ${usedMethods.join(', ')}\n\nEnter new contact method (${availableMethods.join('/')}):`, availableMethods[0]);
            } else {
                method = prompt(`All methods tried: ${usedMethods.join(', ')}\n\nEnter contact method for follow-up (Email/Phone/LinkedIn):`, 'Email');
            }
            
            if (method && contactMethods.includes(method)) {
                await updateContactMethod(firmId, method);
            }
        }
        
        // Update trial dates for Trial Ongoing status
        async function updateTrialDates(firmId, dateType, dateValue) {
            const firm = firms.find(f => f.id === firmId);
            if (firm) {
                if (dateType === 'start') {
                    firm.trialStartDate = dateValue;
                } else if (dateType === 'end') {
                    firm.trialEndDate = dateValue;
                }
                
                await saveToStorage();
                renderDashboard();
                addNotification('ðŸ“… Trial Date Updated', `${firm.name} trial ${dateType} date set to ${dateValue}`, 'info');
                logAction('TRIAL_DATE', `Updated ${dateType} date for ${firm.name}`, firmId);
            }
        }
        
        // Open modal to add new contact history entry (recording when you contacted a firm)
        function openAddContactHistoryModal(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            document.getElementById('contactHistoryModalTitle').textContent = 'ðŸ“ž Add Contact';
            document.getElementById('contactHistoryFirmId').value = firmId;
            document.getElementById('contactHistoryEditIndex').value = '-1';
            
            // Set default values
            document.getElementById('contactHistoryMethod').value = 'Email';
            document.getElementById('contactHistoryPerson').value = '';
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('contactHistoryDate').value = today;
            
            // Set default time to now
            const now = new Date();
            const timeStr = now.toTimeString().substring(0, 5);
            document.getElementById('contactHistoryTime').value = timeStr;
            
            document.getElementById('contactHistoryNotes').value = '';
            
            document.getElementById('contactHistoryModal').classList.add('active');
        }
        
        // Edit existing contact history entry
        function editContactHistoryEntry(firmId, idx) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.contactHistory || !firm.contactHistory[idx]) return;
            
            const entry = firm.contactHistory[idx];
            
            document.getElementById('contactHistoryModalTitle').textContent = 'âœï¸ Edit Contact';
            document.getElementById('contactHistoryFirmId').value = firmId;
            document.getElementById('contactHistoryEditIndex').value = idx;
            
            // Fill form with existing data
            document.getElementById('contactHistoryMethod').value = entry.method || 'Email';
            document.getElementById('contactHistoryPerson').value = entry.contactPerson || '';
            
            // Parse date and time from ISO string
            const entryDate = new Date(entry.date);
            document.getElementById('contactHistoryDate').value = entryDate.toISOString().split('T')[0];
            document.getElementById('contactHistoryTime').value = entryDate.toTimeString().substring(0, 5);
            
            document.getElementById('contactHistoryNotes').value = entry.notes || '';
            
            document.getElementById('contactHistoryModal').classList.add('active');
        }
        
        // Delete contact history entry
        async function deleteContactHistoryEntry(firmId, idx) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm || !firm.contactHistory || !firm.contactHistory[idx]) return;
            
            const entry = firm.contactHistory[idx];
            if (!confirm(`Delete this contact entry?\n\n${entry.method} on ${new Date(entry.date).toLocaleDateString()}`)) {
                return;
            }
            
            // Remove the entry
            firm.contactHistory.splice(idx, 1);
            
            // Update current contact method/date to most recent
            if (firm.contactHistory.length > 0) {
                const latest = firm.contactHistory[firm.contactHistory.length - 1];
                firm.contactMethod = latest.method;
                firm.contactDate = latest.date;
            } else {
                firm.contactMethod = null;
                firm.contactDate = null;
            }
            
            await saveToStorage();
            renderDashboard();
            addNotification('ðŸ—‘ï¸ Contact Deleted', 'Contact history entry removed', 'info');
            
            // Refresh firm details if open
            if (currentlyOpenFirmId === firmId) {
                openFirmDetails(firm);
            }
        }
        
        // Save contact history entry (add or edit)
        async function saveContactHistoryEntry(event) {
            event.preventDefault();
            
            const firmId = document.getElementById('contactHistoryFirmId').value;
            const editIndex = parseInt(document.getElementById('contactHistoryEditIndex').value);
            
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            // Get form values
            const method = document.getElementById('contactHistoryMethod').value;
            const person = document.getElementById('contactHistoryPerson').value.trim();
            const dateStr = document.getElementById('contactHistoryDate').value;
            const timeStr = document.getElementById('contactHistoryTime').value || '12:00';
            const notes = document.getElementById('contactHistoryNotes').value.trim();
            
            // Combine date and time into ISO string
            const dateTime = new Date(`${dateStr}T${timeStr}`).toISOString();
            
            // Initialize contact history if not exists
            if (!firm.contactHistory) {
                firm.contactHistory = [];
            }
            
            const entry = {
                method: method,
                date: dateTime,
                contactPerson: person || null,
                notes: notes || null,
                user: currentSession?.user?.username || currentUser || 'unknown'
            };
            
            if (editIndex >= 0 && editIndex < firm.contactHistory.length) {
                // Edit existing entry
                firm.contactHistory[editIndex] = entry;
                addNotification('âœï¸ Contact Updated', `Updated ${method} contact entry`, 'success');
            } else {
                // Add new entry
                firm.contactHistory.push(entry);
                addNotification('ðŸ“ž Contact Added', `Added ${method} contact entry`, 'success');
            }
            
            // Update current contact method/date to most recent
            const sortedHistory = [...firm.contactHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sortedHistory.length > 0) {
                firm.contactMethod = sortedHistory[0].method;
                firm.contactDate = sortedHistory[0].date;
            }
            
            // Automatically set status to Contacted if not already past that stage
            if (firm.status === 'Not Contacted') {
                firm.status = 'Contacted';
            }
            
            await saveToStorage();
            renderDashboard();
            closeModal('contactHistoryModal');
            
            // Refresh firm details if open
            if (currentlyOpenFirmId === firmId) {
                openFirmDetails(firm);
            }
            
            logAction('CONTACT_HISTORY', `${editIndex >= 0 ? 'Edited' : 'Added'} ${method} contact for ${firm.name}`, firmId);
        }
        
        // Save firm notes
        async function saveFirmNotes(firmId) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const notesTextarea = document.getElementById('firmNotesTextarea');
            if (!notesTextarea) return;
            
            firm.notes = notesTextarea.value.trim();
            
            await saveToStorage();
            addNotification('ðŸ“ Notes Saved', `Notes updated for ${firm.name}`, 'success');
            logAction('NOTES_UPDATE', `Updated notes for ${firm.name}`, firmId);
        }
        
        // Record contact attempt from contact card (with person name)
        async function recordContactAttempt(firmId, contactPersonName, method) {
            const decodedName = decodeURIComponent(contactPersonName);
            await updateContactMethod(firmId, method, decodedName);
        }
        
        // Generate email to specific contact
        function generateOutreachEmailToContact(firmId, contactIndex) {
            const firm = firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const contact = firm.researchData?.contacts?.[contactIndex];
            if (!contact) {
                alert('Contact not found');
                return;
            }
            
            // Store selected contact for email generation
            window.selectedEmailContact = contact;
            window.selectedEmailContactIndex = contactIndex;
            
            // Call the regular email generation with the contact pre-selected
            generateOutreachEmail(firmId);
        }

        // Discover leads
        // Import all 167 firms from JSON file
        async function importAll167Firms() {
            // Show import options dialog
            const importMethod = await showImportDialog();
            if (!importMethod) return;
            
            if (importMethod === 'file') {
                await importFromFile();
            } else if (importMethod === 'sample') {
                await importSampleDataSet();
            }
        }
        
        function showImportDialog() {
            return new Promise((resolve) => {
                const dialog = document.createElement('div');
                dialog.className = 'modal active';
                dialog.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <div class="modal-title">ðŸ“Š Import Firms</div>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">Ã—</button>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <p style="color: var(--silver); margin-bottom: 1rem;">Choose an import method:</p>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <button class="btn" id="importFileBtn" style="width: 100%; padding: 1rem;">
                                ðŸ“ Upload JSON/Excel File
                                <div style="font-size: 0.75rem; margin-top: 0.3rem; opacity: 0.8;">Import from firms_167.json or Lead_Generation_2025.xlsx</div>
                            </button>
                            <button class="btn btn-secondary" id="importSampleBtn" style="width: 100%; padding: 1rem;">
                                ðŸŽ¯ Load Sample Dataset (156 firms)
                                <div style="font-size: 0.75rem; margin-top: 0.3rem; opacity: 0.8;">Pre-loaded curated list of target firms</div>
                            </button>
                            <button class="btn btn-secondary" id="cancelImportBtn" style="width: 100%;">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);
                
                document.getElementById('importFileBtn').onclick = () => {
                    dialog.remove();
                    resolve('file');
                };
                document.getElementById('importSampleBtn').onclick = () => {
                    dialog.remove();
                    resolve('sample');
                };
                document.getElementById('cancelImportBtn').onclick = () => {
                    dialog.remove();
                    resolve(null);
                };
            });
        }
        
        async function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.xlsx,.xls,.csv';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                addNotification('ðŸ“Š Reading File', `Processing ${file.name}...`, 'info');
                
                try {
                    let importedFirms = [];
                    
                    if (file.name.endsWith('.json')) {
                        const text = await file.text();
                        importedFirms = JSON.parse(text);
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                        if (typeof XLSX === 'undefined') {
                            alert('Excel import requires SheetJS library. Please use JSON import instead.');
                            return;
                        }
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data);
                        
                        // Process each sheet
                        for (const sheetName of workbook.SheetNames) {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: null });
                            
                            // Map columns to firm structure
                            for (const row of jsonData) {
                                const firmName = row['Company'] || row['Firm'] || row['Company Name'] || row['Name'];
                                if (!firmName || firmName === 'Company' || firmName === 'Firm') continue;
                                
                                importedFirms.push({
                                    name: firmName,
                                    location: row['Location'] || row['Focus'] || 'Unknown',
                                    aum: parseFloat(row['Est. AUM (Billion USD)'] || row['Market Cap/AUM (Billion USD)'] || row['MCap'] || row['AUM'] || 0),
                                    focus: row['Focus / Notes'] || row['Focus'] || '',
                                    dataUsage: row['Data Usage'] || '',
                                    notes: row['Notes'] || '',
                                    website: row['Website'] || '',
                                    linkedIn: row['Company Linkedin'] || row['LinkedIn'] || '',
                                    contactName: row['Employee Name'] || row['Contact Name'] || '',
                                    contactPosition: row['Employee Position'] || row['Contact Position'] || '',
                                    contactEmail: row['Mail'] || row['Email'] || '',
                                    contactPhone: row['Phone'] || '',
                                    source: sheetName
                                });
                            }
                        }
                    }
                    
                    await processImportedFirms(importedFirms, file.name);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert(`âŒ Import Failed\n\n${error.message}`);
                    addNotification('Import Failed', error.message, 'warning');
                }
            };
            
            input.click();
        }
        
        async function importSampleDataSet() {
            addNotification('Import Started', 'Loading curated firm data...', 'info');
            
            // Sample dataset of top priority firms
            const sampleFirms = [
                { name: 'Two Sigma', location: 'NEW YORK', aum: 67.4, focus: 'Quantitative, systematic, alt data', dataUsage: 'VERY HIGH - Insider/10b5-1/Form 144 core', source: 'Quant & Fundamental' },
                { name: 'Citadel', location: 'CHICAGO', aum: 62.0, focus: 'Multi-strategy', dataUsage: 'VERY HIGH - Technology-driven', source: 'Quant & Fundamental' },
                { name: 'Tiger Global', location: 'NEW YORK', aum: 55.0, focus: 'Tech-focused long/short', dataUsage: 'HIGH - Tech sector insider, founder trading', source: 'Quant & Fundamental' },
                { name: 'D.E. Shaw', location: 'NEW YORK', aum: 47.0, focus: 'Quantitative, systematic', dataUsage: 'VERY HIGH - Systematic/quant signals', source: 'Quant & Fundamental' },
                { name: 'Millennium Management', location: 'NEW YORK', aum: 42.0, focus: 'Multi-strategy, stat arb', dataUsage: 'VERY HIGH - Multiple data signals', source: 'Quant & Fundamental' },
                { name: 'Point72', location: 'NEW YORK', aum: 35.0, focus: 'Multi-strategy, fundamental', dataUsage: 'VERY HIGH - Cubist quant unit', source: 'Quant & Fundamental' },
                { name: 'Balyasny Asset Management', location: 'NEW YORK', aum: 31.0, focus: 'Multi-strategy RV, arbitrage, macro', dataUsage: 'VERY HIGH - Quantamental, Chief Data Officer', source: 'Quant & Fundamental' },
                { name: 'Bridgewater Associates', location: 'NEW YORK', aum: 180.0, focus: 'Macro, data-driven', dataUsage: 'HIGH - Macro/systematic focus', source: 'Hedge Funds' },
                { name: 'AQR Capital', location: 'NEW YORK', aum: 98.0, focus: 'Quantitative, factor-based', dataUsage: 'VERY HIGH - Factor models', source: 'Hedge Funds' },
                { name: 'Man Group', location: 'LONDON', aum: 75.0, focus: 'Quantitative, discretionary', dataUsage: 'VERY HIGH - AHL quant unit', source: 'Hedge Funds' },
                { name: 'Marshall Wace', location: 'LONDON', aum: 62.0, focus: 'Long/short equity, systematic', dataUsage: 'VERY HIGH - Symphonic platform', source: 'Hedge Funds' },
                { name: 'Pelham Capital', location: 'LONDON', aum: 15.0, focus: 'Long/short equity', dataUsage: 'HIGH - Fundamental research', source: 'Quant & Fundamental' },
                { name: 'Third Point', location: 'MIAMI', aum: 18.0, focus: 'Event-driven, activist', dataUsage: 'VERY HIGH - Activist specialist', source: 'Quant & Fundamental' },
                { name: 'Select Equity Group', location: 'MIAMI', aum: 20.0, focus: 'Equity long/short, systematic', dataUsage: 'VERY HIGH - Insider data, Form 144', source: 'Quant & Fundamental' },
                { name: 'Avenue Capital', location: 'NEW YORK', aum: 11.0, focus: 'Event-driven credit, distressed debt', dataUsage: 'VERY HIGH - Insider data, 10-K/10-Q', source: 'Quant & Fundamental' },
                { name: 'Elliott Investment', location: 'NEW YORK', aum: 55.0, focus: 'Activist, event-driven', dataUsage: 'VERY HIGH - Activist campaigns', source: 'Hedge Funds' },
                { name: 'Viking Global', location: 'NEW YORK', aum: 30.0, focus: 'Long/short equity', dataUsage: 'HIGH - Fundamental analysis', source: 'Hedge Funds' },
                { name: 'Sculptor Capital', location: 'NEW YORK', aum: 7.0, focus: 'Multi-strategy', dataUsage: 'HIGH - Credit and equity', source: 'Hedge Funds' },
                { name: 'BlackRock', location: 'NEW YORK', aum: 138.0, focus: 'Asset Management', dataUsage: 'Insider sentiment ETFs, quant & hedge funds', source: 'Financial Firms' },
                { name: 'Schonfeld', location: 'NEW YORK', aum: 10.5, focus: 'Multi-strategy, event-driven', dataUsage: 'VERY HIGH - Quantamental', source: 'Quant & Fundamental' },
                { name: 'Voloridge Investment', location: 'MIAMI', aum: 8.0, focus: 'Quantitative, systematic', dataUsage: 'HIGH - Systematic trading patterns', source: 'Quant & Fundamental' },
                { name: 'ExodusPoint Capital', location: 'NEW YORK', aum: 9.0, focus: 'Multi-strategy', dataUsage: 'HIGH - Diverse strategies', source: 'Quant & Fundamental' },
                { name: 'Coatue Management', location: 'NEW YORK', aum: 20.0, focus: 'Tech long/short, growth', dataUsage: 'HIGH - Tech sector focus', source: 'Hedge Funds' },
                { name: 'Lone Pine Capital', location: 'NEW YORK', aum: 16.0, focus: 'Long/short equity', dataUsage: 'HIGH - Fundamental', source: 'Hedge Funds' },
                { name: 'Tudor Investment', location: 'NEW YORK', aum: 11.0, focus: 'Macro, quant', dataUsage: 'HIGH - Macro signals', source: 'Hedge Funds' },
                { name: 'Weiss Asset Management', location: 'MIAMI', aum: 3.0, focus: 'Opportunistic, multi-strategy', dataUsage: 'HIGH - Opportunistic signals', source: 'Quant & Fundamental' },
                { name: 'Jane Street', location: 'NEW YORK', aum: 30.0, focus: 'Quantitative market making', dataUsage: 'VERY HIGH - High frequency', source: 'Quant & Fundamental' },
                { name: 'Hudson River Trading', location: 'NEW YORK', aum: 15.0, focus: 'Quantitative, HFT', dataUsage: 'VERY HIGH - Algorithmic', source: 'Quant & Fundamental' },
                { name: 'Systematica Investments', location: 'LONDON', aum: 7.0, focus: 'Quantitative, trend-following', dataUsage: 'HIGH - Systematic', source: 'Hedge Funds' },
                { name: 'Winton Group', location: 'LONDON', aum: 8.0, focus: 'Quantitative, systematic', dataUsage: 'HIGH - Data-driven', source: 'Hedge Funds' },
                { name: 'Capstone Investment', location: 'NEW YORK', aum: 10.0, focus: 'Volatility, options', dataUsage: 'HIGH - Options data', source: 'Hedge Funds' },
                { name: 'Aspect Capital', location: 'LONDON', aum: 9.0, focus: 'Quantitative, systematic', dataUsage: 'HIGH - Trend signals', source: 'Hedge Funds' }
            ];
            
            await processImportedFirms(sampleFirms, 'Sample Dataset');
        }
        
        async function processImportedFirms(importedFirms, sourceName) {
            let addedCount = 0;
            let skippedCount = 0;
            
            for (const firmData of importedFirms) {
                if (!firmData.name) continue;
                
                // Check if already exists
                const exists = firms.find(f => 
                    f.name.toLowerCase().trim() === firmData.name.toLowerCase().trim()
                );
                
                if (exists) {
                    skippedCount++;
                    continue;
                }
                
                const newId = 'firm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                let priority = 'low';
                const dataUsage = (firmData.dataUsage || '').toUpperCase();
                const aum = parseFloat(firmData.aum) || 0;
                
                if (dataUsage.includes('VERY HIGH') || aum > 20) {
                    priority = 'high';
                } else if (dataUsage.includes('HIGH') || aum > 5) {
                    priority = 'medium';
                }
                
                firms.push({
                    id: newId,
                    name: firmData.name,
                    location: firmData.location || 'Unknown',
                    aum: aum,
                    focus: firmData.focus || '',
                    dataUsage: firmData.dataUsage || '',
                    notes: firmData.notes || '',
                    website: firmData.website || '',
                    linkedIn: firmData.linkedIn || '',
                    contactName: firmData.contactName || '',
                    contactPosition: firmData.contactPosition || '',
                    contactEmail: firmData.contactEmail || '',
                    contactPhone: firmData.contactPhone || '',
                    status: 'Not Contacted',
                    priority: priority,
                    fitScore: null,
                    researchDate: null,
                    researchData: null,
                    source: firmData.source || sourceName,
                    addedBy: currentUser,
                    addedDate: new Date().toISOString(),
                    lockedBy: null
                });
                
                addedCount++;
            }
            
            await saveToStorage();
            renderDashboard();
            populateFilters();
            
            const message = `âœ… Import Complete!\n\nðŸ“Š Added: ${addedCount} firms\nâ­ï¸ Skipped: ${skippedCount} duplicates\nðŸ“ˆ Total firms: ${firms.length}`;
            
            alert(message);
            addNotification('âœ… Import Complete', `Added ${addedCount} firms from ${sourceName}`, 'success');
        }

        async function discoverLeads() {
            if (budgetUsed >= BUDGET_LIMIT) {
                alert('Monthly budget limit reached.');
                return;
            }
            
            // Check which LLMs are configured
            const availableLLMs = [];
            if (API_KEYS.claude) availableLLMs.push('claude');
            if (API_KEYS.openai) availableLLMs.push('openai');
            if (API_KEYS.deepseek) availableLLMs.push('deepseek');
            if (API_KEYS.gemini) availableLLMs.push('gemini');
            
            if (availableLLMs.length === 0) {
                alert('âŒ No API keys configured!\n\nPlease click âš™ï¸ Settings to add at least one API key.');
                return;
            }
            
            // Check search API status
            const hasSearchAPI = SEARCH_API.tavilyKey || SEARCH_API.serperKey;
            const searchApiName = SEARCH_API.tavilyKey ? 'Tavily' : (SEARCH_API.serperKey ? 'Serper' : null);
            
            // Update search API status banner
            const statusBanner = document.getElementById('searchApiStatus');
            if (hasSearchAPI) {
                statusBanner.style.background = 'rgba(6, 214, 160, 0.15)';
                statusBanner.style.border = '1px solid var(--green-flag)';
                statusBanner.innerHTML = `
                    <strong style="color: var(--green-flag);">âœ… Web Search Enabled (${searchApiName})</strong>
                    <span style="color: var(--silver); font-size: 0.85rem;"> - All AI models can now search the web for current leads!</span>
                `;
            } else {
                statusBanner.style.background = 'rgba(244, 162, 97, 0.15)';
                statusBanner.style.border = '1px solid var(--yellow-flag)';
                statusBanner.innerHTML = `
                    <strong style="color: var(--yellow-flag);">âš ï¸ No Search API Configured</strong>
                    <span style="color: var(--silver); font-size: 0.85rem;"> - Add Tavily (free) in Settings to enable web search for all models</span>
                    <br><a href="https://tavily.com" target="_blank" style="color: var(--gold-accent); font-size: 0.8rem;">Get free Tavily API key â†’</a>
                `;
            }
            
            // Populate LLM selection with web search indicators
            const llmSelect = document.getElementById('discoverLLMSelect');
            llmSelect.innerHTML = availableLLMs.map((key, idx) => {
                const config = LLM_CONFIG[key];
                const hasWebSearch = hasSearchAPI || key === 'claude';
                const searchBadge = hasWebSearch 
                    ? '<span style="font-size: 0.65rem; background: var(--green-flag); color: white; padding: 0.1rem 0.3rem; border-radius: 3px; margin-left: 0.3rem;">ðŸ” WEB</span>'
                    : '<span style="font-size: 0.65rem; background: var(--silver); color: var(--navy-deep); padding: 0.1rem 0.3rem; border-radius: 3px; margin-left: 0.3rem;">ðŸ“š KNOWLEDGE</span>';
                
                return `
                    <label class="llm-checkbox" style="--llm-color: ${config.color}; flex: 1; min-width: 140px;">
                        <input type="radio" name="discover-llm" value="${key}" ${idx === 0 ? 'checked' : ''}>
                        <span class="llm-checkbox-content">
                            <span class="llm-icon">${config.icon}</span>
                            <span class="llm-name">${config.name}${searchBadge}</span>
                        </span>
                    </label>
                `;
            }).join('');
            
            // Update recommendation based on search API status
            const recommendationDiv = document.getElementById('llmRecommendation');
            if (hasSearchAPI) {
                recommendationDiv.innerHTML = `
                    <strong style="color: var(--green-flag); font-size: 0.8rem;">ðŸš€ All Models Ready:</strong>
                    <span style="color: var(--silver); font-size: 0.85rem;">
                        ${searchApiName} web search is enabled! All models will search for current job postings, news, and fund launches.
                    </span>
                `;
                recommendationDiv.style.borderColor = 'var(--green-flag)';
                recommendationDiv.style.background = 'rgba(6, 214, 160, 0.1)';
            } else {
                recommendationDiv.innerHTML = `
                    <strong style="color: var(--blue-info); font-size: 0.8rem;">ðŸ’¡ Recommendation:</strong>
                    <span style="color: var(--silver); font-size: 0.85rem;">
                        Use <strong>Claude</strong> (has built-in web search) OR add a <strong>Tavily API key</strong> in Settings to enable web search for all models.
                    </span>
                `;
                recommendationDiv.style.borderColor = 'var(--blue-info)';
                recommendationDiv.style.background = 'rgba(69, 123, 157, 0.15)';
            }
            
            // Show initial content, hide results
            document.getElementById('discoverLeadsContent').style.display = 'block';
            document.getElementById('discoverLeadsResults').style.display = 'none';
            
            document.getElementById('discoverLeadsModal').classList.add('active');
        }
        
        // Research configuration - the searches we'll perform
        const DISCOVERY_SEARCHES = [
            {
                id: 'hiring_altdata',
                name: 'Hiring for Alternative Data Roles',
                query: 'hedge fund hiring "alternative data" OR "data analyst" OR "quantitative researcher" 2024 2025',
                region: 'global',
                priority: 'high'
            },
            {
                id: 'fund_launches',
                name: 'New Fund Launches & Expansions',
                query: 'hedge fund launch OR "new fund" OR expansion quantitative systematic 2024 2025',
                region: 'global',
                priority: 'high'
            },
            {
                id: 'asia_funds',
                name: 'Asian Hedge Fund Growth',
                query: 'hedge fund Singapore OR "Hong Kong" OR China quantitative growth hiring 2024 2025',
                region: 'asia',
                priority: 'medium'
            },
            {
                id: 'altdata_usage',
                name: 'Firms Using Alternative Data',
                query: '"alternative data" hedge fund OR "asset manager" strategy investment',
                region: 'global',
                priority: 'high'
            },
            {
                id: 'insider_interest',
                name: 'Interest in Insider/Short Data',
                query: 'hedge fund "insider trading data" OR "short interest" OR "short selling data" strategy',
                region: 'global',
                priority: 'high'
            },
            {
                id: 'conference_attendees',
                name: 'Alt Data Conference Activity',
                query: '"alternative data" conference OR "Battle of the Quants" OR "QuantMinds" hedge fund speaker',
                region: 'global',
                priority: 'medium'
            }
        ];
        
        // Comprehensive Search Query Database
        const DISCOVERY_SEARCH_QUERIES = {
            // ============= GLOBAL QUERIES =============
            global: {
                hiring: [
                    'hedge fund hiring "alternative data analyst" 2025 2026',
                    'hedge fund "quantitative researcher" hiring 2026',
                    'asset manager "data scientist" quant job opening 2026',
                    'hedge fund "chief data officer" appointment 2026',
                    'investment firm "head of data" hire 2026'
                ],
                launches: [
                    'quantitative hedge fund launch 2025 2026',
                    'new systematic fund launch investment 2026',
                    'hedge fund spin-off launch 2026',
                    '"launches quantitative strategy" fund 2026',
                    'new quant fund AUM seed capital 2026'
                ],
                dataInterest: [
                    'hedge fund "alternative data" vendor partnership 2026',
                    'asset manager "short interest data" strategy 2026',
                    'hedge fund "insider trading data" OR "Form 4 filings" 2026',
                    'investment firm "buyback data" OR "share repurchase"',
                    'fund manager "satellite data" OR "credit card data" alternative'
                ],
                conferences: [
                    '"Battle of the Quants" speaker hedge fund',
                    '"QuantMinds" conference hedge fund presenter',
                    '"alternative data" conference speaker fund manager',
                    'quant investing summit hedge fund 2024',
                    '"Global ARC" alternative data conference'
                ],
                growth: [
                    'hedge fund AUM growth 2024 expansion',
                    'fund manager record performance 2024',
                    'hedge fund opens new office expansion',
                    'asset manager raises capital 2024 billion',
                    'hedge fund team expansion hiring spree'
                ]
            },
            
            // ============= AMERICAS QUERIES =============
            americas: {
                hiring: [
                    'hedge fund "New York" hiring "alternative data" 2024',
                    'quantitative fund "Chicago" data analyst job',
                    'hedge fund "San Francisco" quant researcher hiring',
                    'asset manager "Boston" data scientist opening',
                    'fund "Connecticut" Greenwich hiring quantitative'
                ],
                launches: [
                    'hedge fund launch "New York" 2024 quantitative',
                    'new quant fund "United States" systematic launch',
                    'hedge fund spin-off "Wall Street" 2024',
                    'Canadian hedge fund launch Toronto quantitative',
                    'Latin America hedge fund launch Brazil Mexico'
                ],
                firms: [
                    'Two Sigma Citadel DE Shaw hiring data',
                    'Point72 Millennium quantitative expansion',
                    'Bridgewater AQR systematic fund news',
                    'Renaissance Technologies Medallion quant',
                    'Hudson River Trading Jane Street quantitative'
                ],
                familyOffice: [
                    'family office "United States" alternative data',
                    'single family office New York quantitative',
                    'multi-family office investment data strategy',
                    'US family office hedge fund allocation',
                    'billionaire family office quant investment'
                ]
            },
            
            // ============= EUROPE QUERIES =============
            europe: {
                hiring: [
                    'hedge fund "London" hiring "alternative data" 2024',
                    'quantitative fund "Zurich" data analyst job',
                    'hedge fund "Frankfurt" quant researcher hiring',
                    'asset manager "Amsterdam" data scientist',
                    'fund "Geneva" Switzerland hiring quantitative'
                ],
                launches: [
                    'hedge fund launch "London" 2024 quantitative',
                    'new quant fund "Europe" systematic launch',
                    'hedge fund "Switzerland" Zurich expansion 2024',
                    'Nordic hedge fund launch Stockholm Copenhagen',
                    'European hedge fund launch Paris Frankfurt'
                ],
                firms: [
                    'Man Group AHL quantitative London expansion',
                    'Brevan Howard systematic trading Europe',
                    'Marshall Wace hedge fund London data',
                    'Winton Group quantitative research hiring',
                    'Aspect Capital systematic Europe'
                ],
                familyOffice: [
                    'family office "Europe" alternative data investment',
                    'Swiss family office quantitative strategy',
                    'German family office hedge fund allocation',
                    'UK family office alternative investments',
                    'European family office data-driven investing'
                ],
                regulations: [
                    'European hedge fund UCITS launch 2024',
                    'UK FCA hedge fund registration new',
                    'Luxembourg hedge fund AIFMD launch',
                    'Ireland QIAIF hedge fund registration',
                    'European short selling disclosure hedge fund'
                ]
            },
            
            // ============= ASIA PACIFIC QUERIES =============
            asia: {
                hiring: [
                    'hedge fund "Singapore" hiring "alternative data" 2024',
                    'quantitative fund "Hong Kong" data analyst job',
                    'hedge fund "Tokyo" Japan quant researcher',
                    'asset manager "Sydney" Australia data scientist',
                    'fund "Shanghai" China hiring quantitative'
                ],
                launches: [
                    'hedge fund launch "Singapore" 2024 quantitative',
                    'new quant fund "Hong Kong" systematic launch',
                    'hedge fund "Asia" expansion China Japan 2024',
                    'Australian hedge fund launch Sydney Melbourne',
                    'Korea hedge fund Seoul quantitative launch'
                ],
                firms: [
                    'Dymon Asia hedge fund Singapore expansion',
                    'Hillhouse Capital quantitative China',
                    'Asia hedge fund Sculptor PAG Partners',
                    'Japan hedge fund Sparx quantitative',
                    'Australia Bronte Capital Tribeca quant'
                ],
                familyOffice: [
                    'family office "Singapore" alternative data',
                    'Hong Kong family office quantitative investment',
                    'Asian family office hedge fund allocation',
                    'Chinese family office alternative investments',
                    'Japanese family office data-driven strategy'
                ],
                growth: [
                    'Asia hedge fund AUM growth 2024',
                    'Singapore MAS hedge fund license new',
                    'Hong Kong SFC hedge fund registration',
                    'Greater China hedge fund expansion',
                    'APAC hedge fund industry growth'
                ]
            },
            
            // ============= EMERGING MARKETS QUERIES =============
            emerging: {
                hiring: [
                    'hedge fund "Dubai" UAE hiring quantitative 2024',
                    'asset manager "Middle East" data analyst',
                    'South Africa hedge fund Cape Town hiring',
                    'Israel hedge fund Tel Aviv quantitative',
                    'Abu Dhabi ADIA hedge fund allocation'
                ],
                launches: [
                    'hedge fund launch "Dubai" DIFC 2024',
                    'Middle East hedge fund Abu Dhabi expansion',
                    'African hedge fund launch South Africa',
                    'Israel hedge fund Tel Aviv launch',
                    'Gulf sovereign wealth fund hedge allocation'
                ],
                sovereignWealth: [
                    'sovereign wealth fund alternative data',
                    'ADIA Abu Dhabi hedge fund allocation',
                    'GIC Singapore sovereign wealth quant',
                    'Norway pension fund hedge fund investment',
                    'Saudi PIF hedge fund allocation 2024'
                ]
            },
            
            // ============= STRATEGY-SPECIFIC QUERIES =============
            strategies: {
                quant: [
                    'systematic trading firm hiring data engineer',
                    'quantitative macro fund alternative data',
                    'statistical arbitrage hedge fund expansion',
                    'machine learning quant fund launch',
                    'AI-driven hedge fund systematic strategy'
                ],
                event: [
                    'event-driven hedge fund merger arbitrage',
                    'special situations fund activist investor',
                    'distressed debt hedge fund expansion',
                    'merger arbitrage fund alternative data',
                    'catalyst-driven investment strategy fund'
                ],
                macro: [
                    'global macro hedge fund expansion 2024',
                    'macro fund commodities FX strategy',
                    'discretionary macro fund hiring',
                    'macro hedge fund alternative data',
                    'systematic macro fund launch'
                ],
                multi: [
                    'multi-strategy hedge fund pod expansion',
                    'platform hedge fund new team launch',
                    'multi-manager fund Millennium Citadel style',
                    'multi-strategy fund AUM growth',
                    'pod-based hedge fund hiring'
                ],
                equity: [
                    'long short equity hedge fund expansion',
                    'equity fund fundamental data analytics',
                    'stock picking hedge fund alternative data',
                    'equity hedge fund insider trading data',
                    'fundamental equity fund short interest'
                ],
                family: [
                    'family office direct investment alternative',
                    'single family office hedge fund seeding',
                    'multi-family office alternative allocation',
                    'family office quantitative strategy',
                    'UHNW family office data-driven investment'
                ]
            }
        };
        
        // Function to build search queries based on selections
        function buildSearchQueries(region, strategy, maxResults) {
            const queries = [];
            const regionQueries = DISCOVERY_SEARCH_QUERIES[region] || DISCOVERY_SEARCH_QUERIES.global;
            const strategyQueries = DISCOVERY_SEARCH_QUERIES.strategies[strategy];
            
            // Determine number of searches and results per search
            let numSearches, resultsPerSearch;
            if (maxResults <= 25) { numSearches = 5; resultsPerSearch = 5; }
            else if (maxResults <= 50) { numSearches = 5; resultsPerSearch = 10; }
            else if (maxResults <= 80) { numSearches = 8; resultsPerSearch = 10; }
            else if (maxResults <= 100) { numSearches = 10; resultsPerSearch = 10; }
            else if (maxResults <= 150) { numSearches = 10; resultsPerSearch = 15; }
            else { numSearches = 10; resultsPerSearch = 20; }
            
            // Add region-specific queries
            if (region === 'global') {
                // Mix from all categories
                queries.push(...(regionQueries.hiring || []).slice(0, 2));
                queries.push(...(regionQueries.launches || []).slice(0, 2));
                queries.push(...(regionQueries.dataInterest || []).slice(0, 2));
                queries.push(...(regionQueries.conferences || []).slice(0, 1));
                queries.push(...(regionQueries.growth || []).slice(0, 1));
            } else {
                // Add region-specific queries
                queries.push(...(regionQueries.hiring || []).slice(0, 3));
                queries.push(...(regionQueries.launches || []).slice(0, 2));
                queries.push(...(regionQueries.firms || []).slice(0, 2));
                queries.push(...(regionQueries.familyOffice || []).slice(0, 2));
                if (regionQueries.growth) queries.push(...regionQueries.growth.slice(0, 1));
                if (regionQueries.regulations) queries.push(...regionQueries.regulations.slice(0, 1));
                if (regionQueries.sovereignWealth) queries.push(...regionQueries.sovereignWealth.slice(0, 2));
            }
            
            // Add strategy-specific queries if not "all"
            if (strategy !== 'all' && strategyQueries) {
                queries.push(...strategyQueries.slice(0, 3));
            }
            
            // Shuffle and limit to numSearches
            const shuffled = queries.sort(() => Math.random() - 0.5);
            return {
                queries: shuffled.slice(0, numSearches),
                resultsPerSearch: resultsPerSearch
            };
        }
        
        // Update cost estimate based on selections
        function updateDiscoveryCostEstimate() {
            const maxResults = parseInt(document.getElementById('discoveryMaxResults')?.value || 80);
            const minCost = (maxResults * 0.0003).toFixed(2);
            const maxCost = (maxResults * 0.001).toFixed(2);
            const costEl = document.getElementById('discoveryCostEstimate');
            if (costEl) {
                costEl.textContent = `~$${minCost}-${maxCost}`;
            }
        }
        
        // Data sources we can fetch
        const DATA_SOURCES = {
            holdingsChannel: {
                name: 'Holdings Channel - Top Funds',
                url: 'https://www.holdingschannel.com/all/',
                description: 'List of hedge funds with 13F filings'
            },
            hedgeweek: {
                name: 'HedgeWeek News',
                url: 'https://www.hedgeweek.com/',
                description: 'Industry news and fund updates'
            },
            hedgeFundJournal: {
                name: 'Hedge Fund Journal',
                url: 'https://thehedgefundjournal.com/',
                description: 'Fund profiles and performance'
            }
        };
        
        async function executeDiscoverLeads() {
            const selectedLLM = document.querySelector('input[name="discover-llm"]:checked')?.value;
            if (!selectedLLM) {
                alert('Please select an AI model.');
                return;
            }
            
            // Store which LLM was used for this discovery (for adding leads later)
            window.lastDiscoveryLLM = selectedLLM;
            
            // Get configuration from dropdowns
            const selectedRegion = document.getElementById('discoveryRegion')?.value || 'global';
            const selectedStrategy = document.getElementById('discoveryStrategy')?.value || 'all';
            const maxResults = parseInt(document.getElementById('discoveryMaxResults')?.value || 80);
            
            // Build search queries based on selections
            const { queries: searchQueries, resultsPerSearch } = buildSearchQueries(selectedRegion, selectedStrategy, maxResults);
            
            const config = LLM_CONFIG[selectedLLM];
            const hasSearchAPI = SEARCH_API.tavilyKey || SEARCH_API.serperKey;
            
            // Region display names
            const regionNames = {
                global: 'ðŸŒ Global',
                americas: 'ðŸ‡ºðŸ‡¸ Americas',
                europe: 'ðŸ‡ªðŸ‡º Europe',
                asia: 'ðŸŒ Asia Pacific',
                emerging: 'ðŸŒ Emerging Markets'
            };
            
            const strategyNames = {
                all: 'All Strategies',
                quant: 'Quantitative',
                event: 'Event-Driven',
                macro: 'Global Macro',
                multi: 'Multi-Strategy',
                family: 'Family Offices',
                equity: 'Long/Short Equity'
            };
            
            // Update UI to show research in progress
            document.getElementById('discoverLeadsContent').style.display = 'none';
            document.getElementById('discoverLeadsResults').style.display = 'block';
            
            const resultsDiv = document.getElementById('discoverLeadsResults');
            resultsDiv.innerHTML = `
                <div class="research-log" id="researchLog">
                    <h3 style="color: var(--gold-accent); margin-bottom: 1rem;">ðŸ”¬ Multi-Step Research in Progress</h3>
                    <p style="color: var(--silver); margin-bottom: 0.5rem;">
                        Using ${config.icon} ${config.name} 
                        ${hasSearchAPI ? '+ ðŸ” Tavily Web Search' : (selectedLLM === 'claude' ? '+ Web Search' : '(knowledge mode)')}
                    </p>
                    <p style="color: var(--gold-accent); font-size: 0.85rem; margin-bottom: 1rem;">
                        ${regionNames[selectedRegion]} â€¢ ${strategyNames[selectedStrategy]} â€¢ ${searchQueries.length} searches Ã— ${resultsPerSearch} results
                    </p>
                    <div id="researchSteps"></div>
                </div>
                <div id="discoveryResults" style="display: none;"></div>
            `;
            
            const stepsDiv = document.getElementById('researchSteps');
            const researchLog = [];
            let allFindings = [];
            let totalCost = 0;
            let searchResults = [];
            
            // Helper to add log entry
            function addLogEntry(icon, text, status = 'running') {
                const entry = document.createElement('div');
                entry.className = 'research-step';
                entry.style.cssText = 'display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 0.5rem;';
                
                const statusIcon = status === 'running' ? 'â³' : status === 'done' ? 'âœ…' : 'âŒ';
                entry.innerHTML = `
                    <span style="font-size: 1.2rem;">${icon}</span>
                    <div style="flex: 1;">
                        <div style="color: var(--white); font-size: 0.9rem;">${text}</div>
                        <div class="step-details" style="color: var(--silver); font-size: 0.8rem; margin-top: 0.3rem;"></div>
                    </div>
                    <span class="step-status">${statusIcon}</span>
                `;
                stepsDiv.appendChild(entry);
                return entry;
            }
            
            function updateLogEntry(entry, details, status) {
                entry.querySelector('.step-details').innerHTML = details;
                entry.querySelector('.step-status').textContent = status === 'done' ? 'âœ…' : status === 'error' ? 'âŒ' : 'â³';
            }
            
            try {
                // STEP 1: Web Search (Tavily for all models, or Claude's native search)
                console.log('ðŸ” Search API status:', { 
                    hasTavily: !!SEARCH_API.tavilyKey, 
                    hasSerper: !!SEARCH_API.serperKey,
                    hasSearchAPI: hasSearchAPI,
                    selectedLLM: selectedLLM
                });
                
                if (hasSearchAPI) {
                    // Use Tavily/Serper for web search - works with ALL models
                    const searchEntry = addLogEntry('ðŸ”', `Performing ${searchQueries.length} targeted searches via Tavily...`);
                    
                    for (let i = 0; i < searchQueries.length; i++) {
                        const query = searchQueries[i];
                        try {
                            const result = await webSearch(query, resultsPerSearch);
                            if (result && result.results) {
                                searchResults.push({
                                    query: query,
                                    results: result.results.map(r => ({
                                        title: r.title,
                                        url: r.url,
                                        content: r.content || r.snippet
                                    }))
                                });
                            }
                            updateLogEntry(searchEntry, 
                                `Search ${i + 1}/${searchQueries.length}: "${query.substring(0, 45)}..."`, 
                                'running'
                            );
                        } catch (e) {
                            console.warn('Search failed:', query, e);
                        }
                    }
                    
                    const totalResults = searchResults.reduce((sum, s) => sum + s.results.length, 0);
                    updateLogEntry(searchEntry, 
                        `Completed ${searchResults.length} searches, found ${totalResults} results`, 
                        searchResults.length > 0 ? 'done' : 'error'
                    );
                    
                    researchLog.push({
                        step: 'Web Searches (Tavily)',
                        searches: searchQueries,
                        resultsCount: totalResults,
                        findings: totalResults
                    });
                }
                
                // STEP 2: AI Analysis
                const analysisEntry = addLogEntry(config.icon, `${config.name} analyzing leads...`);
                
                // Build region and strategy context for prompts
                const regionContext = {
                    global: 'Focus on firms worldwide - Americas, Europe, and Asia Pacific.',
                    americas: 'Focus on firms in the United States, Canada, and Latin America. Key cities: New York, Chicago, San Francisco, Boston, Greenwich, Toronto.',
                    europe: 'Focus on firms in Europe. Key cities: London, Zurich, Geneva, Frankfurt, Amsterdam, Paris, Stockholm, Dublin.',
                    asia: 'Focus on firms in Asia Pacific. Key cities: Singapore, Hong Kong, Tokyo, Sydney, Shanghai, Seoul, Mumbai.',
                    emerging: 'Focus on firms in emerging markets. Key regions: Middle East (Dubai, Abu Dhabi), Africa (South Africa), Israel.'
                };
                
                const strategyContext = {
                    all: 'Include all hedge fund strategies.',
                    quant: 'Focus on quantitative and systematic trading funds - stat arb, systematic macro, machine learning-driven strategies.',
                    event: 'Focus on event-driven funds - merger arbitrage, special situations, activist investors, distressed debt.',
                    macro: 'Focus on global macro funds - discretionary and systematic macro strategies.',
                    multi: 'Focus on multi-strategy platforms and pod-based hedge funds.',
                    family: 'Focus on family offices - single family offices and multi-family offices with $1B+ AUM.',
                    equity: 'Focus on long/short equity funds - fundamental equity, stock-picking strategies.'
                };
                
                // 2iQ Product & Client Knowledge Base
                const twoIQContext = `
**ABOUT 2iQ RESEARCH:**
2iQ Research is the leading global insider transaction data provider, founded in 2002. Coverage: 60,000+ stocks across 58 countries, 476,000+ insiders tracked.

**2iQ PRODUCT SUITE (from website):**
1. INSIDER DATA FEED - Raw insider transaction data with full details, daily/hourly/realtime delivery
2. INSIDER MODEL - Quantitative model with predictive scores for insider activity
3. SHORT INTEREST DATA FEED & MODEL - Global short selling data from investment banks & passive lenders
4. EUROPEAN SHORT INTEREST DATA FEED - EU short selling disclosure data
5. SEC FORM 144 FILINGS - Notices of proposed sale of securities
6. SEC RULE 10b5-1 PLANS - Pre-arranged insider trading plans data
7. GLOBAL SHARE BUYBACK DATA FEED - Corporate share repurchase data
8. CAPITOL TRADES - US politician stock trading disclosures (Senators, Representatives)

**EXAMPLE 2iQ CLIENTS (for reference - similar firms are ideal targets):**
- Multi-Strategy Platforms: Citadel, Millennium, Balyasny, Point72, Schonfeld
- Quantitative Funds: PDT Partners, Squarepoint Capital, Jump Trading
- Event-Driven/Activist: Elliott Advisors, Tiger Global
- Investment Bank Quant Desks: Morgan Stanley

**IDEAL CUSTOMER PROFILE:**
âœ“ Multi-strategy hedge funds with quantitative pods
âœ“ Systematic/quantitative hedge funds ($500M+ AUM)
âœ“ Event-driven funds (use insider signals for M&A plays)
âœ“ Long/short equity funds using fundamental data
âœ“ Large asset managers with quant research teams
âœ“ Prop trading firms focused on equities
âœ“ Family offices with systematic investment approaches

**NOT A GOOD FIT:**
âœ— Pure crypto/digital asset funds
âœ— Real estate focused funds
âœ— Venture capital / early stage PE
âœ— Funds with <$200M AUM (typically can't afford)
âœ— Pure fixed income / credit funds (no equity exposure)
âœ— Passive index funds / ETF providers
`;
                
                // Build prompt with search results if available
                let analysisPrompt;
                
                // Get list of existing firm names to exclude (including soft-deleted ones)
                const existingFirmNames = firms
                    .filter(f => !f.isDeleted)
                    .map(f => f.name)
                    .slice(0, 100); // Limit to avoid token overflow
                
                const exclusionList = existingFirmNames.length > 0 
                    ? `\n**FIRMS ALREADY IN OUR DATABASE (DO NOT INCLUDE THESE):**\n${existingFirmNames.join(', ')}\n`
                    : '';
                
                if (searchResults.length > 0) {
                    // We have web search results - feed them to the AI
                    const searchContext = searchResults.map(s => 
                        `**Search: "${s.query}"**\n` + 
                        s.results.map(r => `- ${r.title}: ${r.content?.substring(0, 200) || 'No content'}...\n  URL: ${r.url}`).join('\n')
                    ).join('\n\n');
                    
                    analysisPrompt = `You are a sales intelligence expert for 2iQ Research, an alternative data provider.

**SEARCH FOCUS:**
- Region: ${regionNames[selectedRegion]} - ${regionContext[selectedRegion]}
- Strategy: ${strategyNames[selectedStrategy]} - ${strategyContext[selectedStrategy]}

${twoIQContext}
${exclusionList}

**WEB SEARCH RESULTS:**
${searchContext}

**YOUR TASK:**
Analyze these search results to identify NEW hedge funds and asset managers that are GOOD FITS for 2iQ's products.
Focus on finding RECENT NEWS about:
- New fund launches or spinoffs
- Executive appointments (CDO, Head of Data, Quant Research)
- Office expansions or new team formations
- Data partnership announcements
- Strong performance or AUM milestones

**BUYING SIGNALS TO LOOK FOR:**
1. ðŸ’¼ Hiring for data roles (Alternative Data Analyst, Quant Researcher, Data Engineer)
2. ðŸ¢ Multi-strategy platform expanding pods or teams
3. ðŸ“ˆ Event-driven fund activity (M&A, activist campaigns)
4. ðŸŽ¤ Speaking at quant/alternative data conferences
5. ðŸ“° Launching quantitative or systematic strategies
6. ðŸ’° Strong performance leading to AUM growth
7. ðŸ”„ Expanding into new markets or strategies
8. ðŸ†• NEW: Banks/institutions forming quant divisions (like JPMorgan example)

**PRIORITY DEFINITIONS:**
- HOT: Actively hiring for data roles OR mentioned using/seeking insider/short/alternative data OR similar to existing 2iQ clients
- WARM: Multi-strategy platform, event-driven focus, expanding, strong performance
- COLD: General fit but no immediate buying signal

**IMPORTANT FILTERING:**
- ONLY include firms that match the IDEAL CUSTOMER PROFILE above
- EXCLUDE crypto-only funds, VC firms, real estate funds, pure fixed income
- EXCLUDE firms under $200M AUM
- EXCLUDE any firms from the "ALREADY IN DATABASE" list above
- Prefer firms similar to 2iQ's existing clients (Citadel, Millennium, Point72, etc.)
- Focus on ACTIONABLE NEWS - recent events that indicate buying intent

**Return ONLY valid JSON:**
{
  "findings": [
    {
      "name": "Actual Fund Name from search results",
      "location": "City, Country",
      "aum": "AUM if mentioned or Unknown",
      "strategy": "Multi-Strategy/Quantitative/Event-Driven/Long-Short Equity/etc",
      "buyingSignals": ["Specific signal from search result"],
      "dataInterest": "Which 2iQ products they'd likely want and why",
      "source": "URL from search results",
      "priority": "hot/warm/cold",
      "confidence": 70-95,
      "region": "Americas/Europe/Asia/Emerging"
    }
  ],
  "research_summary": "Summary of what you found"
}`;
                } else if (selectedLLM === 'claude') {
                    // Claude with native web search
                    analysisPrompt = `You are a sales intelligence researcher for 2iQ Research.

**SEARCH FOCUS:**
- Region: ${regionNames[selectedRegion]} - ${regionContext[selectedRegion]}
- Strategy: ${strategyNames[selectedStrategy]} - ${strategyContext[selectedStrategy]}

${twoIQContext}

**IMPORTANT:** Use your web_search tool to find CURRENT information based on the focus above.

**IDEAL TARGETS:** Multi-strategy platforms, quantitative hedge funds, event-driven funds - similar to Citadel, Millennium, Point72, Balyasny, PDT Partners.

**EXCLUDE:** Crypto funds, VC firms, real estate funds, pure fixed income, funds under $200M AUM.

**Return JSON with leads found:**
{
  "searches_performed": ["actual searches"],
  "findings": [
    {
      "name": "Fund Name",
      "location": "City, Country",
      "aum": "X billion",
      "strategy": "Multi-Strategy/Quantitative/Event-Driven/Long-Short Equity",
      "buyingSignals": ["Signal"],
      "dataInterest": "Which 2iQ products and why",
      "source": "URL",
      "priority": "hot/warm/cold",
      "confidence": 70-95,
      "region": "Americas/Europe/Asia/Emerging"
    }
  ],
  "research_summary": "Summary"
}`;
                } else {
                    // Other models without search - use knowledge
                    analysisPrompt = `You are a sales intelligence expert. Based on your knowledge of the hedge fund industry, identify REAL firms that would buy alternative data.

**SEARCH FOCUS:**
- Region: ${regionNames[selectedRegion]} - ${regionContext[selectedRegion]}
- Strategy: ${strategyNames[selectedStrategy]} - ${strategyContext[selectedStrategy]}

${twoIQContext}
${exclusionList}

**IDENTIFY 8-15 REAL FIRMS matching the focus above that are similar to existing 2iQ clients (Citadel, Millennium, Point72, Balyasny, Elliott, PDT Partners, Squarepoint, Jump Trading).**

**IMPORTANT:** 
- EXCLUDE any firms listed in "ALREADY IN DATABASE" above
- EXCLUDE Crypto funds, VC firms, real estate funds, pure fixed income, funds under $200M AUM
- Focus on lesser-known but qualified firms, not just the famous names

**Return JSON:**
{
  "methodology": "How you identified firms",
  "findings": [
    {
      "name": "Real Fund Name",
      "location": "City, Country",
      "aum": "Estimated AUM",
      "strategy": "Multi-Strategy/Quantitative/Event-Driven/Long-Short Equity",
      "buyingSignals": ["Why they'd buy insider/short/buyback data"],
      "dataInterest": "Which 2iQ products and why",
      "source": "Industry knowledge",
      "priority": "hot/warm/cold",
      "confidence": 60-85,
      "region": "Americas/Europe/Asia/Emerging"
    }
  ],
  "research_summary": "Summary"
}`;
                }
                
                try {
                    let result;
                    console.log('ðŸ“¤ Sending to', selectedLLM, 'with prompt length:', analysisPrompt.length);
                    
                    if (selectedLLM === 'claude') {
                        result = await callClaudeAPI(null, analysisPrompt, API_KEYS.claude);
                    } else if (selectedLLM === 'openai') {
                        result = await callOpenAIAPI(null, analysisPrompt, API_KEYS.openai);
                    } else if (selectedLLM === 'deepseek') {
                        result = await callDeepSeekAPI(null, analysisPrompt, API_KEYS.deepseek);
                    } else if (selectedLLM === 'gemini') {
                        result = await callGeminiAPI(null, analysisPrompt, API_KEYS.gemini);
                    }
                    
                    console.log('ðŸ“¥ Result from', selectedLLM + ':', result);
                    
                    totalCost += result.actualCost || 0.03;
                    
                    const findings = result.findings || result.leads || [];
                    const summary = result.research_summary || result.methodology || result.reasoning || 'Analysis complete';
                    
                    console.log(`ðŸ“Š Extracted ${findings.length} findings from ${selectedLLM}`);
                    
                    // If no findings but we had search results, something went wrong with parsing
                    let debugInfo = '';
                    if (findings.length === 0) {
                        console.warn('âš ï¸ AI returned no findings');
                        console.warn('   Raw result keys:', Object.keys(result));
                        console.warn('   result.findings:', result.findings);
                        console.warn('   result.leads:', result.leads);
                        
                        // Store debug info for display
                        debugInfo = `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(230, 57, 70, 0.1); border-radius: 4px; font-size: 0.75rem;">
                                <strong style="color: var(--yellow-flag);">Debug:</strong>
                                <span style="color: var(--silver);">
                                    Result keys: [${Object.keys(result).join(', ')}] | 
                                    findings: ${JSON.stringify(result.findings)} | 
                                    leads: ${JSON.stringify(result.leads)}
                                </span>
                            </div>
                        `;
                    }
                    
                    updateLogEntry(analysisEntry, 
                        `Found ${findings.length} potential leads. ${summary.substring(0, 100)}...${debugInfo}`, 
                        findings.length > 0 ? 'done' : 'error'
                    );
                    
                    researchLog.push({
                        step: `${config.name} Analysis`,
                        methodology: summary,
                        findings: findings.length,
                        cost: result.actualCost || 0.03,
                        debugInfo: findings.length === 0 ? `Keys: ${Object.keys(result).join(', ')}` : null
                    });
                    
                    allFindings = allFindings.concat(findings);
                    
                } catch (error) {
                    updateLogEntry(analysisEntry, `Error: ${error.message}`, 'error');
                    researchLog.push({ step: `${config.name} Analysis`, error: error.message });
                }
                
                // STEP 3: Deduplicate and check against existing firms
                const dedupeEntry = addLogEntry('ðŸ”„', 'Deduplicating and checking existing list...');
                
                // Helper function to normalize firm names for comparison
                function normalizeFirmName(name) {
                    if (!name) return '';
                    return name.toLowerCase()
                        .replace(/[^a-z0-9]/g, '') // Remove all non-alphanumeric
                        .replace(/(llc|ltd|lp|inc|corp|group|capital|management|partners|fund|hedge|asset|investments?|advisors?|holdings?)/g, '')
                        .trim();
                }
                
                // Remove duplicates by name
                const uniqueFindings = [];
                const seenNames = new Set();
                
                for (const lead of allFindings) {
                    const normalizedName = normalizeFirmName(lead.name);
                    if (normalizedName && normalizedName.length > 2 && !seenNames.has(normalizedName)) {
                        seenNames.add(normalizedName);
                        
                        // Check if already in our list using normalized comparison
                        // Only match active (non-deleted) firms
                        const existingFirm = firms.filter(f => !f.isDeleted).find(f => {
                            const existingNormalized = normalizeFirmName(f.name);
                            
                            // Exact match after normalization
                            if (existingNormalized === normalizedName) return true;
                            
                            // One contains the other (but only if the shorter one is substantial)
                            const shorter = existingNormalized.length < normalizedName.length ? existingNormalized : normalizedName;
                            const longer = existingNormalized.length < normalizedName.length ? normalizedName : existingNormalized;
                            
                            // Only match if shorter name is at least 6 chars and is 70%+ of longer
                            if (shorter.length >= 6 && longer.includes(shorter) && shorter.length / longer.length > 0.7) {
                                return true;
                            }
                            
                            // Prefix match - only if first 8+ chars match (more conservative)
                            if (existingNormalized.length >= 8 && normalizedName.length >= 8 &&
                                existingNormalized.substring(0, 8) === normalizedName.substring(0, 8)) {
                                return true;
                            }
                            
                            return false;
                        });
                        
                        lead.alreadyExists = !!existingFirm;
                        lead.existingFirmId = existingFirm?.id;
                        
                        if (lead.alreadyExists) {
                            console.log(`ðŸ”„ Duplicate found: "${lead.name}" matches existing "${existingFirm.name}"`);
                        }
                        
                        uniqueFindings.push(lead);
                    }
                }
                
                const newLeads = uniqueFindings.filter(l => !l.alreadyExists);
                const existingLeads = uniqueFindings.filter(l => l.alreadyExists);
                
                updateLogEntry(dedupeEntry, 
                    `${uniqueFindings.length} unique leads (${newLeads.length} new, ${existingLeads.length} already in list)`, 
                    'done'
                );
                
                // Step 3: Prioritize and display results
                const priorityEntry = addLogEntry('ðŸ“Š', 'Prioritizing leads...');
                
                // Sort by priority and confidence
                const priorityOrder = { hot: 0, warm: 1, cold: 2 };
                uniqueFindings.sort((a, b) => {
                    const pDiff = (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
                    if (pDiff !== 0) return pDiff;
                    return (b.confidence || 0) - (a.confidence || 0);
                });
                
                const hotCount = uniqueFindings.filter(l => l.priority === 'hot').length;
                const warmCount = uniqueFindings.filter(l => l.priority === 'warm').length;
                
                updateLogEntry(priorityEntry, 
                    `ðŸ”¥ ${hotCount} hot leads, â™¨ï¸ ${warmCount} warm leads`, 
                    'done'
                );
                
                // Update budget
                budgetUsed += totalCost;
                updateBudgetDisplay();
                await saveToStorage();
                
                // Display final results
                displayDiscoveredLeadsWithLog(uniqueFindings, researchLog, totalCost);
                
                addNotification(
                    'âœ… Discovery Complete',
                    `Found ${uniqueFindings.length} leads (${hotCount} hot, ${newLeads.length} new)`,
                    'success'
                );
                
            } catch (error) {
                console.error('Discovery error:', error);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--red-flag);">
                        <h3>âŒ Discovery Failed</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" onclick="discoverLeads()" style="margin-top: 1rem;">Try Again</button>
                    </div>
                `;
                addNotification('âŒ Discovery Failed', error.message, 'warning');
            }
        }
        
        function displayDiscoveredLeadsWithLog(leads, researchLog, totalCost) {
            const resultsDiv = document.getElementById('discoveryResults');
            resultsDiv.style.display = 'block';
            
            // Build detailed research log
            const logHTML = researchLog.map(log => {
                let details = '';
                
                if (log.step.includes('Web Search') || log.step.includes('Tavily')) {
                    details = `
                        <div style="margin-top: 0.5rem;">
                            ${log.searches ? `
                                <div style="color: var(--gold-accent); font-size: 0.75rem; margin-bottom: 0.3rem;">ðŸ” Searches performed:</div>
                                <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.75rem; color: var(--silver);">
                                    ${log.searches.map(s => `<li>"${s.substring(0, 60)}${s.length > 60 ? '...' : ''}"</li>`).join('')}
                                </ul>
                            ` : ''}
                            ${log.resultsCount !== undefined ? `
                                <div style="color: var(--green-flag); font-size: 0.8rem; margin-top: 0.3rem;">
                                    ðŸ“„ ${log.resultsCount} web results fetched
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else if (log.methodology) {
                    details = `<div style="color: var(--silver); font-size: 0.8rem; margin-top: 0.3rem;">${log.methodology}</div>`;
                }
                
                return `
                    <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.02); border-radius: 6px; border-left: 3px solid ${log.error ? 'var(--red-flag)' : 'var(--green-flag)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: var(--white);">${log.error ? 'âŒ' : 'âœ…'} ${log.step}</strong>
                            ${log.cost ? `<span style="color: var(--gold-accent); font-size: 0.75rem;">$${log.cost.toFixed(4)}</span>` : ''}
                        </div>
                        ${log.error ? `<div style="color: var(--red-flag); font-size: 0.8rem; margin-top: 0.3rem;">Error: ${log.error}</div>` : ''}
                        ${log.findings !== undefined ? `<div style="color: var(--green-flag); font-size: 0.8rem; margin-top: 0.3rem;">Found: ${log.findings} leads</div>` : ''}
                        ${details}
                    </div>
                `;
            }).join('');
            
            // Update research log section
            document.getElementById('researchLog').innerHTML = `
                <details open style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: var(--gold-accent); font-weight: 600; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                        ðŸ“‹ Research Log - ${researchLog.length} steps completed
                    </summary>
                    <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0 0 6px 6px; margin-top: -0.3rem;">
                        ${logHTML}
                        <div style="color: var(--gold-bright); font-weight: 600; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            ðŸ’° Total Cost: $${totalCost.toFixed(4)}
                        </div>
                    </div>
                </details>
            `;
            
            // Count stats
            const hotCount = leads.filter(l => l.priority === 'hot').length;
            const warmCount = leads.filter(l => l.priority === 'warm').length;
            const coldCount = leads.filter(l => l.priority === 'cold').length;
            const newCount = leads.filter(l => !l.alreadyExists).length;
            const asiaCount = leads.filter(l => 
                l.region === 'Asia' || 
                (l.location && (l.location.includes('Singapore') || l.location.includes('Hong Kong') || l.location.includes('China') || l.location.includes('Tokyo') || l.location.includes('Shanghai')))
            ).length;
            
            let html = `
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <span style="background: rgba(6, 214, 160, 0.2); color: var(--green-flag); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">
                        âœ¨ ${newCount} New Leads
                    </span>
                    ${hotCount > 0 ? `
                        <span style="background: rgba(230, 57, 70, 0.2); color: var(--red-flag); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">
                            ðŸ”¥ ${hotCount} Hot
                        </span>
                    ` : ''}
                    ${warmCount > 0 ? `
                        <span style="background: rgba(244, 162, 97, 0.2); color: var(--yellow-flag); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">
                            â™¨ï¸ ${warmCount} Warm
                        </span>
                    ` : ''}
                    ${coldCount > 0 ? `
                        <span style="background: rgba(69, 123, 157, 0.2); color: var(--blue-info); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">
                            â„ï¸ ${coldCount} Cold
                        </span>
                    ` : ''}
                    ${asiaCount > 0 ? `
                        <span style="background: rgba(69, 123, 157, 0.2); color: var(--blue-info); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">
                            ðŸŒ ${asiaCount} Asia
                        </span>
                    ` : ''}
                </div>
            `;
            
            if (leads.length === 0) {
                const hasSearchAPI = SEARCH_API.tavilyKey || SEARCH_API.serperKey;
                html += `
                    <div style="text-align: center; padding: 2rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ”</div>
                        <p style="color: var(--silver); margin-bottom: 1rem; font-size: 1.1rem;">No leads extracted from search results</p>
                        <p style="color: var(--silver); font-size: 0.85rem; margin-bottom: 1rem;">
                            The AI searched but couldn't extract structured lead data. This can happen when:
                        </p>
                        <ul style="text-align: left; color: var(--silver); font-size: 0.85rem; max-width: 400px; margin: 0 auto 1rem;">
                            <li>Search results didn't contain relevant firm names</li>
                            <li>The AI response wasn't in the expected format</li>
                            <li>Network issues interrupted the search</li>
                        </ul>
                        ${!hasSearchAPI ? `
                            <div style="background: rgba(244, 162, 97, 0.15); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                                <strong style="color: var(--yellow-flag);">ðŸ’¡ Tip:</strong>
                                <span style="color: var(--silver);">Add a <a href="https://tavily.com" target="_blank" style="color: var(--gold-accent);">Tavily API key</a> (free) in Settings to enable web search for ALL models!</span>
                            </div>
                        ` : ''}
                        <button class="btn" onclick="discoverLeads()" style="margin-top: 1rem;">ðŸ”„ Try Again</button>
                    </div>
                `;
            } else {
                leads.forEach((lead, idx) => {
                    const priorityBadge = lead.priority === 'hot' 
                        ? '<span style="background: var(--red-flag); color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ðŸ”¥ HOT</span>'
                        : lead.priority === 'warm'
                        ? '<span style="background: var(--yellow-flag); color: var(--navy-deep); padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">â™¨ï¸ WARM</span>'
                        : '<span style="background: var(--blue-info); color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">â„ï¸ COLD</span>';
                    
                    const signals = lead.buyingSignals || lead.signals || [];
                    const isAsia = lead.region === 'Asia' || (lead.location && (lead.location.includes('Singapore') || lead.location.includes('Hong Kong') || lead.location.includes('China')));
                    
                    html += `
                        <div class="discovered-lead ${lead.alreadyExists ? 'already-exists' : ''}" style="${lead.priority === 'hot' ? 'border-color: var(--red-flag); border-width: 2px;' : ''}">
                            <div class="lead-header">
                                <div>
                                    <div class="lead-name">
                                        ${lead.name} ${priorityBadge}
                                        ${isAsia ? '<span style="font-size: 0.8rem; margin-left: 0.3rem;">ðŸŒ</span>' : ''}
                                    </div>
                                    <div class="lead-meta">
                                        ðŸ“ ${lead.location || 'Unknown'} â€¢ 
                                        ðŸ’° ${lead.aum || '?'} AUM â€¢ 
                                        ${lead.strategy || 'Unknown'}
                                    </div>
                                </div>
                                ${lead.alreadyExists ? '<span class="already-in-list">âš ï¸ In List</span>' : ''}
                            </div>
                            
                            ${signals.length > 0 ? `
                                <div class="lead-signals">
                                    ${signals.map(s => `<span class="signal-tag positive">âœ“ ${s}</span>`).join('')}
                                </div>
                            ` : ''}
                            
                            ${lead.dataInterest ? `
                                <div style="background: rgba(212, 165, 116, 0.1); padding: 0.6rem; border-radius: 6px; margin: 0.5rem 0; border-left: 3px solid var(--gold-accent);">
                                    <strong style="color: var(--gold-accent); font-size: 0.75rem;">ðŸ’¡ 2iQ FIT:</strong>
                                    <span style="color: var(--silver); font-size: 0.85rem;"> ${lead.dataInterest}</span>
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span style="font-size: 0.75rem; color: var(--silver);">
                                        ðŸ“ ${lead.source || 'Industry knowledge'}
                                    </span>
                                    <span style="font-size: 0.75rem; color: var(--gold-accent);">
                                        ${lead.confidence || '?'}% confidence
                                    </span>
                                </div>
                                ${lead.alreadyExists ? `
                                    <button class="btn btn-secondary" onclick="closeModal('discoverLeadsModal'); openFirmDetails(firms.find(f => f.id === '${lead.existingFirmId}'));" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                        View Existing
                                    </button>
                                ` : `
                                    <button class="btn" onclick="addDiscoveredLead(${idx})" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                        âž• Add to Pipeline
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(212, 165, 116, 0.2);">
                    <button class="btn" onclick="discoverLeads()" style="flex: 1;">
                        ðŸ” New Search
                    </button>
                    ${leads.filter(l => !l.alreadyExists).length > 0 ? `
                        <button class="btn btn-secondary" onclick="addAllNewLeads()" style="flex: 1;">
                            âž• Add All New (${leads.filter(l => !l.alreadyExists).length})
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="closeModal('discoverLeadsModal')">
                        Close
                    </button>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Store leads for adding
            window.discoveredLeads = leads;
        }
        
        async function addAllNewLeads() {
            const newLeads = (window.discoveredLeads || []).filter(l => !l.alreadyExists);
            if (newLeads.length === 0) return;
            
            if (!confirm(`Add all ${newLeads.length} new leads to your pipeline?`)) return;
            
            // Get the LLM that was used for discovery
            const usedLLM = window.lastDiscoveryLLM || 'Unknown';
            const usedLLMName = LLM_CONFIG[usedLLM]?.name || usedLLM;
            const now = new Date();
            const currentUsername = currentSession?.user?.username || currentUser || 'unknown';
            
            // Show progress notification
            addNotification('â³ Adding Leads...', `Adding ${newLeads.length} leads to pipeline`, 'info');
            
            for (let i = 0; i < newLeads.length; i++) {
                const lead = newLeads[i];
                
                let priority = 'medium';
                if (lead.priority === 'hot' || lead.confidence >= 85) priority = 'high';
                else if (lead.priority === 'cold' || lead.confidence < 70) priority = 'low';
                
                const newFirm = {
                    id: 'firm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_' + i,
                    name: lead.name,
                    location: lead.location || 'Unknown',
                    aum: parseFloat(lead.aum) || null,
                    website: lead.website || null,
                    focus: lead.strategy || null,
                    status: 'Not Contacted',
                    priority: priority,
                    // Standard tracking fields
                    source: 'AI Discovery',
                    addedBy: currentUsername,
                    addedDate: now.toISOString(),
                    dateAdded: now.toISOString(),
                    // Discovery-specific data
                    discoveryData: {
                        buyingSignals: lead.buyingSignals || lead.signals || [],
                        dataInterest: lead.dataInterest,
                        source: lead.source,
                        originalPriority: lead.priority,
                        confidence: lead.confidence,
                        region: lead.region,
                        discoveredDate: now.toISOString(),
                        discoveredBy: usedLLMName,
                        discoveredByModel: usedLLM
                    }
                };
                
                firms.push(newFirm);
                lead.alreadyExists = true;
                lead.existingFirmId = newFirm.id;
            }
            
            await saveToStorage();
            renderDashboard();
            
            // Update all lead cards in UI
            const leadCards = document.querySelectorAll('.discovered-lead');
            leadCards.forEach((card, idx) => {
                const lead = window.discoveredLeads?.[idx];
                if (lead?.alreadyExists) {
                    card.classList.add('already-exists');
                    card.style.transition = 'all 0.3s ease';
                    
                    // Update button to show "Added"
                    const btn = card.querySelector('button.btn:not(.btn-secondary)');
                    if (btn && btn.textContent.includes('Add to Pipeline')) {
                        btn.outerHTML = `
                            <span style="background: var(--green-flag); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">
                                âœ… Added!
                            </span>
                        `;
                    }
                    
                    // Add badge if not already present
                    const header = card.querySelector('.lead-header');
                    if (header && !header.querySelector('.already-in-list')) {
                        const badge = document.createElement('span');
                        badge.className = 'already-in-list';
                        badge.innerHTML = 'âœ… Added';
                        header.appendChild(badge);
                    }
                }
            });
            
            // Hide the "Add All New" button
            const addAllBtn = document.querySelector('button[onclick="addAllNewLeads()"]');
            if (addAllBtn) {
                addAllBtn.outerHTML = `
                    <span style="background: var(--green-flag); color: white; padding: 0.6rem 1rem; border-radius: 6px; font-weight: 600; flex: 1; text-align: center;">
                        âœ… All ${newLeads.length} Leads Added!
                    </span>
                `;
            }
            
            addNotification('âœ… Bulk Add Complete', `Added ${newLeads.length} new leads to pipeline`, 'success');
        }
        
        async function addDiscoveredLead(index) {
            const lead = window.discoveredLeads?.[index];
            if (!lead) return;
            
            // Get the LLM that was used for discovery
            const usedLLM = window.lastDiscoveryLLM || 'Unknown';
            const usedLLMName = LLM_CONFIG[usedLLM]?.name || usedLLM;
            
            // Determine priority based on lead priority and confidence
            let priority = 'medium';
            if (lead.priority === 'hot' || lead.confidence >= 85) priority = 'high';
            else if (lead.priority === 'cold' || lead.confidence < 70) priority = 'low';
            
            const now = new Date();
            const newFirm = {
                id: 'firm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: lead.name,
                location: lead.location || 'Unknown',
                aum: parseFloat(lead.aum) || null,
                website: lead.website || null,
                focus: lead.strategy || null,
                status: 'Not Contacted',
                priority: priority,
                // Standard tracking fields
                source: 'AI Discovery',
                addedBy: currentSession?.user?.username || currentUser || 'unknown',
                addedDate: now.toISOString(),
                dateAdded: now.toISOString(),
                // Discovery-specific data
                discoveryData: {
                    buyingSignals: lead.buyingSignals || lead.signals || [],
                    dataInterest: lead.dataInterest,
                    decisionMaker: lead.decisionMaker,
                    reasoning: lead.reasoning,
                    source: lead.source,
                    originalPriority: lead.priority,
                    confidence: lead.confidence,
                    region: lead.region,
                    discoveredDate: now.toISOString(),
                    discoveredBy: usedLLMName,
                    discoveredByModel: usedLLM
                }
            };
            
            firms.push(newFirm);
            await saveToStorage();
            renderDashboard();
            
            // Mark as added in UI
            lead.alreadyExists = true;
            lead.existingFirmId = newFirm.id;
            
            // Update the specific lead card in the UI with animation
            const leadCards = document.querySelectorAll('.discovered-lead');
            if (leadCards[index]) {
                const card = leadCards[index];
                // Add flash animation
                card.style.transition = 'all 0.3s ease';
                card.classList.add('already-exists');
                card.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    card.style.transform = 'scale(1)';
                }, 200);
                
                // Update the button to "Added âœ“"
                const btn = card.querySelector('button.btn:not(.btn-secondary)');
                if (btn) {
                    btn.outerHTML = `
                        <span style="background: var(--green-flag); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">
                            âœ… Added!
                        </span>
                    `;
                }
                
                // Add "In List" badge
                const header = card.querySelector('.lead-header');
                if (header && !header.querySelector('.already-in-list')) {
                    const badge = document.createElement('span');
                    badge.className = 'already-in-list';
                    badge.innerHTML = 'âœ… Added to Pipeline';
                    header.appendChild(badge);
                }
            }
            
            // Update the "Add All New" button count
            const addAllBtn = document.querySelector('button[onclick="addAllNewLeads()"]');
            if (addAllBtn) {
                const remaining = (window.discoveredLeads || []).filter(l => !l.alreadyExists).length;
                if (remaining > 0) {
                    addAllBtn.textContent = `âž• Add All New (${remaining})`;
                } else {
                    addAllBtn.style.display = 'none';
                }
            }
            
            addNotification('âœ… Lead Added', `${lead.name} added as ${priority} priority`, 'success');
        }

        // Budget tracking
        function updateBudgetDisplay() {
            const percentage = (budgetUsed / BUDGET_LIMIT) * 100;
            const fill = document.getElementById('budgetFill');
            fill.style.width = percentage + '%';
            
            if (percentage >= 80) {
                fill.classList.add('warning');
                if (percentage >= 80 && percentage < 81 && budgetUsed > 0) {
                    addNotification('Budget Alert', '80% of monthly budget consumed', 'warning');
                }
            }
            
            document.getElementById('budgetText').textContent = `$${budgetUsed.toFixed(2)} / $${BUDGET_LIMIT}`;
        }

        // Notifications
        async function addNotification(title, text, type = 'info') {
            const notification = {
                id: generateId(),
                title,
                text,
                type,
                timestamp: new Date().toISOString()
            };
            notifications.unshift(notification);
            
            // Keep only last 50
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            await saveToStorage();
            updateNotificationBadge();
            renderNotifications();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unread = notifications.filter(n => !n.read).length;
            if (unread > 0) {
                badge.classList.add('has-alerts');
            } else {
                badge.classList.remove('has-alerts');
            }
        }

        async function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('open');
            
            // Mark all as read
            notifications.forEach(n => n.read = true);
            await saveToStorage();
            updateNotificationBadge();
        }

        function renderNotifications() {
            const list = document.getElementById('notificationsList');
            if (notifications.length === 0) {
                list.innerHTML = '<p style="color: var(--silver); text-align: center;">No notifications</p>';
                return;
            }
            
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.type === 'priority' ? 'priority' : ''}">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-text">${n.text}</div>
                    <div class="notification-time">${formatDate(n.timestamp)}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // LOCATION & STRATEGY DATA NORMALIZATION
        // ==========================================
        
        // Define known geographic locations (cities/regions) - EXPANDED for global coverage
        const KNOWN_LOCATIONS = [
            // Americas - US
            'NEW YORK', 'CHICAGO', 'SAN FRANCISCO', 'LOS ANGELES', 'BOSTON', 
            'MIAMI', 'GREENWICH', 'STAMFORD', 'SEATTLE', 'DALLAS', 'HOUSTON',
            'DENVER', 'ATLANTA', 'PHILADELPHIA', 'WASHINGTON DC', 'AUSTIN',
            'PALO ALTO', 'MENLO PARK', 'NEWPORT BEACH', 'WESTPORT',
            // Americas - Other
            'TORONTO', 'MONTREAL', 'VANCOUVER', 'CALGARY',
            'SAO PAULO', 'MEXICO CITY', 'BUENOS AIRES', 'SANTIAGO',
            'CAYMAN ISLANDS', 'BERMUDA',
            
            // Europe - UK & Ireland
            'LONDON', 'EDINBURGH', 'DUBLIN', 'JERSEY', 'GUERNSEY',
            // Europe - Continental
            'ZURICH', 'GENEVA', 'LUGANO', 'PARIS', 'FRANKFURT', 'MUNICH',
            'AMSTERDAM', 'ROTTERDAM', 'STOCKHOLM', 'COPENHAGEN', 'OSLO', 'HELSINKI',
            'MILAN', 'ROME', 'MADRID', 'BARCELONA', 'LISBON', 'VIENNA',
            'LUXEMBOURG', 'BRUSSELS', 'MONACO',
            
            // Asia Pacific - Greater China
            'HONG KONG', 'SHANGHAI', 'BEIJING', 'SHENZHEN', 'GUANGZHOU', 'TAIPEI',
            // Asia Pacific - Southeast
            'SINGAPORE',
            // Asia Pacific - Japan & Korea
            'TOKYO', 'OSAKA', 'SEOUL',
            // Asia Pacific - South Asia
            'MUMBAI', 'BANGALORE', 'NEW DELHI', 'HYDERABAD',
            // Asia Pacific - Australia & NZ
            'SYDNEY', 'MELBOURNE', 'BRISBANE', 'PERTH', 'AUCKLAND', 'WELLINGTON',
            
            // Middle East
            'DUBAI', 'ABU DHABI', 'RIYADH', 'DOHA', 'KUWAIT CITY', 'MANAMA', 'MUSCAT',
            'TEL AVIV', 'JERUSALEM',
            
            // Africa
            'CAPE TOWN', 'JOHANNESBURG', 'LAGOS', 'NAIROBI', 'CAIRO',
            
            // Regions (for flexible matching)
            'UAE', 'UNITED ARAB EMIRATES', 'SAUDI ARABIA', 'SWITZERLAND',
            'UNITED KINGDOM', 'UK', 'USA', 'UNITED STATES'
        ];
        
        // Location aliases for normalization
        const LOCATION_ALIASES = {
            'NYC': 'NEW YORK', 'NY': 'NEW YORK', 'N.Y.': 'NEW YORK', 'MANHATTAN': 'NEW YORK',
            'LA': 'LOS ANGELES', 'L.A.': 'LOS ANGELES',
            'SF': 'SAN FRANCISCO', 'S.F.': 'SAN FRANCISCO', 'BAY AREA': 'SAN FRANCISCO',
            'UK': 'LONDON', 'GB': 'LONDON', 'ENGLAND': 'LONDON', 'BRITAIN': 'LONDON',
            'HK': 'HONG KONG', 'H.K.': 'HONG KONG',
            'SG': 'SINGAPORE',
            'UAE': 'DUBAI', 'UNITED ARAB EMIRATES': 'DUBAI',
            'CH': 'ZURICH', 'SWITZERLAND': 'ZURICH',
            'DE': 'FRANKFURT', 'GERMANY': 'FRANKFURT',
            'JP': 'TOKYO', 'JAPAN': 'TOKYO',
            'AU': 'SYDNEY', 'AUSTRALIA': 'SYDNEY',
            'CA': 'TORONTO', 'CANADA': 'TORONTO',
            'BR': 'SAO PAULO', 'BRAZIL': 'SAO PAULO',
            'IN': 'MUMBAI', 'INDIA': 'MUMBAI',
            'KR': 'SEOUL', 'KOREA': 'SEOUL', 'SOUTH KOREA': 'SEOUL',
            'ZA': 'JOHANNESBURG', 'SOUTH AFRICA': 'JOHANNESBURG',
            'IL': 'TEL AVIV', 'ISRAEL': 'TEL AVIV',
            'NL': 'AMSTERDAM', 'NETHERLANDS': 'AMSTERDAM', 'HOLLAND': 'AMSTERDAM',
            'FR': 'PARIS', 'FRANCE': 'PARIS',
            'ES': 'MADRID', 'SPAIN': 'MADRID',
            'IT': 'MILAN', 'ITALY': 'MILAN',
            'SE': 'STOCKHOLM', 'SWEDEN': 'STOCKHOLM',
            'DK': 'COPENHAGEN', 'DENMARK': 'COPENHAGEN',
            'NO': 'OSLO', 'NORWAY': 'OSLO',
            'IE': 'DUBLIN', 'IRELAND': 'DUBLIN',
            'AT': 'VIENNA', 'AUSTRIA': 'VIENNA',
            'BE': 'BRUSSELS', 'BELGIUM': 'BRUSSELS',
            'PT': 'LISBON', 'PORTUGAL': 'LISBON',
            'FI': 'HELSINKI', 'FINLAND': 'HELSINKI',
            'SA': 'RIYADH', 'KSA': 'RIYADH',
            'QA': 'DOHA', 'QATAR': 'DOHA',
            'KW': 'KUWAIT CITY', 'KUWAIT': 'KUWAIT CITY',
            'BH': 'MANAMA', 'BAHRAIN': 'MANAMA',
            'OM': 'MUSCAT', 'OMAN': 'MUSCAT',
            'EG': 'CAIRO', 'EGYPT': 'CAIRO',
            'NG': 'LAGOS', 'NIGERIA': 'LAGOS',
            'KE': 'NAIROBI', 'KENYA': 'NAIROBI',
            'NZ': 'AUCKLAND', 'NEW ZEALAND': 'AUCKLAND',
            'TW': 'TAIPEI', 'TAIWAN': 'TAIPEI',
            'CN': 'SHANGHAI', 'CHINA': 'SHANGHAI', 'PRC': 'SHANGHAI',
            'MX': 'MEXICO CITY', 'MEXICO': 'MEXICO CITY',
            'AR': 'BUENOS AIRES', 'ARGENTINA': 'BUENOS AIRES',
            'CL': 'SANTIAGO', 'CHILE': 'SANTIAGO'
        };
        
        // Normalize and determine if a value is a location or firm type
        function normalizeLocation(location) {
            if (!location || location === '-' || location === 'Unknown') return null;
            
            const normalized = location.toUpperCase().trim();
            
            // Check aliases first
            if (LOCATION_ALIASES[normalized]) {
                return LOCATION_ALIASES[normalized];
            }
            
            // Check if it's a known location (exact match)
            if (KNOWN_LOCATIONS.includes(normalized)) {
                return normalized;
            }
            
            // Check if it contains a known location
            for (const knownLoc of KNOWN_LOCATIONS) {
                if (normalized.includes(knownLoc)) {
                    return knownLoc;
                }
            }
            
            // Check for partial matches in location string (e.g., "Dubai, UAE" â†’ "DUBAI")
            for (const knownLoc of KNOWN_LOCATIONS) {
                if (knownLoc.length > 3 && normalized.includes(knownLoc.substring(0, 4))) {
                    return knownLoc;
                }
            }
            
            // Check common location patterns with regex
            if (normalized.match(/^(NYC|NY|N\.?Y\.?)$/i)) return 'NEW YORK';
            if (normalized.match(/^(LA|L\.?A\.?)$/i)) return 'LOS ANGELES';
            if (normalized.match(/^(SF|S\.?F\.?)$/i)) return 'SAN FRANCISCO';
            if (normalized.match(/^(UK|GB|ENGLAND)$/i)) return 'LONDON';
            if (normalized.match(/^(HK|H\.?K\.?)$/i)) return 'HONG KONG';
            if (normalized.match(/^(SG)$/i)) return 'SINGAPORE';
            if (normalized.match(/DUBAI|ABU DHABI|UAE|EMIRATES/i)) return 'DUBAI';
            if (normalized.match(/RIYADH|SAUDI/i)) return 'RIYADH';
            if (normalized.match(/TEL AVIV|ISRAEL/i)) return 'TEL AVIV';
            
            return null; // Not a location - likely a firm type
        }
        
        // Extract firm type from location field (when it contains type instead of location)
        function extractFirmType(location) {
            if (!location || location === '-') return null;
            
            const normalized = location.trim();
            
            // If it's NOT a known location, it's probably a firm type
            if (!normalizeLocation(normalized)) {
                return normalized;
            }
            return null;
        }
        
        // Get proper location and firm type for each firm
        function getNormalizedFirmData(firm) {
            const rawLocation = firm.location || '';
            const rawFocus = firm.focus || '';
            
            let actualLocation = normalizeLocation(rawLocation);
            let firmType = firm.focus || extractFirmType(rawLocation) || '';
            
            // If location field contains a firm type, use it as the focus
            if (!actualLocation && rawLocation && rawLocation !== 'Unknown') {
                firmType = rawLocation;
                actualLocation = 'Unknown';
            }
            
            return {
                location: actualLocation || 'Unknown',
                firmType: firmType
            };
        }

        // ==========================================
        // ENHANCED FILTERS WITH COUNTS
        // ==========================================
        
        function populateFilters() {
            console.log('ðŸ”§ populateFilters() called, firms count:', firms.length);
            
            try {
                // Priority countries for 2iQ target market
                const priorityCountries = ['United States', 'United Kingdom', 'Hong Kong', 'Singapore', 'Switzerland'];
                
                // All countries list
                const allCountries = [
                    'Australia', 'Austria', 'Belgium', 'Brazil', 'Canada', 'China', 'Denmark', 'Finland', 
                    'France', 'Germany', 'Greece', 'Hong Kong', 'India', 'Indonesia', 'Ireland', 'Israel', 
                    'Italy', 'Japan', 'Luxembourg', 'Malaysia', 'Mexico', 'Netherlands', 'New Zealand', 
                    'Norway', 'Philippines', 'Poland', 'Portugal', 'Qatar', 'Russia', 'Saudi Arabia', 
                    'Singapore', 'South Africa', 'South Korea', 'Spain', 'Sweden', 'Switzerland', 'Taiwan', 
                    'Thailand', 'Turkey', 'UAE', 'United Kingdom', 'United States', 'Vietnam'
                ];
                
                // Get unique locations from existing firms
                const locationSet = new Set();
                firms.forEach(f => {
                    try {
                        // Get location directly from firm
                        const loc = f.location || '';
                        if (loc && loc !== 'Unknown' && loc.trim() !== '') {
                            locationSet.add(loc.trim());
                        }
                    } catch (e) {
                        console.warn('Error getting location from firm:', f.name, e);
                    }
                });
                
                console.log('ðŸ“ Unique locations found:', [...locationSet]);
                
                // Build location dropdown HTML
                const locationSelect = document.getElementById('filterLocation');
                if (!locationSelect) {
                    console.error('âŒ filterLocation element not found');
                    return;
                }
                const currentLocValue = locationSelect.value;
                
                let locationHtml = '<option value="">All Locations</option>';
                
                // First add locations from YOUR DATA (most relevant)
                const firmLocations = [...locationSet].sort();
                if (firmLocations.length > 0) {
                    locationHtml += '<optgroup label="ðŸ“Š Your Data">';
                    firmLocations.forEach(loc => {
                        locationHtml += `<option value="${loc}">${loc}</option>`;
                    });
                    locationHtml += '</optgroup>';
                }
                
                // Priority markets
                locationHtml += '<optgroup label="â­ Priority Markets">';
                priorityCountries.forEach(loc => {
                    locationHtml += `<option value="${loc}">â­ ${loc}</option>`;
                });
                locationHtml += '</optgroup>';
                
                // All countries (excluding priority)
                locationHtml += '<optgroup label="ðŸŒ All Countries">';
                const otherCountries = allCountries.filter(c => !priorityCountries.includes(c)).sort();
                otherCountries.forEach(loc => {
                    locationHtml += `<option value="${loc}">${loc}</option>`;
                });
                locationHtml += '</optgroup>';
                
                locationSelect.innerHTML = locationHtml;
                console.log('âœ… Location dropdown populated');
                
                // Restore previous selection
                if (currentLocValue && locationSelect.querySelector(`option[value="${currentLocValue}"]`)) {
                    locationSelect.value = currentLocValue;
                }
                
                // Populate strategy dropdown
                const strategySelect = document.getElementById('filterStrategy');
                if (!strategySelect) {
                    console.error('âŒ filterStrategy element not found');
                    return;
                }
                
                const currentStratValue = strategySelect.value;
                
                let strategyHtml = '<option value="">All Strategies</option>';
                const strategyCategories = [
                    'Quantitative', 'Multi-Strategy', 'Event-Driven', 'Long/Short Equity',
                    'Credit & Fixed Income', 'Macro', 'Asset Management', 'Private Equity', 'Alternatives'
                ];
                strategyCategories.forEach(cat => {
                    strategyHtml += `<option value="${cat}">${cat}</option>`;
                });
                strategySelect.innerHTML = strategyHtml;
                console.log('âœ… Strategy dropdown populated');
                
                if (currentStratValue) {
                    strategySelect.value = currentStratValue;
                }
                
                console.log(`âœ… Filters populated: ${firmLocations.length} locations from data`);
                
            } catch (error) {
                console.error('âŒ Error in populateFilters:', error);
            }
        }
        
        // Update filter dropdown labels with counts
        function updateFilterCounts() {
            const search = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const selectedLocation = document.getElementById('filterLocation')?.value || '';
            const selectedStrategy = document.getElementById('filterStrategy')?.value || '';
            const selectedPriority = document.getElementById('filterPriority')?.value || '';
            
            // Count firms per location (considering other filters)
            const locationCounts = {};
            const strategyCounts = {};
            const priorityCounts = {};
            
            // Strategy categories for matching
            const strategyCategories = {
                'Quantitative': ['quant', 'systematic', 'algorithmic', 'ai', 'machine learning'],
                'Multi-Strategy': ['multi-strategy', 'multi strategy', 'diversified'],
                'Event-Driven': ['event', 'activist', 'merger', 'm&a', 'restructuring'],
                'Long/Short Equity': ['long/short', 'long short', 'equity l/s'],
                'Credit & Fixed Income': ['credit', 'fixed income', 'bond', 'debt', 'distressed'],
                'Macro': ['macro', 'global macro'],
                'Asset Management': ['asset management', 'wealth management', 'mutual fund', 'etf'],
                'Private Equity': ['private equity', 'pe ', 'buyout'],
                'Alternatives': ['alternative', 'hedge fund', 'real estate', 'real assets']
            };
            
            firms.forEach(f => {
                // Use RAW location for counting to match dropdown values
                const firmLocation = (f.location || 'Unknown').trim();
                const firmFocus = (f.focus || '').toLowerCase();
                
                // Check if firm matches current search
                const matchSearch = !search || 
                    f.name.toLowerCase().includes(search) ||
                    (f.contactName && f.contactName.toLowerCase().includes(search)) ||
                    firmLocation.toLowerCase().includes(search);
                
                // Check strategy match
                const matchStrategy = !selectedStrategy || Object.entries(strategyCategories).some(([cat, keywords]) => {
                    if (cat !== selectedStrategy) return false;
                    return keywords.some(kw => firmFocus.includes(kw));
                });
                
                // Check priority match
                const matchPriority = !selectedPriority || f.priority === selectedPriority;
                
                // Check location match - use flexible matching
                let matchLocation = !selectedLocation;
                if (selectedLocation) {
                    const selectedLower = selectedLocation.toLowerCase();
                    const firmLocLower = firmLocation.toLowerCase();
                    matchLocation = firmLocLower.includes(selectedLower) || selectedLower.includes(firmLocLower) || firmLocLower === selectedLower;
                }
                
                // Count for location filter (exclude location from matching)
                if (matchSearch && matchStrategy && matchPriority) {
                    locationCounts[firmLocation] = (locationCounts[firmLocation] || 0) + 1;
                }
                
                // Count for strategy filter (exclude strategy from matching)
                if (matchSearch && matchLocation && matchPriority) {
                    Object.entries(strategyCategories).forEach(([cat, keywords]) => {
                        if (keywords.some(kw => firmFocus.includes(kw))) {
                            strategyCounts[cat] = (strategyCounts[cat] || 0) + 1;
                        }
                    });
                }
                
                // Count for priority filter (exclude priority from matching)
                if (matchSearch && matchLocation && matchStrategy) {
                    const priority = f.priority || 'medium';
                    priorityCounts[priority] = (priorityCounts[priority] || 0) + 1;
                }
            });
            
            // Update location select options with counts
            const locSelect = document.getElementById('filterLocation');
            if (locSelect) {
                Array.from(locSelect.options).forEach((opt, idx) => {
                    if (idx > 0) {
                        const baseVal = opt.value;
                        const count = locationCounts[baseVal] || 0;
                        opt.textContent = `${baseVal} (${count})`;
                    } else {
                        const total = Object.values(locationCounts).reduce((a, b) => a + b, 0);
                        opt.textContent = `All Locations (${total})`;
                    }
                });
            }
            
            // Update strategy select options with counts
            const stratSelect = document.getElementById('filterStrategy');
            if (stratSelect) {
                Array.from(stratSelect.options).forEach((opt, idx) => {
                    if (idx > 0) {
                        const baseVal = opt.value;
                        const count = strategyCounts[baseVal] || 0;
                        opt.textContent = `${baseVal} (${count})`;
                    } else {
                        const total = firms.filter(f => {
                            const normalized = getNormalizedFirmData(f);
                            const matchSearch = !search || 
                                f.name.toLowerCase().includes(search) ||
                                (f.contactName && f.contactName.toLowerCase().includes(search));
                            const matchLocation = !selectedLocation || normalized.location === selectedLocation;
                            const matchPriority = !selectedPriority || f.priority === selectedPriority;
                            return matchSearch && matchLocation && matchPriority;
                        }).length;
                        opt.textContent = `All Strategies (${total})`;
                    }
                });
            }
            
            // Update priority select options with counts
            const priorSelect = document.getElementById('filterPriority');
            if (priorSelect) {
                Array.from(priorSelect.options).forEach((opt, idx) => {
                    if (idx > 0) {
                        const baseVal = opt.value;
                        const count = priorityCounts[baseVal] || 0;
                        const label = baseVal.charAt(0).toUpperCase() + baseVal.slice(1);
                        opt.textContent = `${label} Priority (${count})`;
                    } else {
                        const total = Object.values(priorityCounts).reduce((a, b) => a + b, 0);
                        opt.textContent = `All Priorities (${total})`;
                    }
                });
            }
        }

        function filterFirms() {
            const deletedCount = firms.filter(f => f.isDeleted).length;
            console.log('ðŸ” filterFirms called, total firms:', firms.length, '| deleted:', deletedCount, '| active:', firms.length - deletedCount);
            
            const search = document.getElementById('searchInput').value.toLowerCase();
            const selectedLocation = document.getElementById('filterLocation').value;
            const selectedStrategy = document.getElementById('filterStrategy').value;
            const selectedPriority = document.getElementById('filterPriority').value;
            const selectedDateFilter = document.getElementById('filterDateAdded')?.value || '';
            const selectedAssignedTo = document.getElementById('filterAssignedTo')?.value || '';
            
            console.log('ðŸ” Filters:', { search, selectedLocation, selectedStrategy, selectedPriority, selectedDateFilter, selectedAssignedTo });
            
            // Show/hide custom date picker
            const customDatePicker = document.getElementById('customDatePicker');
            if (selectedDateFilter === 'custom') {
                customDatePicker.style.display = 'block';
            } else {
                customDatePicker.style.display = 'none';
            }
            
            // Calculate date range based on filter
            let dateFrom = null, dateTo = null;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (selectedDateFilter) {
                case 'today':
                    dateFrom = today;
                    dateTo = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'yesterday':
                    dateFrom = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    dateTo = today;
                    break;
                case 'week':
                    dateFrom = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    dateTo = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    dateFrom = new Date(today.getFullYear(), today.getMonth(), 1);
                    dateTo = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'custom':
                    const fromInput = document.getElementById('dateFrom')?.value;
                    const toInput = document.getElementById('dateTo')?.value;
                    if (fromInput) dateFrom = new Date(fromInput);
                    if (toInput) dateTo = new Date(new Date(toInput).getTime() + 24 * 60 * 60 * 1000);
                    break;
            }
            
            // Strategy categories for matching
            const strategyCategories = {
                'Quantitative': ['quant', 'systematic', 'algorithmic', 'ai', 'machine learning'],
                'Multi-Strategy': ['multi-strategy', 'multi strategy', 'diversified'],
                'Event-Driven': ['event', 'activist', 'merger', 'm&a', 'restructuring'],
                'Long/Short Equity': ['long/short', 'long short', 'equity l/s'],
                'Credit & Fixed Income': ['credit', 'fixed income', 'bond', 'debt', 'distressed'],
                'Macro': ['macro', 'global macro'],
                'Asset Management': ['asset management', 'wealth management', 'mutual fund', 'etf'],
                'Private Equity': ['private equity', 'pe ', 'buyout'],
                'Alternatives': ['alternative', 'hedge fund', 'real estate', 'real assets']
            };
            
            const filtered = firms.filter(f => {
                // FIRST: Skip deleted firms
                if (f.isDeleted) return false;
                
                const normalized = getNormalizedFirmData(f);
                const firmLocationRaw = (f.location || '').toUpperCase();
                const firmLocationNormalized = (normalized.location || '').toUpperCase();
                const firmType = (normalized.firmType || '').toLowerCase();
                const firmFocus = (f.focus || '').toLowerCase();
                const combinedFocus = firmType + ' ' + firmFocus;
                
                // Search match
                const matchSearch = !search || 
                    f.name.toLowerCase().includes(search) ||
                    firmLocationRaw.toLowerCase().includes(search) ||
                    firmLocationNormalized.toLowerCase().includes(search) ||
                    (f.contactName && f.contactName.toLowerCase().includes(search)) ||
                    firmType.includes(search) ||
                    firmFocus.includes(search);
                
                // Location match - flexible matching for cities and countries
                let matchLocation = !selectedLocation;
                if (selectedLocation) {
                    const selectedLocLower = selectedLocation.toLowerCase();
                    const firmLocLower = (f.location || '').toLowerCase();
                    const normalizedLocLower = (normalized.location || '').toLowerCase();
                    
                    // Map country names to common patterns
                    const countryPatterns = {
                        'united states': ['usa', 'us', 'united states', 'u.s.', 'america', 'new york', 'san francisco', 'boston', 'chicago', 'los angeles', 'miami', 'greenwich', 'stamford', 'west palm'],
                        'united kingdom': ['uk', 'united kingdom', 'u.k.', 'london', 'england', 'britain', 'edinburgh', 'manchester'],
                        'hong kong': ['hong kong', 'hk'],
                        'singapore': ['singapore', 'sg'],
                        'switzerland': ['switzerland', 'swiss', 'zurich', 'geneva', 'zug'],
                        'germany': ['germany', 'frankfurt', 'munich', 'berlin'],
                        'france': ['france', 'paris', 'french'],
                        'japan': ['japan', 'tokyo', 'japanese'],
                        'australia': ['australia', 'sydney', 'melbourne', 'australian'],
                        'canada': ['canada', 'toronto', 'vancouver', 'montreal', 'canadian'],
                        'netherlands': ['netherlands', 'amsterdam', 'dutch'],
                        'ireland': ['ireland', 'dublin', 'irish'],
                        'uae': ['uae', 'dubai', 'abu dhabi', 'united arab emirates'],
                        'india': ['india', 'mumbai', 'bangalore', 'bengaluru', 'delhi', 'indian']
                    };
                    
                    // Direct match
                    matchLocation = firmLocLower.includes(selectedLocLower) || 
                                    normalizedLocLower.includes(selectedLocLower) ||
                                    selectedLocLower.includes(firmLocLower);
                    
                    // Country pattern match
                    if (!matchLocation && countryPatterns[selectedLocLower]) {
                        matchLocation = countryPatterns[selectedLocLower].some(pattern => 
                            firmLocLower.includes(pattern) || normalizedLocLower.includes(pattern)
                        );
                    }
                }
                
                // Strategy match
                let matchStrategy = !selectedStrategy;
                if (selectedStrategy && strategyCategories[selectedStrategy]) {
                    matchStrategy = strategyCategories[selectedStrategy].some(kw => 
                        combinedFocus.includes(kw)
                    );
                }
                
                // Priority match - handle undefined priority (default to medium)
                const firmPriority = f.priority || 'medium';
                const matchPriority = !selectedPriority || firmPriority === selectedPriority;
                
                // Date added match
                let matchDate = true;
                if (dateFrom || dateTo) {
                    // Check both dateAdded and addedDate for compatibility
                    const firmDate = f.addedDate ? new Date(f.addedDate) : 
                                     f.dateAdded ? new Date(f.dateAdded) :
                                     f.discoveryData?.discoveredDate ? new Date(f.discoveryData.discoveredDate) : null;
                    
                    if (firmDate && !isNaN(firmDate.getTime())) {
                        if (dateFrom && firmDate < dateFrom) matchDate = false;
                        if (dateTo && firmDate > dateTo) matchDate = false;
                    } else {
                        // If no valid date recorded and we're filtering by date, exclude
                        matchDate = false;
                    }
                }
                
                // Assigned user match
                let matchAssigned = true;
                if (selectedAssignedTo) {
                    const firmAssignee = (f.assignedTo || '').toLowerCase();
                    const myUsername = (currentSession?.user?.username || currentUser || '').toLowerCase();
                    
                    if (selectedAssignedTo === 'mine') {
                        // Show only firms assigned to current user
                        matchAssigned = firmAssignee === myUsername;
                    } else if (selectedAssignedTo === 'unassigned') {
                        // Show only unassigned firms
                        matchAssigned = !f.assignedTo;
                    } else {
                        // Show firms assigned to specific user
                        matchAssigned = firmAssignee === selectedAssignedTo.toLowerCase();
                    }
                }
                
                return matchSearch && matchLocation && matchStrategy && matchPriority && matchDate && matchAssigned;
            });
            
            console.log('ðŸ” Filtered results:', filtered.length, 'out of', firms.length);
            
            // Render filtered results with new status columns
            const columns = {
                'Not Contacted': [],
                'Contacted': [],
                'Trial Ongoing': [],
                'Client': [],
                'Closed': [],
                'Not a Good Fit': []
            };
            
            filtered.forEach(f => {
                const status = f.status || 'Not Contacted';
                if (columns[status]) {
                    columns[status].push(f);
                }
            });
            
            // Update column counts
            document.getElementById('countNotContacted').textContent = columns['Not Contacted'].length;
            document.getElementById('countContacted').textContent = columns['Contacted'].length;
            document.getElementById('countTrialOngoing').textContent = columns['Trial Ongoing'].length;
            document.getElementById('countClient').textContent = columns['Client'].length;
            document.getElementById('countClosed').textContent = columns['Closed'].length;
            document.getElementById('countNotGoodFit').textContent = columns['Not a Good Fit'].length;
            
            // Render columns with pagination (left to right order)
            renderColumnPaginated('columnNotContacted', columns['Not Contacted'], 'Not Contacted');
            renderColumnPaginated('columnContacted', columns['Contacted'], 'Contacted');
            renderColumnPaginated('columnTrialOngoing', columns['Trial Ongoing'], 'Trial Ongoing');
            renderColumnPaginated('columnClient', columns['Client'], 'Client');
            renderColumnPaginated('columnClosed', columns['Closed'], 'Closed');
            renderColumnPaginated('columnNotGoodFit', columns['Not a Good Fit'], 'Not a Good Fit');
            
            // Update stats for filtered view
            const filteredHighPriority = filtered.filter(f => f.priority === 'high').length;
            const filteredClients = filtered.filter(f => f.status === 'Client').length;
            const filteredTrialOngoing = filtered.filter(f => f.status === 'Trial Ongoing').length;
            document.getElementById('statTotal').textContent = filtered.length;
            document.getElementById('statNotContacted').textContent = columns['Not Contacted'].length;
            document.getElementById('statTrialOngoing').textContent = filteredTrialOngoing;
            document.getElementById('statHighPriority').textContent = filteredHighPriority;
            document.getElementById('statClients').textContent = filteredClients;
            
            // Update filter counts
            updateFilterCounts();
        }
        
        // Helper function to apply custom date filter
        function applyCustomDateFilter() {
            filterFirms();
        }
        
        // Helper function to clear date filter
        function clearDateFilter() {
            document.getElementById('filterDateAdded').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('customDatePicker').style.display = 'none';
            filterFirms();
        }

        function filterByStatus(status) {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterStrategy').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterDateAdded').value = '';
            document.getElementById('customDatePicker').style.display = 'none';
            
            if (status === 'all') {
                renderDashboard();
            }
            updateFilterCounts();
        }

        // Check for alerts
        function checkForAlerts() {
            const staleResearch = firms.filter(f => {
                if (!f.researchDate) return false;
                const days = Math.floor((new Date() - new Date(f.researchDate)) / (1000 * 60 * 60 * 24));
                return days >= 90;
            });
            
            if (staleResearch.length > 0) {
                addNotification(
                    'Stale Research Alert',
                    `${staleResearch.length} firms have research older than 90 days`,
                    'warning'
                );
            }
        }

        // Modal controls
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Unlock firm when closing firm details modal
            if (modalId === 'firmDetailsModal' && currentlyOpenFirmId) {
                unlockFirm(currentlyOpenFirmId);
                currentlyOpenFirmId = null;
                renderDashboard(); // Refresh to update lock status
            }
        }

        // API Configuration Functions
        function openSettings() {
            // Load current values
            document.getElementById('claudeApiKey').value = API_KEYS.claude;
            document.getElementById('openaiApiKey').value = API_KEYS.openai;
            document.getElementById('deepseekApiKey').value = API_KEYS.deepseek;
            document.getElementById('geminiApiKey').value = API_KEYS.gemini;
            document.getElementById('budgetLimit').value = BUDGET_LIMIT;
            
            // Load search API keys
            document.getElementById('tavilyApiKey').value = SEARCH_API.tavilyKey || '';
            document.getElementById('serperApiKey').value = SEARCH_API.serperKey || '';
            
            // Load enrichment API keys
            document.getElementById('hunterApiKey').value = SEARCH_API.hunterKey || '';
            document.getElementById('apolloApiKey').value = SEARCH_API.apolloKey || '';
            
            // Hide test result
            document.getElementById('apiTestResult').style.display = 'none';
            
            document.getElementById('settingsModal').classList.add('active');
        }

        async function saveApiConfig() {
            API_KEYS.claude = document.getElementById('claudeApiKey').value.trim();
            API_KEYS.openai = document.getElementById('openaiApiKey').value.trim();
            API_KEYS.deepseek = document.getElementById('deepseekApiKey').value.trim();
            API_KEYS.gemini = document.getElementById('geminiApiKey').value.trim();
            BUDGET_LIMIT = parseFloat(document.getElementById('budgetLimit').value) || 200;
            
            // Search API keys
            SEARCH_API.tavilyKey = document.getElementById('tavilyApiKey').value.trim();
            SEARCH_API.serperKey = document.getElementById('serperApiKey').value.trim();
            SEARCH_API.hunterKey = document.getElementById('hunterApiKey').value.trim();
            SEARCH_API.apolloKey = document.getElementById('apolloApiKey').value.trim();
            
            // Save to storage
            try {
                if (window.storage) {
                    await window.storage.set('api_claude', API_KEYS.claude, false);
                    await window.storage.set('api_openai', API_KEYS.openai, false);
                    await window.storage.set('api_deepseek', API_KEYS.deepseek, false);
                    await window.storage.set('api_gemini', API_KEYS.gemini, false);
                    await window.storage.set('budget_limit', BUDGET_LIMIT.toString(), false);
                    await window.storage.set('api_tavily', SEARCH_API.tavilyKey, false);
                    await window.storage.set('api_serper', SEARCH_API.serperKey, false);
                    await window.storage.set('api_hunter', SEARCH_API.hunterKey, false);
                    await window.storage.set('api_apollo', SEARCH_API.apolloKey, false);
                } else {
                    localStorage.setItem('api_claude', API_KEYS.claude);
                    localStorage.setItem('api_openai', API_KEYS.openai);
                    localStorage.setItem('api_deepseek', API_KEYS.deepseek);
                    localStorage.setItem('api_gemini', API_KEYS.gemini);
                    localStorage.setItem('budget_limit', BUDGET_LIMIT.toString());
                    localStorage.setItem('api_tavily', SEARCH_API.tavilyKey);
                    localStorage.setItem('api_serper', SEARCH_API.serperKey);
                    localStorage.setItem('api_hunter', SEARCH_API.hunterKey);
                    localStorage.setItem('api_apollo', SEARCH_API.apolloKey);
                }
                
                updateBudgetDisplay();
                
                // Count configured APIs
                const llmCount = [API_KEYS.claude, API_KEYS.openai, API_KEYS.deepseek, API_KEYS.gemini].filter(k => k).length;
                const searchCount = [SEARCH_API.tavilyKey, SEARCH_API.serperKey].filter(k => k).length;
                const enrichCount = [SEARCH_API.hunterKey, SEARCH_API.apolloKey].filter(k => k).length;
                
                addNotification(
                    'Configuration Saved',
                    `${llmCount} LLM${llmCount !== 1 ? 's' : ''}, ${searchCount} search API${searchCount !== 1 ? 's' : ''}, ${enrichCount} enrichment API${enrichCount !== 1 ? 's' : ''} configured!`,
                    'success'
                );
                
                // Show success in modal
                const resultDiv = document.getElementById('apiTestResult');
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(6, 214, 160, 0.1)';
                resultDiv.style.border = '1px solid var(--green-flag)';
                resultDiv.style.color = 'var(--green-flag)';
                resultDiv.innerHTML = `
                    âœ“ Configuration saved!<br>
                    <span style="font-size: 0.85rem;">
                        ðŸ¤– ${llmCount} LLM${llmCount !== 1 ? 's' : ''} â€¢ 
                        ðŸ” ${searchCount} search API${searchCount !== 1 ? 's' : ''} â€¢ 
                        ðŸ‘¤ ${enrichCount} enrichment API${enrichCount !== 1 ? 's' : ''}
                    </span>
                `;
                
                setTimeout(() => {
                    closeModal('settingsModal');
                }, 2000);
                
            } catch (error) {
                alert('Error saving configuration: ' + error.message);
            }
        }

        async function testApiConnection() {
            if (!API_KEYS.claude) {
                alert('Please enter your Claude API key first');
                return;
            }
            
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'rgba(69, 123, 157, 0.1)';
            resultDiv.style.border = '1px solid var(--blue-info)';
            resultDiv.style.color = 'var(--silver)';
            resultDiv.innerHTML = '<div class="loading" style="margin-right: 0.5rem;"></div> Testing Claude API connection...';
            
            try {
                const response = await fetch("http://localhost:8001", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": API_KEYS.claude,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 10,
                        messages: [{ role: "user", content: "test" }]
                    })
                });
                
                if (response.ok) {
                    resultDiv.style.background = 'rgba(6, 214, 160, 0.1)';
                    resultDiv.style.border = '1px solid var(--green-flag)';
                    resultDiv.style.color = 'var(--green-flag)';
                    resultDiv.textContent = 'âœ“ Claude API connection successful! Ready for production research.';
                } else {
                    const error = await response.json();
                    throw new Error(error.error?.message || response.statusText);
                }
            } catch (error) {
                resultDiv.style.background = 'rgba(230, 57, 70, 0.1)';
                resultDiv.style.border = '1px solid var(--red-flag)';
                resultDiv.style.color = 'var(--red-flag)';
                resultDiv.textContent = 'âœ— Connection failed: ' + error.message;
            }
        }

        async function loadApiKeys() {
            try {
                if (window.storage) {
                    const claudeKey = await window.storage.get('api_claude', false);
                    const openaiKey = await window.storage.get('api_openai', false);
                    const deepseekKey = await window.storage.get('api_deepseek', false);
                    const geminiKey = await window.storage.get('api_gemini', false);
                    const budgetLimit = await window.storage.get('budget_limit', false);
                    const tavilyKey = await window.storage.get('api_tavily', false);
                    const serperKey = await window.storage.get('api_serper', false);
                    const hunterKey = await window.storage.get('api_hunter', false);
                    const apolloKey = await window.storage.get('api_apollo', false);
                    
                    if (claudeKey) API_KEYS.claude = claudeKey.value;
                    if (openaiKey) API_KEYS.openai = openaiKey.value;
                    if (deepseekKey) API_KEYS.deepseek = deepseekKey.value;
                    if (geminiKey) API_KEYS.gemini = geminiKey.value;
                    if (budgetLimit) BUDGET_LIMIT = parseFloat(budgetLimit.value) || 200;
                    if (tavilyKey) SEARCH_API.tavilyKey = tavilyKey.value;
                    if (serperKey) SEARCH_API.serperKey = serperKey.value;
                    if (hunterKey) SEARCH_API.hunterKey = hunterKey.value;
                    if (apolloKey) SEARCH_API.apolloKey = apolloKey.value;
                } else {
                    API_KEYS.claude = localStorage.getItem('api_claude') || '';
                    API_KEYS.openai = localStorage.getItem('api_openai') || '';
                    API_KEYS.deepseek = localStorage.getItem('api_deepseek') || '';
                    API_KEYS.gemini = localStorage.getItem('api_gemini') || '';
                    const savedLimit = localStorage.getItem('budget_limit');
                    if (savedLimit) BUDGET_LIMIT = parseFloat(savedLimit) || 200;
                    SEARCH_API.tavilyKey = localStorage.getItem('api_tavily') || '';
                    SEARCH_API.serperKey = localStorage.getItem('api_serper') || '';
                    SEARCH_API.hunterKey = localStorage.getItem('api_hunter') || '';
                    SEARCH_API.apolloKey = localStorage.getItem('api_apollo') || '';
                }
            } catch (e) {
                console.error('Error loading API keys:', e);
            }
        }

        // Initialize
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // ============================================
        // ADMIN UTILITY FUNCTIONS
        // ============================================
        
        async function backfillFirmDates() {
            const resultDiv = document.getElementById('adminUtilityResult');
            
            if (!confirm('This will add addedDate to all firms without one. Continue?')) {
                return;
            }
            
            let count = 0;
            const defaultDate = new Date('2025-01-01T00:00:00.000Z');
            
            firms.forEach(firm => {
                if (!firm.addedDate && !firm.dateAdded) {
                    firm.addedDate = defaultDate.toISOString();
                    firm.source = firm.source || 'Legacy Import';
                    firm.addedBy = firm.addedBy || 'system';
                    count++;
                }
            });
            
            if (count > 0) {
                await saveToStorage();
                resultDiv.innerHTML = `<span style="color: var(--green-flag);">âœ… Backfilled dates for ${count} firms and saved to database.</span>`;
                renderDashboard();
            } else {
                resultDiv.innerHTML = `<span style="color: var(--silver);">â„¹ï¸ All firms already have dates. No changes made.</span>`;
            }
        }
        
        async function normalizeFirmData() {
            const resultDiv = document.getElementById('adminUtilityResult');
            
            if (!confirm('This will normalize priority values (lowercase), fix empty locations, etc. Continue?')) {
                return;
            }
            
            let changes = {
                priority: 0,
                location: 0,
                source: 0
            };
            
            firms.forEach(firm => {
                // Normalize priority to lowercase
                if (firm.priority && firm.priority !== firm.priority.toLowerCase()) {
                    firm.priority = firm.priority.toLowerCase();
                    changes.priority++;
                }
                
                // Fix empty/unknown locations
                if (!firm.location || firm.location === 'Unknown' || firm.location.trim() === '') {
                    firm.location = 'Unknown';
                    changes.location++;
                }
                
                // Ensure source exists
                if (!firm.source) {
                    firm.source = 'Legacy Import';
                    changes.source++;
                }
            });
            
            const totalChanges = changes.priority + changes.location + changes.source;
            
            if (totalChanges > 0) {
                await saveToStorage();
                resultDiv.innerHTML = `<span style="color: var(--green-flag);">âœ… Normalized ${totalChanges} values (${changes.priority} priorities, ${changes.location} locations, ${changes.source} sources)</span>`;
                renderDashboard();
                populateFilters();
            } else {
                resultDiv.innerHTML = `<span style="color: var(--silver);">â„¹ï¸ All data already normalized. No changes made.</span>`;
            }
        }
        
        function exportFirmsToJson() {
            const dataStr = JSON.stringify(firms, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `2iq-firms-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            const resultDiv = document.getElementById('adminUtilityResult');
            resultDiv.innerHTML = `<span style="color: var(--green-flag);">âœ… Exported ${firms.length} firms to JSON</span>`;
        }
    </script>

    <!-- SheetJS Library for Excel Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</body>
</html>
